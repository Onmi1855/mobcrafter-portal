<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MobCrafter Portal | Submit</title>
  <meta name="description" content="MobCrafter用ユニットJSONの投稿ページ（MVP）。" />
  <style>
    :root{
      --bg:#f6f8fb; --card:#fff; --text:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --brand:#2563eb; --danger:#dc2626; --shadow:0 10px 25px rgba(15,23,42,.08); --r:16px;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, sans-serif; background:var(--bg); color:var(--text); }
    header{ padding:22px 16px 10px; text-align:center; }
    header a{ color:inherit; text-decoration:none; }
    header h1{ margin:0; font-size:18px; letter-spacing:.4px; }
    header p{ margin:6px 0 0; font-size:12px; color:var(--muted); }
    main{ max-width:980px; margin:0 auto; padding:10px 16px 40px; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:var(--r); box-shadow:var(--shadow); padding:14px; }
    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .auth{ font-size:12px; color:var(--muted); display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    code{ background:rgba(148,163,184,.15); border:1px solid rgba(148,163,184,.25); padding:2px 6px; border-radius:999px; color:#0f172a; }
    .btn{ border:1px solid var(--line); border-radius:12px; padding:10px 12px; background:#fff; cursor:pointer; font-size:14px; text-decoration:none; color:inherit; }
    .btn.primary{ background:rgba(37,99,235,.92); color:#fff; border-color:transparent; }
    .btn.danger{ background:rgba(220,38,38,.92); color:#fff; border-color:transparent; }
    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:12px; }
    @media (max-width: 860px){ .grid{ grid-template-columns:1fr; } }
    label{ display:block; font-size:12px; color:var(--muted); margin:10px 0 6px; }
    input[type="text"], textarea{
      width:100%; border:1px solid var(--line); border-radius:12px; padding:10px 12px;
      font-size:14px; outline:none; background:#fff;
    }
    textarea{ min-height:200px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .hint{ font-size:12px; color:var(--muted); margin-top:6px; }
    .msg{ margin-top:12px; padding:10px 12px; border-radius:12px; white-space:pre-wrap; }
    .msg.ok{ background:#ecfdf5; border:1px solid #a7f3d0; color:#065f46; }
    .msg.err{ background:#fff1f2; border:1px solid #fecdd3; color:#9f1239; }
    .msg.muted{ background:#f8fafc; border:1px solid #e2e8f0; color:#334155; }
  </style>
</head>
<body>
<header>
  <a href="/"><h1>MobCrafter Portal</h1></a>
  <p>投稿（MVP）</p>
</header>

<main>
  <section class="card">
    <div class="row">
      <div class="auth">
        <span>Login:</span> <code id="st">checking...</code>
        <span id="emw" style="display:none;">Email: <code id="em"></code></span>
        <span id="adw" style="display:none;">Admin: <code id="ad"></code></span>
      </div>
      <div class="row" style="gap:8px;">
        <a class="btn" href="/">一覧へ戻る</a>
        <a class="btn" id="loginBtn" href="/api/whoami" style="display:none;">ログインを開始</a>
      </div>
    </div>

    <div class="grid">
      <div>
        <label>タイトル（任意 / 80文字まで）</label>
        <input id="title" type="text" placeholder="例：Sephiroth Sword" maxlength="80" />

        <label>説明（任意 / 2000文字まで）</label>
        <input id="desc" type="text" placeholder="例：MobCrafter用のボスユニットです" maxlength="2000" />

        <label>タグ（任意）</label>
        <input id="tags" type="text" placeholder="例：ff7 boss sword" />
        <div class="hint">スペース区切り推奨（カンマも可）。</div>

        <label>作者名（任意）</label>
        <input id="author" type="text" placeholder="例：nao" maxlength="60" />

        <label>mod_version / mc_version（任意）</label>
        <div class="grid" style="grid-template-columns:1fr 1fr;">
          <input id="modv" type="text" placeholder="Forge" maxlength="40" />
          <input id="mcv" type="text" placeholder="1.20.1" maxlength="40" />
        </div>

        <div class="hint">※ author_email は whoami の email を自動で使います（未ログイン時は null）。</div>
      </div>

      <div>
        <label>ユニットJSON（必須）</label>
        <textarea id="json" placeholder='{"blocks":[{"dx":0,"dy":1,"dz":0,"blockId":"mob_crafter:boneblock"}]}'></textarea>
        <div class="hint">
          JSONは「ルートが blocks を持つ」形式を想定。あなたのWorker側が unitId を自動で整形します。
        </div>

        <div class="row" style="margin-top:12px; justify-content:flex-start;">
          <button class="btn primary" id="submitBtn" type="button">投稿する（/api/submit）</button>
          <button class="btn" id="fillBtn" type="button">サンプル挿入</button>
          <button class="btn danger" id="clearBtn" type="button">クリア</button>
        </div>

        <div id="msg" class="msg muted" style="display:none;"></div>
      </div>
    </div>
  </section>
</main>

<script>
(() => {
  const API_WHOAMI = "/api/whoami";
  const API_SUBMIT = "/api/submit";

  const st = document.getElementById("st");
  const emw = document.getElementById("emw");
  const em = document.getElementById("em");
  const adw = document.getElementById("adw");
  const ad = document.getElementById("ad");
  const loginBtn = document.getElementById("loginBtn");

  const title = document.getElementById("title");
  const desc = document.getElementById("desc");
  const tags = document.getElementById("tags");
  const author = document.getElementById("author");
  const modv = document.getElementById("modv");
  const mcv = document.getElementById("mcv");
  const jsonTa = document.getElementById("json");

  const submitBtn = document.getElementById("submitBtn");
  const fillBtn = document.getElementById("fillBtn");
  const clearBtn = document.getElementById("clearBtn");

  const msg = document.getElementById("msg");

  function showMsg(kind, text){
    msg.style.display = "block";
    msg.className = "msg " + kind;
    msg.textContent = text;
  }

  function safeJsonParse(text){
    try { return JSON.parse(text); } catch { return null; }
  }

  async function loadWhoami(){
    try{
      st.textContent = "checking...";
      emw.style.display = "none";
      adw.style.display = "none";
      loginBtn.style.display = "none";

      const r = await fetch(API_WHOAMI, { cache:"no-store", credentials:"include" });
      const t = await r.text();
      let data = null;
      try { data = JSON.parse(t); } catch { data = null; }

      if(!r.ok || !data){
        st.textContent = "unknown";
        loginBtn.style.display = "inline-flex";
        loginBtn.href = API_WHOAMI;
        return { email:null, is_admin:false };
      }

      const email = data.email || null;
      const isAdmin = Boolean(data.is_admin);

      if(!email){
        st.textContent = "logged out";
        loginBtn.style.display = "inline-flex";
        loginBtn.href = API_WHOAMI; // Accessが掛かっていればここでログイン開始
        return { email:null, is_admin:false };
      }

      st.textContent = "logged in";
      emw.style.display = "inline";
      em.textContent = email;
      adw.style.display = "inline";
      ad.textContent = isAdmin ? "true" : "false";
      return { email, is_admin:isAdmin };
    }catch{
      st.textContent = "unknown";
      loginBtn.style.display = "inline-flex";
      loginBtn.href = API_WHOAMI;
      return { email:null, is_admin:false };
    }
  }

  async function submit(){
    submitBtn.disabled = true;
    try{
      const who = await loadWhoami(); // 最新状態で

      const raw = (jsonTa.value || "").trim();
      if(!raw){
        showMsg("err", "JSONが空です。");
        return;
      }
      const parsed = safeJsonParse(raw);
      if(!parsed || typeof parsed !== "object"){
        showMsg("err", "JSONの形式が不正です（パースできません）。");
        return;
      }

      const body = {
        title: (title.value || "").trim(),
        description: (desc.value || "").trim(),
        tags: (tags.value || "").trim(),
        author_name: (author.value || "").trim() || "unknown",
        author_email: who.email, // null可
        mod_version: (modv.value || "").trim(),
        mc_version: (mcv.value || "").trim(),
        json: parsed
      };

      showMsg("muted", "投稿中...");

      const r = await fetch(API_SUBMIT, {
        method: "POST",
        credentials: "include",
        headers: { "Content-Type":"application/json", "Accept":"application/json" },
        body: JSON.stringify(body)
      });

      const text = await r.text();
      let data = null;
      try { data = JSON.parse(text); } catch { data = { raw:text }; }

      if(!r.ok){
        showMsg("err", "投稿に失敗しました。\n\nHTTP " + r.status + "\n" + JSON.stringify(data, null, 2));
        return;
      }

      showMsg("ok",
        "投稿しました！（pending）\n\n" +
        JSON.stringify(data, null, 2) +
        "\n\n管理画面で承認してください。"
      );

      // 入力は残す派ならコメントアウト
      // jsonTa.value = "";
    }catch(e){
      showMsg("err", "投稿に失敗しました。\n" + String(e?.message || e));
    }finally{
      submitBtn.disabled = false;
    }
  }

  fillBtn.onclick = () => {
    const sample = {
      blocks: [
        { dx:0, dy:1, dz:0, blockId:"mob_crafter:boneblock" },
        { dx:1, dy:1, dz:0, blockId:"minecraft:stone" },
        { dx:0, dy:2, dz:0, blockId:"minecraft:stone" }
      ]
    };
    jsonTa.value = JSON.stringify(sample, null, 2);
  };

  clearBtn.onclick = () => {
    if(!confirm("入力をクリアします。よろしいですか？")) return;
    title.value = ""; desc.value = ""; tags.value = ""; author.value = "";
    modv.value = ""; mcv.value = ""; jsonTa.value = "";
    msg.style.display = "none";
  };

  submitBtn.onclick = submit;

  // 初回表示
  loadWhoami();
})();
</script>
</body>
</html>
