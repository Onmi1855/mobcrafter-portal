<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MobCrafter Admin - Submissions</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, sans-serif; margin: 24px; }
    .wrap { max-width: 980px; margin: 0 auto; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin-top: 12px; }
    h1 { margin: 0 0 8px; }
    .row { display:flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    select, button, input { padding: 10px; border-radius: 10px; border: 1px solid #ccc; }
    button { cursor: pointer; }
    button.primary { background:#111; color:#fff; border: 0; }
    button.danger { background:#b00020; color:#fff; border: 0; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    pre { background:#f6f6f6; padding: 12px; border-radius: 10px; white-space: pre-wrap; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border-bottom: 1px solid #eee; padding: 10px; vertical-align: top; }
    th { text-align: left; color:#444; font-size: 13px; }
    .muted { color:#666; font-size: 13px; }
    .tags { display:flex; flex-wrap: wrap; gap: 6px; }
    .tag { background:#eef; border:1px solid #dde; padding:2px 8px; border-radius: 999px; font-size: 12px; }
  </style>
</head>
<body>
<div class="wrap">
  <h1>MobCrafter 管理画面</h1>
  <div class="muted">※ Cloudflare Access 管理者のみ</div>

  <div class="card">
    <div class="row">
      <label>
        表示ステータス：
        <select id="status">
          <option value="pending" selected>pending</option>
          <option value="approved">approved</option>
          <option value="rejected">rejected</option>
        </select>
      </label>
      <button id="reload" class="primary">再読み込み</button>
      <input id="q" placeholder="検索（タイトル/作者/タグ）" />
      <span id="count" class="muted">0件</span>
    </div>
  </div>

  <div class="card">
    <div class="muted">ログ</div>
    <pre id="log">ready</pre>
  </div>

  <div class="card">
    <div id="list"></div>
  </div>
</div>

<script>
(() => {
  const API_BASE = "/api/admin";
  const $status = document.getElementById("status");
  const $reload = document.getElementById("reload");
  const $q = document.getElementById("q");
  const $count = document.getElementById("count");
  const $log = document.getElementById("log");
  const $list = document.getElementById("list");

  let items = [];

  const log = (v) => $log.textContent = typeof v === "string" ? v : JSON.stringify(v,null,2);

  const esc = (s) => String(s ?? "").replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));

  const parseTags = (tags) => {
    if (Array.isArray(tags)) return tags;
    if (typeof tags === "string") return tags.split(",").map(s=>s.trim()).filter(Boolean);
    return [];
  };

  const api = async (method, path) => {
    const r = await fetch(API_BASE + path, { method, credentials:"include" });
    const t = await r.text();
    let j; try{ j = JSON.parse(t);}catch{ j={raw:t};}
    if(!r.ok) throw j;
    return j;
  };

  const load = async () => {
    log("loading...");
    const st = $status.value;
    const res = await api("GET", `/submissions?status=${encodeURIComponent(st)}`);
    items = res.items || [];
    render();
    log(`loaded ${items.length}`);
  };

  const render = () => {
    const q = ($q.value||"").toLowerCase();
    const view = items.filter(it=>{
      const t = (it.title||"").toLowerCase();
      const a = (it.author_name||it.author_email||"").toLowerCase();
      const g = parseTags(it.tags).join(" ").toLowerCase();
      return !q || t.includes(q) || a.includes(q) || g.includes(q);
    });
    $count.textContent = `${view.length}件`;

    if(!view.length){
      $list.innerHTML = `<div class="muted">該当なし</div>`;
      return;
    }

    $list.innerHTML = `
      <table>
        <thead>
          <tr><th>作成</th><th>内容</th><th>操作</th></tr>
        </thead>
        <tbody>
          ${view.map(it=>{
            const tags = parseTags(it.tags);
            return `
              <tr>
                <td>${esc(it.created_at||"-")}</td>
                <td>
                  <b>${esc(it.title||"(no title)")}</b><br>
                  <span class="muted">${esc(it.author_name||it.author_email||"-")}</span>
                  <div class="tags">${tags.map(t=>`<span class="tag">${esc(t)}</span>`).join("")}</div>
                </td>
                <td>
                  ${$status.value==="pending" ? `
                    <button class="primary" data-a="approve" data-id="${esc(it.id)}">Approve</button>
                    <button data-a="reject" data-id="${esc(it.id)}">Reject</button>
                  ` : ``}
                  <button class="danger" data-a="delete" data-id="${esc(it.id)}">Delete</button>
                </td>
              </tr>`;
          }).join("")}
        </tbody>
      </table>`;
  };

  $list.addEventListener("click", async (e)=>{
    const b = e.target.closest("button"); if(!b) return;
    const id = b.dataset.id;
    const act = b.dataset.a;
    if(!confirm(`${act.toUpperCase()} を実行します。よろしいですか？`)) return;
    try{
      if(act==="approve") await api("POST", `/submissions/${id}/approve`);
      if(act==="reject")  await api("POST", `/submissions/${id}/reject`);
      if(act==="delete")  await api("DELETE", `/submissions/${id}`);
      await load();
    }catch(err){
      log(err);
      alert("失敗しました。ログを確認してください。");
    }
  });

  $reload.onclick = load;
  $status.onchange = load;
  $q.oninput = render;

  load();
})();
</script>
</body>
</html>
