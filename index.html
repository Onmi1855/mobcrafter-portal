<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MobCrafter Portal</title>
  <meta name="description" content="MobCrafterç”¨ãƒ¦ãƒ‹ãƒƒãƒˆJSONå…±æœ‰ãƒãƒ¼ã‚¿ãƒ«ã€‚æ¤œç´¢ãƒ»æ–°ç€ã§æ¢ã›ã¾ã™ã€‚" />
  <style>
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e5e7eb;
      --brand:#2563eb;
      --brand2:#16a34a;
      --shadow: 0 10px 25px rgba(15,23,42,.08);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP","Hiragino Sans","Yu Gothic",sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    a{color:inherit;text-decoration:none}
    .container{max-width:1100px;margin:0 auto;padding:18px}
    header{
      position:sticky; top:0; z-index:10;
      background: rgba(246,248,251,.92);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .topbar{
      display:flex;gap:14px;align-items:center;justify-content:space-between;
      padding:14px 18px;
      max-width:1100px;margin:0 auto;
    }
    .brand{
      display:flex;align-items:center;gap:10px;
      font-weight:900; letter-spacing:.2px;
    }
    .logo{
      width:38px;height:38px;border-radius:12px;
      background: linear-gradient(135deg,var(--brand),#60a5fa);
      display:grid;place-items:center;color:white;font-weight:900;
      box-shadow: 0 8px 18px rgba(37,99,235,.18);
    }
    .brand small{display:block;color:var(--muted);font-weight:700;margin-top:2px}
    .nav{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{
      border:1px solid var(--line);
      background: #fff;
      padding:9px 12px;border-radius:12px;
      font-weight:800;color:var(--text);
    }
    .btn.primary{
      border:none;
      background: linear-gradient(135deg,var(--brand),var(--brand2));
      color:white;
    }

    .hero{
      display:grid;grid-template-columns: 1.35fr .65fr;
      gap:14px;
      padding:18px 0 8px;
    }
    @media (max-width: 860px){ .hero{grid-template-columns:1fr} }
    .card{
      background: var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .heroMain{padding:18px}
    .hero h1{margin:0 0 8px;font-size:28px}
    .hero p{margin:0;color:var(--muted);line-height:1.7}
    .searchRow{display:flex;gap:10px;margin-top:14px;flex-wrap:wrap}
    .search{
      flex:1;min-width:220px;
      display:flex;align-items:center;gap:10px;
      background: #fff;
      border:1px solid var(--line);
      padding:10px 12px;border-radius:14px;
    }
    .search input{
      width:100%;border:none;outline:none;background:transparent;
      color:var(--text);font-size:14px;
    }
    select{
      background:#fff;
      border:1px solid var(--line);
      color:var(--text);
      padding:10px 12px;border-radius:12px;
      outline:none;
      font-weight:700;
    }
    .hint{font-size:12px;color:var(--muted);margin-top:10px}

    .heroSide{padding:18px}
    .stat{display:flex;justify-content:space-between;gap:10px;padding:10px 0;border-bottom:1px solid var(--line)}
    .stat:last-child{border-bottom:none}
    .stat b{color:var(--text)}
    .stat span{color:var(--muted)}

    .toolbar{
      display:flex;justify-content:space-between;align-items:center;gap:12px;
      padding:18px 0 10px;
      flex-wrap:wrap;
    }
    .toolbar .title{font-size:18px;font-weight:900}
    .grid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:14px;
      padding-bottom:28px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns:repeat(2,1fr)} }
    @media (max-width: 640px){ .grid{grid-template-columns:1fr} }

    .item{
      overflow:hidden;
      transition: transform .12s ease, box-shadow .12s ease;
    }
    .item:hover{
      transform: translateY(-2px);
      box-shadow: 0 14px 30px rgba(15,23,42,.12);
    }
    .thumb{
      position:relative;
      height:140px;
      background:
        linear-gradient(180deg, rgba(37,99,235,.10), rgba(22,163,74,.08)),
        #f8fafc;
      border-bottom:1px solid var(--line);
      display:flex;align-items:flex-end;justify-content:space-between;
      padding:12px;
    }
    .badge{
      padding:6px 9px;border-radius:999px;
      background: rgba(255,255,255,.9);
      border:1px solid var(--line);
      color: var(--muted);
      font-size:12px;
      font-weight:800;
    }
    .content{padding:12px}
    .name{font-weight:900;margin:0 0 6px;font-size:16px}
    .desc{margin:0;color:var(--muted);font-size:13px;line-height:1.5;min-height:38px}
    .meta{display:flex;justify-content:space-between;gap:10px;margin-top:10px;color:var(--muted);font-size:12px}
    .footer{border-top:1px solid var(--line);padding:18px 0;color:var(--muted);font-size:12px}

    .errorBox{
      border:1px solid #fecaca;
      background:#fff1f2;
      color:#991b1b;
      padding:12px 14px;
      border-radius:12px;
      margin:10px 0 18px;
      font-size:13px;
      white-space:pre-wrap;
      word-break:break-word;
    }
    .small{
      color:var(--muted);
      font-size:12px;
      margin-top:6px;
    }
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <div class="brand">
        <div class="logo">MC</div>
        <div>
          <div>MobCrafter Portal</div>
          <small>ãƒ¦ãƒ‹ãƒƒãƒˆJSONå…±æœ‰</small>
        </div>
      </div>
      <nav class="nav">
        <a class="btn" href="#latest">æ–°ç€</a>
        <a class="btn" href="#popular">äººæ°—</a>
        <a class="btn" href="/submit">æŠ•ç¨¿</a>
        <a class="btn primary" href="#guide">ä½¿ã„æ–¹</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="hero">
      <div class="card heroMain">
        <h1>MobCrafter ç”¨ãƒ¦ãƒ‹ãƒƒãƒˆJSONã‚’æ¢ã—ã¦ã€ã™ãä½¿ãˆã‚‹ã€‚</h1>
        <p>
          ã‚·ãƒ³ãƒ—ãƒ«ã«ã€Œè¦‹ã¤ã‘ã‚„ã™ã„ã€ã€Œé…å¸ƒãŒå®‰å…¨ã€ã€ŒæŠ•ç¨¿ã—ã‚„ã™ã„ã€ãƒãƒ¼ã‚¿ãƒ«ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚
          ã„ã¾ã¯<strong>MVP</strong>æ®µéšã§ã™ï¼ˆä¸€è¦§ã¯ approved å®Ÿãƒ‡ãƒ¼ã‚¿ï¼‰ã€‚
        </p>

        <div class="searchRow">
          <div class="search" role="search">
            <span aria-hidden="true">ğŸ”</span>
            <input id="q" type="search" placeholder="ä¾‹ï¼šsephiroth / castle / mech / boss / ship" />
          </div>
          <select id="sort">
            <option value="new">æ–°ç€é †</option>
            <option value="name">åå‰é †</option>
          </select>
        </div>

        <div class="hint">â€» è¡¨ç¤ºã¯ approved ã®ã¿ã€‚æŠ•ç¨¿ã¯ /submitã€æ‰¿èªã¯ /admin ã§è¡Œã„ã¾ã™ã€‚</div>
        <div id="err" class="errorBox" style="display:none;"></div>
      </div>

      <aside class="card heroSide">
        <div style="font-weight:900;font-size:16px;margin-bottom:10px;">ãƒãƒ¼ã‚¿ãƒ«çŠ¶æ³</div>
        <div class="stat"><b>å…¬é–‹</b><span>âœ… mobcrafter.net</span></div>
        <div class="stat"><b>UI</b><span>ğŸŸ¢ MVPï¼ˆå®Ÿãƒ‡ãƒ¼ã‚¿ï¼‰</span></div>
        <div class="stat"><b>é…å¸ƒ</b><span>ğŸŸ¢ å®‰å…¨DL</span></div>
        <div class="stat"><b>æŠ•ç¨¿</b><span>ğŸŸ¢ /submit</span></div>
        <div class="stat"><b>åºƒå‘Š</b><span>ğŸ”œ æ¬¡ï¼šAdSenseæº–å‚™</span></div>
        <div class="small">â€» DLæ•°ã¯æ¬¡ãƒ•ã‚§ãƒ¼ã‚ºã§è¨ˆæ¸¬äºˆå®š</div>
      </aside>
    </section>

    <section class="toolbar" id="latest">
      <div class="title">ãƒ¦ãƒ‹ãƒƒãƒˆä¸€è¦§</div>
      <div style="color:var(--muted);font-size:13px;">æ¤œç´¢ / ã‚½ãƒ¼ãƒˆï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ï¼‰</div>
    </section>

    <section class="grid" id="grid"></section>

    <div class="footer">
      Â© <span id="y"></span> MobCrafter Portal â€” MVP
    </div>
  </main>

  <script>
    // ====== API (approved only) ======
    const API_LIST = "https://api.mobcrafter.net/api/public/submissions";
    const API_DL   = (id) => `https://api.mobcrafter.net/api/public/submissions/${id}/download`;

    // ç”»é¢å´ã®çŠ¶æ…‹
    let items = [];

    const grid = document.getElementById("grid");
    const q = document.getElementById("q");
    const sort = document.getElementById("sort");
    const errBox = document.getElementById("err");
    document.getElementById("y").textContent = new Date().getFullYear();

    function showError(msg){
      errBox.style.display = "block";
      errBox.textContent = msg;
    }
    function hideError(){
      errBox.style.display = "none";
      errBox.textContent = "";
    }

    function normalizeTags(tags){
      if (!tags) return [];
      if (Array.isArray(tags)) return tags;
      if (typeof tags === "string") {
        try {
          const v = JSON.parse(tags);
          return Array.isArray(v) ? v : [];
        } catch {
          return tags.split(",").map(s=>s.trim()).filter(Boolean);
        }
      }
      return [];
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    function render(){
      const query = (q.value || "").trim().toLowerCase();

      let list = items.filter(it => {
        if (!query) return true;
        const name = (it.name || "").toLowerCase();
        const desc = (it.desc || "").toLowerCase();
        const author = (it.author || "").toLowerCase();
        const tags = (it.tags || []).join(" ").toLowerCase();
        return name.includes(query) || desc.includes(query) || author.includes(query) || tags.includes(query);
      });

      const s = sort.value;
      list.sort((a,b)=>{
        if(s==="new") return (String(b.date).localeCompare(String(a.date)));
        if(s==="name") return String(a.name).localeCompare(String(b.name));
        return 0;
      });

      if (list.length === 0){
        grid.innerHTML = `<div style="color:var(--muted);">è©²å½“ã™ã‚‹ãƒ¦ãƒ‹ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
        return;
      }

      grid.innerHTML = list.map(it => `
        <a class="card item" href="#unit-${it.id}" title="${escapeHtml(it.name)}">
          <div class="thumb">
            <canvas class="thumb3d" data-id="${escapeHtml(it.id)}" width="360" height="140"
              style="width:100%;height:140px;border-radius:0;"></canvas>
            <div style="position:absolute;inset:auto 12px 12px 12px;display:flex;gap:8px;justify-content:space-between;">
              <span class="badge">JSON</span>
              <span class="badge">Forge ${escapeHtml(it.mod)}</span>
            </div>
          </div>
          <div class="content">
            <div class="name">${escapeHtml(it.name)}</div>
            <p class="desc">${escapeHtml(it.desc)}</p>
            <div class="meta">
              <span>ğŸ‘¤ ${escapeHtml(it.author)}</span>
              <span>â¬‡ ${(it.dl || 0).toLocaleString()}</span>
            </div>
          </div>
        </a>
      `).join("");

      // â˜…HTMLã§canvasä½œã£ãŸç›´å¾Œã«ã‚µãƒ ãƒç”Ÿæˆï¼ˆé‡ã„ã®ã§idleå„ªå…ˆï¼‰
      scheduleHydrate(list);
    }

    async function loadFromApi(){
      hideError();
      grid.innerHTML = `<div style="color:var(--muted);">èª­ã¿è¾¼ã¿ä¸­...</div>`;

      try{
        const resp = await fetch(API_LIST, { method:"GET" });
        const text = await resp.text();
        let data = null;
        try { data = JSON.parse(text); } catch { data = { raw:text }; }

        if(!resp.ok){
          showError("ä¸€è¦§å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nHTTP: " + resp.status + "\n" + JSON.stringify(data, null, 2));
          grid.innerHTML = "";
          return;
        }

        const rows = (data && data.items) ? data.items : [];

        items = rows.map(r => ({
          id: r.id,
          name: r.title,
          desc: r.description || "",
          tags: normalizeTags(r.tags),
          author: r.author_name || "unknown",
          date: r.created_at || "",
          mod: r.mod_version || "",
          jsonUrl: API_DL(r.id),
          dl: 0
        }));

        render();
      }catch(e){
        showError("ä¸€è¦§å–å¾—ã§ä¾‹å¤–ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n" + String(e && e.message ? e.message : e));
        grid.innerHTML = "";
      }
    }

    q.addEventListener("input", render);
    sort.addEventListener("change", render);

    // =========================
    // 3D thumbnail engine v3
    // =========================

    // å›è»¢ã®â€œæµæ´¾å·®â€å¸åç”¨ï¼ˆ0..3ï¼‰
    // ä¾‹ï¼šã“ã“ã‚’ 1 ã«ã™ã‚‹ã¨ã€Œå…¨ä½œå“ã‚’å³90åº¦ã€å¯„ã›ã‚‹
    const YAW_OFFSET_QUARTER = 2;

    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°
    const THUMB_CACHE_VER = "v3";
    const thumbCacheKey = (id)=> `mc_thumb_${THUMB_CACHE_VER}_${id}`;

    function scheduleHydrate(list){
      const run = ()=> hydrateThumbs(list);
      if ("requestIdleCallback" in window) {
        requestIdleCallback(run, { timeout: 1200 });
      } else {
        setTimeout(run, 0);
      }
    }

    async function loadUnitJson(it){
      if (!it.jsonUrl) return null;
      try{
        const r = await fetch(it.jsonUrl, { cache: "no-store" });
        if(!r.ok) return null;
        const ct = (r.headers.get("content-type") || "").toLowerCase();
        // Workerã®è¿”ã—ãŒjsonã§ã‚‚ctãŒé•ã†ã‚±ãƒ¼ã‚¹ã‚’è¨±å®¹ï¼ˆã¾ãšjsonã¨ã—ã¦èª­ã¿ã«è¡Œãï¼‰
        const txt = await r.text();
        try{
          const j = JSON.parse(txt);
          if (!j || !Array.isArray(j.blocks)) return null;
          return j;
        }catch{
          if(!ct.includes("application/json")) return null;
          return null;
        }
      } catch{
        return null;
      }
    }

    function yawToQuarterTurns(frontYaw){
      if(frontYaw == null) return null;
      const y = Number(frontYaw);
      if(!Number.isFinite(y)) return null;

      let deg = y % 360;
      if(deg < 0) deg += 360;

      // 90åº¦åˆ»ã¿ã¸
      let q = (Math.round(deg / 90) % 4);

      // ã‚µã‚¤ãƒˆå´è£œæ­£ï¼ˆä½œå“ã®æµæ´¾å·®ã‚’å¸åï¼‰
      q = (q + YAW_OFFSET_QUARTER) % 4;

      return q;
    }

    function rotateXZ(x, z, q){
      switch(q){
        case 1: return {x: z,  z: -x};
        case 2: return {x: -x, z: -z};
        case 3: return {x: -z, z: x};
        default:return {x, z};
      }
    }

    function analyzeBlocks(blocks){
      let minX=Infinity,minY=Infinity,minZ=Infinity;
      let maxX=-Infinity,maxY=-Infinity,maxZ=-Infinity;
      for(const b of blocks){
        minX=Math.min(minX,b.dx); minY=Math.min(minY,b.dy); minZ=Math.min(minZ,b.dz);
        maxX=Math.max(maxX,b.dx); maxY=Math.max(maxY,b.dy); maxZ=Math.max(maxZ,b.dz);
      }
      return {minX,minY,minZ, maxX,maxY,maxZ, sizeX:maxX-minX+1, sizeY:maxY-minY+1, sizeZ:maxZ-minZ+1};
    }

    // ---- Minecraft â€œã£ã½ã„â€é›‘ãƒ‘ãƒ¬ãƒƒãƒˆ ----
    // æ–‡å­—åˆ—åˆ¤å®šã§ã‚«ãƒ†ã‚´ãƒªã‚’æ±ºã‚ã¦å›ºå®šè‰²ã«ã™ã‚‹ï¼ˆãƒãƒƒã‚·ãƒ¥è‰²ã‚ˆã‚Šé›°å›²æ°—ãŒå‡ºã‚‹ï¼‰
    function pickBaseColor(blockId){
      const id = String(blockId||"").toLowerCase();

      // é€æ˜ç³»
      if (id.includes("glass") || id.includes("ice")) return {r: 170, g: 210, b: 230};
      // æ¤ç‰©
      if (id.includes("leaves") || id.includes("leaf") || id.includes("moss") || id.includes("vine")) return {r: 90, g: 150, b: 90};
      // æœ¨æ
      if (id.includes("log") || id.includes("wood") || id.includes("planks") || id.includes("bamboo")) return {r: 160, g: 125, b: 85};
      // åœŸãƒ»ç ‚
      if (id.includes("dirt") || id.includes("grass") || id.includes("sand") || id.includes("gravel") || id.includes("clay")) return {r: 160, g: 145, b: 110};
      // çŸ³
      if (id.includes("stone") || id.includes("deepslate") || id.includes("andesite") || id.includes("diorite") || id.includes("granite") || id.includes("cobble") || id.includes("tuff")) return {r: 140, g: 145, b: 155};
      // é‡‘å±
      if (id.includes("iron") || id.includes("anvil") || id.includes("chain") || id.includes("rail")) return {r: 170, g: 175, b: 185};
      if (id.includes("copper")) return {r: 190, g: 120, b: 80};
      if (id.includes("gold")) return {r: 210, g: 185, b: 90};
      // å®çŸ³
      if (id.includes("diamond")) return {r: 120, g: 210, b: 220};
      if (id.includes("emerald")) return {r: 70, g: 200, b: 120};
      if (id.includes("lapis")) return {r: 70, g: 110, b: 200};
      if (id.includes("redstone")) return {r: 190, g: 70, b: 70};
      // ã‚³ãƒ³ã‚¯ãƒª/ç¾Šæ¯›/ãƒ†ãƒ©ã‚³ãƒƒã‚¿ï¼ˆè‰²åãŒå…¥ã£ã¦ãŸã‚‰å¯„ã›ã‚‹ï¼‰
      if (id.includes("wool") || id.includes("concrete") || id.includes("terracotta")) {
        if (id.includes("white")) return {r: 220,g:220,b:220};
        if (id.includes("black")) return {r: 60,g:60,b:65};
        if (id.includes("gray")) return {r: 130,g:130,b:135};
        if (id.includes("light_gray")) return {r: 180,g:180,b:185};
        if (id.includes("red")) return {r: 190,g:75,b:75};
        if (id.includes("blue")) return {r: 85,g:120,b:200};
        if (id.includes("green")) return {r: 85,g:170,b:110};
        if (id.includes("yellow")) return {r: 220,g:200,b:90};
        if (id.includes("purple")) return {r: 150,g:95,b:190};
        if (id.includes("pink")) return {r: 220,g:140,b:170};
        if (id.includes("orange")) return {r: 220,g:150,b:80};
        if (id.includes("cyan")) return {r: 95,g:190,b:190};
        if (id.includes("magenta")) return {r: 200,g:110,b:190};
        return {r: 180,g:160,b:150};
      }

      // fallbackï¼ˆãƒãƒƒã‚·ãƒ¥è‰²ã ã‘ã©æ§ãˆã‚ï¼‰
      let h=0;
      for(let i=0;i<id.length;i++) h=(h*31 + id.charCodeAt(i))|0;
      const r = 120 + (h & 70);
      const g = 120 + ((h>>8)&70);
      const b = 120 + ((h>>16)&70);
      return {r,g,b};
    }

    function drawIsoCube(ctx, x, y, z, s, col, stroke){
      const sx = (x - z) * s;
      const sy = (x + z) * s * 0.5 - y * s;

      const top = `rgb(${Math.min(255,col.r+30)},${Math.min(255,col.g+30)},${Math.min(255,col.b+30)})`;
      const left= `rgb(${Math.max(0,col.r-10)},${Math.max(0,col.g-10)},${Math.max(0,col.b-10)})`;
      const right=`rgb(${Math.max(0,col.r-25)},${Math.max(0,col.g-25)},${Math.max(0,col.b-25)})`;

      // ä¸Šé¢
      ctx.fillStyle = top;
      ctx.beginPath();
      ctx.moveTo(sx, sy - s*0.5);
      ctx.lineTo(sx + s, sy);
      ctx.lineTo(sx, sy + s*0.5);
      ctx.lineTo(sx - s, sy);
      ctx.closePath();
      ctx.fill();

      if (stroke){
        ctx.strokeStyle = "rgba(15,23,42,.10)";
        ctx.lineWidth = Math.max(1, s*0.06);
        ctx.stroke();
      }

      // å·¦é¢
      ctx.fillStyle = left;
      ctx.beginPath();
      ctx.moveTo(sx - s, sy);
      ctx.lineTo(sx, sy + s*0.5);
      ctx.lineTo(sx, sy + s*0.5 + s);
      ctx.lineTo(sx - s, sy + s);
      ctx.closePath();
      ctx.fill();

      // å³é¢
      ctx.fillStyle = right;
      ctx.beginPath();
      ctx.moveTo(sx + s, sy);
      ctx.lineTo(sx, sy + s*0.5);
      ctx.lineTo(sx, sy + s*0.5 + s);
      ctx.lineTo(sx + s, sy + s);
      ctx.closePath();
      ctx.fill();
    }

    // ---- ç©ºé–“ãƒ“ãƒ‹ãƒ³ã‚°ã§é›†ç´„ï¼ˆè¼ªéƒ­ãŒæ®‹ã‚Šã‚„ã™ã„ï¼‰ ----
    // bin=2ãªã‚‰ 2x2x2 ã®å°ç«‹æ–¹ä½“ã”ã¨ã«1ãƒ–ãƒ­ãƒƒã‚¯ã¸åœ§ç¸®
    function binBlocks(blocks, bin){
      if(bin <= 1) return blocks;

      const m = new Map();
      for(const b of blocks){
        const bx = Math.floor(b.dx / bin);
        const by = Math.floor(b.dy / bin);
        const bz = Math.floor(b.dz / bin);
        const k = bx + "," + by + "," + bz;

        // ãã®ãƒ“ãƒ³å†…ã§ã€Œä¸€ç•ªä¸Šï¼ˆdyãŒå¤§ï¼‰ã€ã‚’å„ªå…ˆã—ã¦æ®‹ã™ï¼ˆã‚·ãƒ«ã‚¨ãƒƒãƒˆãŒå´©ã‚Œã«ãã„ï¼‰
        const cur = m.get(k);
        if(!cur || b.dy > cur.dy){
          m.set(k, b);
        }
      }
      return Array.from(m.values());
    }

    function chooseBinSize(blockCount, info){
      // ç›®æ¨™ç‚¹æ•°ï¼ˆã‚µãƒ ãƒç”¨ï¼‰
      const target = 16000;

      if(blockCount <= target) return 1;

      // ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ç®±ã®ä½“ç©ã£ã½ã„ã‚‚ã®ã‹ã‚‰è’ãæ±ºã‚ã‚‹
      const vol = Math.max(1, info.sizeX * info.sizeY * info.sizeZ);
      const ratio = blockCount / target;

      // ã ã„ãŸã„ ratio ã®ç«‹æ–¹æ ¹ãŒç¸®å°ä¿‚æ•°ã®ç›®å®‰
      let bin = Math.ceil(Math.cbrt(ratio));

      // å½¢ãŒç´°ã„/è–„ã„ä½œå“ã‚’æ½°ã—ã™ããªã„ãŸã‚ä¸Šé™ã¯æ§ãˆã‚ã«
      bin = Math.min(6, Math.max(2, bin));
      return bin;
    }

    function renderThumbToCanvas(canvas, unitJson){
      const ctx = canvas.getContext("2d");
      const w = canvas.width, h = canvas.height;

      // èƒŒæ™¯
      ctx.clearRect(0,0,w,h);
      const g = ctx.createLinearGradient(0,0,0,h);
      g.addColorStop(0,"rgba(37,99,235,.10)");
      g.addColorStop(1,"rgba(22,163,74,.08)");
      ctx.fillStyle = g;
      ctx.fillRect(0,0,w,h);

      const blocks0 = unitJson.blocks;
      const qTurns = yawToQuarterTurns(unitJson.frontYaw); // nullãªã‚‰ä¸æ˜

      // ã¾ãš bbox ã‚’å–ã£ã¦ã€bin ã‚’æ±ºã‚ã‚‹
      const info0 = analyzeBlocks(blocks0);
      const bin = chooseBinSize(blocks0.length, info0);

      // é›†ç´„ã—ã¦ã‹ã‚‰å›è»¢
      const blocks = binBlocks(blocks0, bin);

      function drawPass(turns, alpha){
        // å›è»¢å¾Œåº§æ¨™ã‚’ä½œã‚‹
        const transformed = blocks.map(b=>{
          const r = rotateXZ(b.dx, b.dz, turns);
          return {dx:r.x, dy:b.dy, dz:r.z, blockId:b.blockId};
        });

        const inf = analyzeBlocks(transformed);

        const spanX = inf.sizeX + inf.sizeZ;
        const spanY = inf.sizeY;

        const s = Math.max(1.8, Math.min(w/(spanX+6), h/(spanY+10)) * 1.6);

        const ox = w*0.5;
        const oy = h*0.80;

        // æç”»é †ï¼ˆå¥¥â†’æ‰‹å‰/ä¸‹â†’ä¸Šå¯„ã‚Šï¼‰
        transformed.sort((a,b)=>
          (a.dx+a.dz) - (b.dx+b.dz) || (a.dy - b.dy)
        );

        ctx.save();
        ctx.globalAlpha = alpha;
        ctx.translate(ox, oy);

        const stroke = (s >= 3); // å°ã•ã™ãã‚‹æ™‚ã¯ç·šã‚’æ¶ˆã™
        for(const b of transformed){
          const x = (b.dx - inf.minX);
          const y = (b.dy - inf.minY);
          const z = (b.dz - inf.minZ);
          const col = pickBaseColor(b.blockId);
          drawIsoCube(ctx, x, y, z, s, col, stroke);
        }

        ctx.restore();
      }

      // frontYaw ç„¡ã„ â†’ ä¸¡é¢ï¼ˆæ­£é¢æ›–æ˜§ã§ã‚‚ç ´ç¶»ã—ã«ãã„ï¼‰
      if(qTurns == null){
        drawPass(0, 1.0);
        drawPass(2, 0.33);
      }else{
        drawPass(qTurns, 1.0);
      }
    }

    async function hydrateThumbs(list){
      const canvases = [...document.querySelectorAll("canvas.thumb3d")];

      for(const c of canvases){
        const id = c.dataset.id;

        const cache = localStorage.getItem(thumbCacheKey(id));
        if(cache){
          const img = new Image();
          img.onload = ()=> c.getContext("2d").drawImage(img,0,0,c.width,c.height);
          img.src = cache;
          continue;
        }

        const it = list.find(x=>String(x.id)===String(id));
        if(!it) continue;

        const unitJson = await loadUnitJson(it);
        if(!unitJson) continue;

        renderThumbToCanvas(c, unitJson);

        try{
          const png = c.toDataURL("image/png");
          localStorage.setItem(thumbCacheKey(id), png);
        }catch{}
      }
    }

    // åˆå›ãƒ­ãƒ¼ãƒ‰
    loadFromApi();
  </script>
</body>
</html>
