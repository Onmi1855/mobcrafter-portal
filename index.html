<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MobCrafter Portal</title>
  <meta name="description" content="MobCrafterç”¨ãƒ¦ãƒ‹ãƒƒãƒˆJSONå…±æœ‰ãƒãƒ¼ã‚¿ãƒ«ã€‚æ¤œç´¢ãƒ»æ–°ç€ã§æ¢ã›ã¾ã™ã€‚" />
  <style>
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e5e7eb;
      --brand:#2563eb;
      --shadow: 0 10px 25px rgba(15,23,42,.08);
      --radius: 16px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:var(--bg);
    }
    header{
      padding:24px 16px 10px;
      text-align:center;
    }
    header h1{
      margin:0;
      font-size:20px;
      letter-spacing:.4px;
    }
    header p{
      margin:6px 0 0;
      color:var(--muted);
      font-size:12px;
    }
    main{
      max-width:1060px;
      margin:0 auto;
      padding:10px 16px 40px;
    }
    .topbar{
      display:flex;
      gap:12px;
      align-items:flex-end;
      justify-content:space-between;
      flex-wrap:wrap;
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:14px 14px;
      box-shadow:var(--shadow);
    }
    .leftbox{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:flex-end;
    }
    .field label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
    }
    input[type="text"], select{
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      font-size:14px;
      min-width:260px;
      outline:none;
      background:#fff;
    }
    select{ min-width:180px; }
    .muted{
      color:var(--muted);
      font-size:12px;
    }
    .error{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      background:#fff1f2;
      border:1px solid #fecdd3;
      color:#9f1239;
      display:none;
      white-space:pre-wrap;
    }
    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap:14px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      cursor:pointer;
      transition: transform .08s ease, box-shadow .08s ease;
      position:relative;
    }
    .card:hover{
      transform: translateY(-1px);
      box-shadow: 0 14px 30px rgba(15,23,42,.10);
    }
    .thumbwrap{
      height:140px;
      background: linear-gradient(180deg, #e6f0ff, #f5f9ff);
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
    }
    canvas.thumb{
      width:100%;
      height:140px;
      image-rendering:pixelated;
    }
    .pill{
      position:absolute;
      top:10px;
      left:10px;
      display:flex;
      gap:6px;
      align-items:center;
    }
    .badge{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      background:rgba(255,255,255,.78);
      border:1px solid rgba(148,163,184,.35);
      color:#0f172a;
      backdrop-filter: blur(6px);
    }
    .btn-dl{
      position:absolute;
      top:10px;
      right:10px;
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(37,99,235,.92);
      color:#fff;
      border:1px solid rgba(37,99,235,.10);
      text-decoration:none;
      backdrop-filter: blur(6px);
    }
    .card-body{
      padding:12px 12px 14px;
    }
    .title{
      margin:0;
      font-size:15px;
      font-weight:700;
      line-height:1.25;
    }
    .meta{
      margin-top:8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-size:12px;
      color:var(--muted);
    }
    .meta .left{
      display:flex;
      gap:10px;
      align-items:center;
      min-width:0;
    }
    .meta .author{
      display:flex;
      gap:6px;
      align-items:center;
      min-width:0;
    }
    .meta .author span{
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width:120px;
      display:block;
    }
    .meta .dl{
      display:flex;
      gap:6px;
      align-items:center;
    }
    .tagline{
      margin-top:8px;
      font-size:12px;
      color:var(--muted);
      overflow:hidden;
      white-space:nowrap;
      text-overflow:ellipsis;
    }
    footer{
      margin-top:26px;
      text-align:center;
      font-size:12px;
      color:var(--muted);
    }
  </style>
</head>
<body>
<header>
  <h1>MobCrafter Portal</h1>
  <p>ãƒ¦ãƒ‹ãƒƒãƒˆJSONå…±æœ‰ï¼ˆMVPï¼‰</p>
</header>

<main>
  <div class="topbar">
    <div class="leftbox">
      <div class="field">
        <label>æ¢ã™</label>
        <input id="q" type="text" placeholder="æ¤œç´¢ï¼ˆä¾‹ï¼šsephiroth / boss / swordï¼‰" />
        <div class="muted">ã‚¿ã‚¤ãƒˆãƒ« / èª¬æ˜ / ã‚¿ã‚°ã§æ¤œç´¢ã§ãã¾ã™ã€‚ã‚µãƒ ãƒã¯ç°¡æ˜“3Dæç”»ã€‚</div>
      </div>

      <div class="field">
        <label>Yawè£œæ­£</label>
        <select id="yaw">
          <option value="270">Yawè£œæ­£ +270Â°</option>
          <option value="180">Yawè£œæ­£ +180Â°</option>
          <option value="90">Yawè£œæ­£ +90Â°</option>
          <option value="0">Yawè£œæ­£ ãªã—</option>
        </select>
        <div class="muted">ã‚«ãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°ã¸ï¼ˆ/u/æ•°å­— or /u/UUIDï¼‰</div>
      </div>
    </div>

    <div class="field">
      <label>ä¸¦ã³æ›¿ãˆ</label>
      <select id="sort">
        <option value="new">æ–°ç€é †</option>
        <option value="dl">DLå¤šã„é †</option>
        <option value="name">åå‰é †</option>
      </select>
    </div>

    <div id="err" class="error"></div>
  </div>

  <section id="grid" class="grid"></section>

  <footer>Â© 2025 MobCrafter Portal â€” MVP</footer>
</main>

<script>
(() => {
  // ====== API ======
  const API_LIST = "/api/public/submissions";
  const API_JSON = (id) => `/api/public/submissions/${id}/json`;      // DLã‚«ã‚¦ãƒ³ãƒˆã—ãªã„
  const API_DL   = (id) => `/api/public/submissions/${id}/download`;  // DLã‚«ã‚¦ãƒ³ãƒˆã™ã‚‹

  let items = [];

  const grid = document.getElementById("grid");
  const q = document.getElementById("q");
  const sort = document.getElementById("sort");
  const yawUi = document.getElementById("yaw");
  const err = document.getElementById("err");

  function showError(msg){
    err.style.display = "block";
    err.textContent = msg;
  }
  function hideError(){
    err.style.display = "none";
    err.textContent = "";
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  function normalizeTags(t){
    if(!t) return [];
    if(Array.isArray(t)) return t.map(x=>String(x).trim()).filter(Boolean);
    return String(t).split(/[\s,]+/).map(x=>x.trim()).filter(Boolean);
  }

  function asDateIso(s){
    try{
      const d = new Date(s);
      if(Number.isNaN(d.getTime())) return null;
      return d.toISOString();
    }catch{
      return null;
    }
  }

  function resolveNo(row){
    const n = Number(row.submission_no ?? row.submissionNo ?? row.no ?? 0);
    return n || 0;
  }

  async function fetchUnitJson(id){
    const r = await fetch(API_JSON(id), { cache: "no-store" });
    if(!r.ok) throw new Error("json HTTP " + r.status);
    return await r.json();
  }

  // ç°¡æ˜“æç”»ï¼ˆè»½é‡MVPï¼‰
  function drawIso(canvas, blocks, yawDeg){
    const ctx = canvas.getContext("2d");
    const w = canvas.width, h = canvas.height;
    ctx.clearRect(0,0,w,h);

    if(!Array.isArray(blocks) || blocks.length === 0){
      ctx.fillStyle = "rgba(15,23,42,.35)";
      ctx.font = "12px sans-serif";
      ctx.fillText("No blocks", 10, 20);
      return;
    }

    const yaw = (yawDeg||0) * Math.PI/180;

    const pts = blocks.map(b => {
      const x = Number(b.dx||0), y=Number(b.dy||0), z=Number(b.dz||0);
      const rx =  x*Math.cos(yaw) - z*Math.sin(yaw);
      const rz =  x*Math.sin(yaw) + z*Math.cos(yaw);
      const sx = (rx - rz) * 6;
      const sy = (rx + rz) * 3 - y * 6;
      return { sx, sy, bid: String(b.blockId||"") };
    });

    let minX=1e9,maxX=-1e9,minY=1e9,maxY=-1e9;
    for(const p of pts){
      minX=Math.min(minX,p.sx); maxX=Math.max(maxX,p.sx);
      minY=Math.min(minY,p.sy); maxY=Math.max(maxY,p.sy);
    }
    const cx = (minX+maxX)/2;
    const cy = (minY+maxY)/2;

    const scale = Math.min(
      (w-30)/(maxX-minX+20),
      (h-30)/(maxY-minY+20)
    );

    pts.sort((a,b)=>a.sy-b.sy);

    for(const p of pts){
      const x = (p.sx - cx) * scale + w/2;
      const y = (p.sy - cy) * scale + h/2;

      let hash=0;
      for(let i=0;i<p.bid.length;i++) hash = ((hash<<5)-hash + p.bid.charCodeAt(i))|0;
      const r = 120 + (hash & 63);
      const g = 120 + ((hash>>6) & 63);
      const b = 120 + ((hash>>12) & 63);

      ctx.fillStyle = `rgb(${r%256},${g%256},${b%256})`;
      ctx.fillRect(x-4, y-4, 8, 8);
      ctx.strokeStyle = "rgba(15,23,42,.15)";
      ctx.strokeRect(x-4, y-4, 8, 8);
    }
  }

  function renderCard(it){
    const card = document.createElement("article");
    card.className = "card";
    card.setAttribute("data-id", it.id);
    card.setAttribute("data-no", String(it.no || 0));

    card.innerHTML = `
      <div class="thumbwrap">
        <canvas class="thumb" width="480" height="280"></canvas>
        <div class="pill">
          <span class="badge">${escapeHtml(it.mod || "Forge")}</span>
        </div>
        <a class="btn-dl" href="${escapeHtml(API_DL(it.id))}" download>Download</a>
      </div>
      <div class="card-body">
        <p class="title">${escapeHtml(it.name)}</p>
        <div class="meta">
          <div class="left">
            <div class="author">ğŸ‘¤ <span>${escapeHtml(it.author || "unknown")}</span></div>
            <div class="dl">â¬‡ ${escapeHtml(it.dl ?? 0)}</div>
          </div>
          <div class="time">ğŸ•’ ${escapeHtml(it.createdText)}</div>
        </div>
        <div class="tagline">${escapeHtml(it.tags.join(" / "))}</div>
      </div>
    `;

    card.addEventListener("click", (e) => {
      const a = e.target && e.target.closest ? e.target.closest("a") : null;
      if (a) return;

      const no = Number(card.getAttribute("data-no") || 0);
      const id = card.getAttribute("data-id") || "";

      // â˜…ã“ã“ãŒä»Šå›ã®ä¿®æ­£ç‚¹ï¼š
      // submission_no ãŒç„¡ã„æ—§ãƒ‡ãƒ¼ã‚¿ã¯ /u/<UUID> ã«é£›ã°ã™ï¼ˆè¡¨ç¤ºã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ï¼‰
if (no) location.href = `/unit.html?id=${encodeURIComponent(String(no))}`;
else if (id) location.href = `/unit.html?id=${encodeURIComponent(String(id))}`;
    });

    const canvas = card.querySelector("canvas.thumb");
    (async () => {
      try{
        const j = await fetchUnitJson(it.id);
        const yaw = Number(yawUi.value || 270);
        drawIso(canvas, j.blocks, yaw);
      }catch{
        // å¤±æ•—ã—ã¦ã‚‚ç„¡è¦–ï¼ˆè»½é‡MVPï¼‰
      }
    })();

    return card;
  }

  function applyFilter(){
    const kw = String(q.value||"").trim().toLowerCase();
    let arr = items.slice();

    if(kw){
      arr = arr.filter(it => {
        const hay = (it.name + " " + it.desc + " " + it.tags.join(" ")).toLowerCase();
        return hay.includes(kw);
      });
    }

    const mode = String(sort.value||"new");
    if(mode === "dl"){
      arr.sort((a,b)=> (b.dl||0)-(a.dl||0));
    }else if(mode === "name"){
      arr.sort((a,b)=> String(a.name).localeCompare(String(b.name)));
    }else{
      arr.sort((a,b)=> (b.created||"").localeCompare(a.created||""));
    }

    grid.innerHTML = "";
    for(const it of arr){
      grid.appendChild(renderCard(it));
    }
  }

  async function load(){
    hideError();
    grid.innerHTML = "";
    try{
      const r = await fetch(API_LIST, { cache:"no-store" });
      if(!r.ok) throw new Error("list HTTP " + r.status);
      const data = await r.json();
      const arr = Array.isArray(data.items) ? data.items : [];
      items = arr.map(r => {
        const created = asDateIso(r.created_at || r.createdAt || r.created);
        const createdText = created ? created.slice(0,10) : "";
        const tags = normalizeTags(r.tags);
        const no = resolveNo(r);

        return ({
          id: String(r.id),
          no,
          name: r.title || r.name || "Untitled",
          desc: r.description || "",
          tags,
          author: r.author_name || r.authorName || "unknown",
          dl: Number(r.download_count ?? r.downloadCount ?? 0),
          mod: r.mod_version || r.modVersion || "Forge",
          created: created || "",
          createdText,
        });
      });

      applyFilter();
    }catch(e){
      showError("ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n" + String(e.message || e));
    }
  }

  q.addEventListener("input", applyFilter);
  sort.addEventListener("change", applyFilter);
  yawUi.addEventListener("change", applyFilter);

  load();
})();
</script>
</body>
</html>
