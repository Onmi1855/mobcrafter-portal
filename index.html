<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MobCrafter Portal</title>
  <meta name="description" content="MobCrafterç”¨ãƒ¦ãƒ‹ãƒƒãƒˆJSONå…±æœ‰ãƒãƒ¼ã‚¿ãƒ«ã€‚æ¤œç´¢ãƒ»æ–°ç€ã§æ¢ã›ã¾ã™ã€‚" />
  <style>
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e5e7eb;
      --brand:#2563eb;
      --brand2:#16a34a;
      --shadow: 0 10px 25px rgba(15,23,42,.08);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP","Hiragino Sans","Yu Gothic",sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    a{color:inherit;text-decoration:none}
    .container{max-width:1100px;margin:0 auto;padding:18px}
    header{
      position:sticky; top:0; z-index:10;
      background: rgba(246,248,251,.92);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .topbar{
      display:flex;gap:14px;align-items:center;justify-content:space-between;
      padding:14px 18px;
      max-width:1100px;margin:0 auto;
    }
    .brand{
      display:flex;align-items:center;gap:10px;
      font-weight:900; letter-spacing:.2px;
    }
    .logo{
      width:38px;height:38px;border-radius:12px;
      background: linear-gradient(135deg,var(--brand),#60a5fa);
      display:grid;place-items:center;color:white;font-weight:900;
      box-shadow: 0 8px 18px rgba(37,99,235,.18);
    }
    .brand small{display:block;color:var(--muted);font-weight:700;margin-top:2px}
    .nav{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{
      border:1px solid var(--line);
      background: #fff;
      padding:9px 12px;border-radius:12px;
      font-weight:800;color:var(--text);
    }
    .btn.primary{
      border:none;
      background: linear-gradient(135deg,var(--brand),var(--brand2));
      color:white;
    }

    .hero{
      display:grid;grid-template-columns: 1.35fr .65fr;
      gap:14px;
      padding:18px 0 8px;
    }
    @media (max-width: 860px){ .hero{grid-template-columns:1fr} }
    .card{
      background: var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .heroMain{padding:18px}
    .hero h1{margin:0 0 8px;font-size:28px}
    .hero p{margin:0;color:var(--muted);line-height:1.7}
    .searchRow{display:flex;gap:10px;margin-top:14px;flex-wrap:wrap}
    .search{
      flex:1;min-width:220px;
      display:flex;align-items:center;gap:10px;
      background: #fff;
      border:1px solid var(--line);
      padding:10px 12px;border-radius:14px;
    }
    .search input{
      width:100%;border:none;outline:none;background:transparent;
      color:var(--text);font-size:14px;
    }
    select{
      background:#fff;
      border:1px solid var(--line);
      color:var(--text);
      padding:10px 12px;border-radius:12px;
      outline:none;
      font-weight:700;
    }
    .hint{font-size:12px;color:var(--muted);margin-top:10px}

    .heroSide{padding:18px}
    .stat{display:flex;justify-content:space-between;gap:10px;padding:10px 0;border-bottom:1px solid var(--line)}
    .stat:last-child{border-bottom:none}
    .stat b{color:var(--text)}
    .stat span{color:var(--muted)}

    .toolbar{
      display:flex;justify-content:space-between;align-items:center;gap:12px;
      padding:18px 0 10px;
      flex-wrap:wrap;
    }
    .toolbar .title{font-size:18px;font-weight:900}
    .grid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:14px;
      padding-bottom:28px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns:repeat(2,1fr)} }
    @media (max-width: 640px){ .grid{grid-template-columns:1fr} }

    .item{
      overflow:hidden;
      transition: transform .12s ease, box-shadow .12s ease;
    }
    .item:hover{
      transform: translateY(-2px);
      box-shadow: 0 14px 30px rgba(15,23,42,.12);
    }
    .thumb{
      position:relative; height:140px;
      height:140px;
      background:
        linear-gradient(180deg, rgba(37,99,235,.10), rgba(22,163,74,.08)),
        #f8fafc;
      border-bottom:1px solid var(--line);
      display:flex;align-items:flex-end;justify-content:space-between;
      padding:12px;
    }
    .badge{
      padding:6px 9px;border-radius:999px;
      background: rgba(255,255,255,.9);
      border:1px solid var(--line);
      color: var(--muted);
      font-size:12px;
      font-weight:800;
    }
    .content{padding:12px}
    .name{font-weight:900;margin:0 0 6px;font-size:16px}
    .desc{margin:0;color:var(--muted);font-size:13px;line-height:1.5;min-height:38px}
    .meta{display:flex;justify-content:space-between;gap:10px;margin-top:10px;color:var(--muted);font-size:12px}
    .footer{border-top:1px solid var(--line);padding:18px 0;color:var(--muted);font-size:12px}

    .errorBox{
      border:1px solid #fecaca;
      background:#fff1f2;
      color:#991b1b;
      padding:12px 14px;
      border-radius:12px;
      margin:10px 0 18px;
      font-size:13px;
      white-space:pre-wrap;
      word-break:break-word;
    }
    .small{
      color:var(--muted);
      font-size:12px;
      margin-top:6px;
    }
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <div class="brand">
        <div class="logo">MC</div>
        <div>
          <div>MobCrafter Portal</div>
          <small>ãƒ¦ãƒ‹ãƒƒãƒˆJSONå…±æœ‰</small>
        </div>
      </div>
      <nav class="nav">
        <a class="btn" href="#latest">æ–°ç€</a>
        <a class="btn" href="#popular">äººæ°—</a>
        <a class="btn" href="/submit">æŠ•ç¨¿</a>
        <a class="btn primary" href="#guide">ä½¿ã„æ–¹</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="hero">
      <div class="card heroMain">
        <h1>MobCrafter ç”¨ãƒ¦ãƒ‹ãƒƒãƒˆJSONã‚’æ¢ã—ã¦ã€ã™ãä½¿ãˆã‚‹ã€‚</h1>
        <p>
          ã‚·ãƒ³ãƒ—ãƒ«ã«ã€Œè¦‹ã¤ã‘ã‚„ã™ã„ã€ã€Œé…å¸ƒãŒå®‰å…¨ã€ã€ŒæŠ•ç¨¿ã—ã‚„ã™ã„ã€ãƒãƒ¼ã‚¿ãƒ«ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚
          ã„ã¾ã¯<strong>MVP</strong>æ®µéšã§ã™ï¼ˆä¸€è¦§ã¯ approved å®Ÿãƒ‡ãƒ¼ã‚¿ï¼‰ã€‚
        </p>

        <div class="searchRow">
          <div class="search" role="search">
            <span aria-hidden="true">ğŸ”</span>
            <input id="q" type="search" placeholder="ä¾‹ï¼šsephiroth / castle / mech / boss / ship" />
          </div>
          <select id="sort">
            <option value="new">æ–°ç€é †</option>
            <option value="name">åå‰é †</option>
          </select>
        </div>

        <div class="hint">â€» è¡¨ç¤ºã¯ approved ã®ã¿ã€‚æŠ•ç¨¿ã¯ /submitã€æ‰¿èªã¯ /admin ã§è¡Œã„ã¾ã™ã€‚</div>
        <div id="err" class="errorBox" style="display:none;"></div>
      </div>

      <aside class="card heroSide">
        <div style="font-weight:900;font-size:16px;margin-bottom:10px;">ãƒãƒ¼ã‚¿ãƒ«çŠ¶æ³</div>
        <div class="stat"><b>å…¬é–‹</b><span>âœ… mobcrafter.net</span></div>
        <div class="stat"><b>UI</b><span>ğŸŸ¢ MVPï¼ˆå®Ÿãƒ‡ãƒ¼ã‚¿ï¼‰</span></div>
        <div class="stat"><b>é…å¸ƒ</b><span>ğŸŸ¢ å®‰å…¨DL</span></div>
        <div class="stat"><b>æŠ•ç¨¿</b><span>ğŸŸ¢ /submit</span></div>
        <div class="stat"><b>åºƒå‘Š</b><span>ğŸ”œ æ¬¡ï¼šAdSenseæº–å‚™</span></div>
        <div class="small">â€» DLæ•°ã¯æ¬¡ãƒ•ã‚§ãƒ¼ã‚ºã§è¨ˆæ¸¬äºˆå®š</div>
      </aside>
    </section>

    <section class="toolbar" id="latest">
      <div class="title">ãƒ¦ãƒ‹ãƒƒãƒˆä¸€è¦§</div>
      <div style="color:var(--muted);font-size:13px;">æ¤œç´¢ / ã‚½ãƒ¼ãƒˆï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ï¼‰</div>
    </section>

    <section class="grid" id="grid"></section>

    <div class="footer">
      Â© <span id="y"></span> MobCrafter Portal â€” MVP
    </div>
  </main>

  <script>
    // ====== API (approved only) ======
    const API_LIST = "https://api.mobcrafter.net/api/public/submissions";
    const API_DL   = (id) => `https://api.mobcrafter.net/api/public/submissions/${id}/download`;

    // ç”»é¢å´ã®çŠ¶æ…‹
    let items = [];

    const grid = document.getElementById("grid");
    const q = document.getElementById("q");
    const sort = document.getElementById("sort");
    const errBox = document.getElementById("err");
    document.getElementById("y").textContent = new Date().getFullYear();

    function showError(msg){
      errBox.style.display = "block";
      errBox.textContent = msg;
    }
    function hideError(){
      errBox.style.display = "none";
      errBox.textContent = "";
    }

    function normalizeTags(tags){
      if (!tags) return [];
      if (Array.isArray(tags)) return tags;
      if (typeof tags === "string") {
        // D1ã« JSON.stringify ã—ã¦ã‚ã‚‹æƒ³å®šãªã®ã§ parse
        try {
          const v = JSON.parse(tags);
          return Array.isArray(v) ? v : [];
        } catch {
          // ã‚‚ã—ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥ã£ã¦ãã¦ã‚‚è½ã¡ãªã„ã‚ˆã†ã«
          return tags.split(",").map(s=>s.trim()).filter(Boolean);
        }
      }
      return [];
    }

    function render(){
      const query = (q.value || "").trim().toLowerCase();

      let list = items.filter(it => {
        if (!query) return true;
        const name = (it.name || "").toLowerCase();
        const desc = (it.desc || "").toLowerCase();
        const author = (it.author || "").toLowerCase();
        const tags = (it.tags || []).join(" ").toLowerCase();
        return name.includes(query) || desc.includes(query) || author.includes(query) || tags.includes(query);
      });

      const s = sort.value;
      list.sort((a,b)=>{
        if(s==="new") return (String(b.date).localeCompare(String(a.date)));
        if(s==="name") return String(a.name).localeCompare(String(b.name));
        return 0;
      });

      if (list.length === 0){
        grid.innerHTML = `<div style="color:var(--muted);">è©²å½“ã™ã‚‹ãƒ¦ãƒ‹ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
          hydrateThumbs(list);
        return;
      }

grid.innerHTML = list.map(it => `
  <a class="card item" href="#unit-${it.id}" title="${it.name}">
    <div class="thumb">
      <canvas class="thumb3d" data-id="${escapeHtml(it.id)}" width="360" height="140"
        style="width:100%;height:140px;border-radius:0;"></canvas>
      <div style="position:absolute;inset:auto 12px 12px 12px;display:flex;gap:8px;justify-content:space-between;">
        <span class="badge">JSON</span>
        <span class="badge">Forge ${escapeHtml(it.mod)}</span>
      </div>
    </div>
    <div class="content">
      <div class="name">${escapeHtml(it.name)}</div>
      <p class="desc">${escapeHtml(it.desc)}</p>
      <div class="meta">
        <span>ğŸ‘¤ ${escapeHtml(it.author)}</span>
        <span>â¬‡ ${Number(it.dl ?? 0).toLocaleString()}</span>
      </div>
    </div>
  </a>
`).join("");

    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    async function loadFromApi(){
      hideError();
      grid.innerHTML = `<div style="color:var(--muted);">èª­ã¿è¾¼ã¿ä¸­...</div>`;

      try{
        const resp = await fetch(API_LIST, { method:"GET" });
        const text = await resp.text();
        let data = null;
        try { data = JSON.parse(text); } catch { data = { raw:text }; }

        if(!resp.ok){
          showError("ä¸€è¦§å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nHTTP: " + resp.status + "\n" + JSON.stringify(data, null, 2));
          grid.innerHTML = "";
          return;
        }

        const rows = (data && data.items) ? data.items : [];
        // WorkerãŒè¿”ã™å½¢å¼ã«åˆã‚ã›ã¦è¡¨ç¤ºç”¨ã¸æ•´å½¢
items = rows.map(r => ({
  id: r.id,
  name: r.title,
  desc: r.description || "",
  tags: normalizeTags(r.tags),
  author: r.author_name || "unknown",
  date: r.created_at || "",
  mod: r.mod_version || "",
  jsonUrl: API_DL(r.id), // â˜…ã“ã“é‡è¦ï¼šblockså–å¾—å…ˆ
  dl: 0 // ã¾ã è¨ˆæ¸¬ã—ã¦ãªã„ãªã‚‰0ã§OK
}));

        render();
      }catch(e){
        showError("ä¸€è¦§å–å¾—ã§ä¾‹å¤–ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n" + String(e && e.message ? e.message : e));
        grid.innerHTML = "";
      }
    }

    q.addEventListener("input", render);
    sort.addEventListener("change", render);
const THUMB_CACHE_VER = "v1"; // æç”»ãƒ­ã‚¸ãƒƒã‚¯å¤‰ãˆãŸã‚‰ä¸Šã’ã‚‹
const thumbCacheKey = (id)=> `mc_thumb_${THUMB_CACHE_VER}_${id}`;

async function loadJsonBlocks(it){
  if (!it.jsonUrl) return null;

  try{
    const r = await fetch(it.jsonUrl, { cache: "no-store" });
    console.log("[thumb] fetch", it.id, r.status, r.headers.get("content-type"), it.jsonUrl);

    if(!r.ok) {
      const t = await r.text().catch(()=>"(no text)");
      console.warn("[thumb] not ok", it.id, r.status, t.slice(0,200));
      return null;
    }

    const ct = (r.headers.get("content-type") || "").toLowerCase();
    if(!ct.includes("application/json")){
      const t = await r.text().catch(()=>"(no text)");
      console.warn("[thumb] not json content-type", it.id, ct, t.slice(0,200));
      return null;
    }

    const j = await r.json();
    if(!j || !Array.isArray(j.blocks)) {
      console.warn("[thumb] no blocks", it.id, j);
      return null;
    }
    return j.blocks;
  } catch(e){
    console.error("[thumb] exception", it.id, e);
    return null;
  }
}


function analyzeBlocks(blocks){
  let minX=Infinity,minY=Infinity,minZ=Infinity;
  let maxX=-Infinity,maxY=-Infinity,maxZ=-Infinity;
  for(const b of blocks){
    minX=Math.min(minX,b.dx); minY=Math.min(minY,b.dy); minZ=Math.min(minZ,b.dz);
    maxX=Math.max(maxX,b.dx); maxY=Math.max(maxY,b.dy); maxZ=Math.max(maxZ,b.dz);
  }
  return {minX,minY,minZ, sizeX:maxX-minX+1, sizeY:maxY-minY+1, sizeZ:maxZ-minZ+1};
}

function hashColor(id){
  let h=0;
  for(let i=0;i<id.length;i++) h=(h*31 + id.charCodeAt(i))|0;
  const r = 110 + (h & 90);
  const g = 110 + ((h>>8)&90);
  const b = 110 + ((h>>16)&90);
  return {r,g,b};
}

// â€œé¢â€ã§æãï¼šä¸Šé¢ï¼‹å·¦é¢ï¼‹å³é¢ï¼ˆè¶…è»½é‡ï¼‰
function drawIsoCube(ctx, x, y, z, s, col){
  // iso å¤‰æ›ï¼ˆx,zã§æ¨ªã€yã§é«˜ã•ï¼‰
  const sx = (x - z) * s;
  const sy = (x + z) * s * 0.5 - y * s;

  // è‰²ã‚’å°‘ã—ãšã¤å¤‰ãˆã¦ç«‹ä½“æ„Ÿ
  const top = `rgb(${Math.min(255,col.r+35)},${Math.min(255,col.g+35)},${Math.min(255,col.b+35)})`;
  const left= `rgb(${Math.max(0,col.r-10)},${Math.max(0,col.g-10)},${Math.max(0,col.b-10)})`;
  const right=`rgb(${Math.max(0,col.r-30)},${Math.max(0,col.g-30)},${Math.max(0,col.b-30)})`;

  // ä¸Šé¢ï¼ˆã²ã—å½¢ï¼‰
  ctx.fillStyle = top;
  ctx.beginPath();
  ctx.moveTo(sx, sy - s*0.5);
  ctx.lineTo(sx + s, sy);
  ctx.lineTo(sx, sy + s*0.5);
  ctx.lineTo(sx - s, sy);
  ctx.closePath();
  ctx.fill();

  // å·¦é¢
  ctx.fillStyle = left;
  ctx.beginPath();
  ctx.moveTo(sx - s, sy);
  ctx.lineTo(sx, sy + s*0.5);
  ctx.lineTo(sx, sy + s*0.5 + s);
  ctx.lineTo(sx - s, sy + s);
  ctx.closePath();
  ctx.fill();

  // å³é¢
  ctx.fillStyle = right;
  ctx.beginPath();
  ctx.moveTo(sx + s, sy);
  ctx.lineTo(sx, sy + s*0.5);
  ctx.lineTo(sx, sy + s*0.5 + s);
  ctx.lineTo(sx + s, sy + s);
  ctx.closePath();
  ctx.fill();
}

function renderThumbToCanvas(canvas, blocks){
  const ctx = canvas.getContext("2d");
  const w = canvas.width, h = canvas.height;

  // èƒŒæ™¯
  ctx.clearRect(0,0,w,h);
  const g = ctx.createLinearGradient(0,0,0,h);
  g.addColorStop(0,"rgba(37,99,235,.10)");
  g.addColorStop(1,"rgba(22,163,74,.08)");
  ctx.fillStyle = g;
  ctx.fillRect(0,0,w,h);

  const info = analyzeBlocks(blocks);

  // å·¨å¤§å¯¾ç­–ï¼šé–“å¼•ãï¼ˆãƒ–ãƒ­ãƒƒã‚¯æ•°ã«å¿œã˜ã¦å¯å¤‰ï¼‰
  let list = blocks;
  const n = blocks.length;
  const target = 12000; // ã‚µãƒ ãƒã¯ã“ã®ãã‚‰ã„ãŒé™ç•Œ
  if(n > target){
    const step = Math.ceil(n / target);
    list = blocks.filter((_,i)=>i%step===0);
  }

  // åã¾ã‚Šã‚¹ã‚±ãƒ¼ãƒ«ï¼ˆã–ã£ãã‚Šï¼‰
  const spanX = info.sizeX + info.sizeZ;
  const spanY = info.sizeY;
  const s = Math.max(2, Math.min(w/(spanX+6), h/(spanY+8)) * 1.6);

  // åŸç‚¹ã‚’ä¸­å¤®å¯„ã›
  const ox = w*0.5;
  const oy = h*0.78;

  // æç”»é †ï¼šå¥¥â†’æ‰‹å‰ãƒ»ä¸‹â†’ä¸Š ã£ã½ãï¼ˆç°¡æ˜“ï¼‰
  const sorted = [...list].sort((a,b)=>
    (a.dx+a.dz+a.dy) - (b.dx+b.dz+b.dy)
  );

  ctx.save();
  ctx.translate(ox, oy);

  for(const b of sorted){
    const x = b.dx - info.minX;
    const y = b.dy - info.minY;
    const z = b.dz - info.minZ;
    const col = hashColor(b.blockId);
    drawIsoCube(ctx, x, y, z, s, col);
  }
  ctx.restore();
}

async function hydrateThumbs(list){
  const canvases = [...document.querySelectorAll("canvas.thumb3d")];
  for(const c of canvases){
    const id = c.dataset.id;
    const cache = localStorage.getItem(thumbCacheKey(id));
    if(cache){
      // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚ã‚Œã°å³è¡¨ç¤ºï¼ˆimgã¨ã—ã¦æç”»ï¼‰
      const img = new Image();
      img.onload = ()=> c.getContext("2d").drawImage(img,0,0,c.width,c.height);
      img.src = cache;
      continue;
    }

    // å®Ÿãƒ‡ãƒ¼ã‚¿ãŒç„¡ã„ï¼ˆä»®ãƒ‡ãƒ¼ã‚¿ï¼‰ãªã‚‰ã‚¹ã‚­ãƒƒãƒ—
    const it = list.find(x=>x.id===id);
    if(!it) continue;

    const blocks = await loadJsonBlocks(it);
    if(!blocks) continue;

    renderThumbToCanvas(c, blocks);

    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜ï¼ˆã‚µã‚¤ã‚ºãŒå¤§ãã™ãã‚‹ã¨å¤±æ•—ã™ã‚‹ã®ã§tryï¼‰
    try{
      const png = c.toDataURL("image/png");
      localStorage.setItem(thumbCacheKey(id), png);
    }catch{}
  }
}

    // åˆå›ãƒ­ãƒ¼ãƒ‰
    loadFromApi();
  </script>
</body>
</html>
