<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MobCrafter Portal</title>
  <meta name="description" content="MobCrafterÁî®„É¶„Éã„ÉÉ„ÉàJSONÂÖ±Êúâ„Éù„Éº„Çø„É´„ÄÇÊ§úÁ¥¢„ÉªÊñ∞ÁùÄ„ÅßÊé¢„Åõ„Åæ„Åô„ÄÇ" />
  <style>
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e5e7eb;
      --brand:#2563eb;
      --brand2:#16a34a;
      --shadow: 0 10px 25px rgba(15,23,42,.08);
      --radius: 14px;
    }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    header{
      padding:24px 18px 12px;
      max-width: 1120px;
      margin:0 auto;
    }
    h1{
      margin:0;
      font-size:22px;
      letter-spacing:.2px;
    }
    .sub{
      margin-top:6px;
      color:var(--muted);
      font-size:13px;
      line-height:1.4;
    }
    .toolbar{
      max-width:1120px;
      margin:0 auto;
      padding:12px 18px 8px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .toolbar input, .toolbar select{
      border:1px solid var(--line);
      border-radius: 999px;
      padding:10px 12px;
      background:#fff;
      outline:none;
      font-size:14px;
    }
    .toolbar input{ min-width: 240px; flex: 1 1 240px; }
    .toolbar select{ flex: 0 0 auto; }

    .wrap{
      max-width:1120px;
      margin:0 auto;
      padding: 8px 18px 28px;
    }

    .err{
      display:none;
      background:#fff1f2;
      border:1px solid #fecdd3;
      color:#9f1239;
      padding:10px 12px;
      border-radius: 12px;
      white-space:pre-wrap;
      margin: 0 0 14px;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:14px;
    }
    @media (max-width: 980px){ .grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    @media (max-width: 640px){ .grid{ grid-template-columns: 1fr; } }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      min-height: 360px;
    }
    .thumbwrap{
      position:relative;
      background: linear-gradient(180deg, rgba(37,99,235,.10), rgba(22,163,74,.08));
    }
    canvas.thumb{
      width:100%;
      height:auto;
      display:block;
      border-bottom:1px solid var(--line);
    }
    .pill{
      position:absolute;
      top:10px;
      left:10px;
      display:flex;
      gap:8px;
      align-items:center;
    }
    .badge{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.8);
      border:1px solid rgba(148,163,184,.35);
      color:#0f172a;
      backdrop-filter: blur(6px);
    }
    .btn-dl{
      position:absolute;
      bottom:10px;
      left:10px;
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(37,99,235,.92);
      color:#fff;
      border:1px solid rgba(37,99,235,.10);
      text-decoration:none;
      backdrop-filter: blur(6px);
    }
    .btn-edit{
      position:absolute;
      bottom:10px;
      right:10px;
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(15,23,42,.82);
      color:#fff;
      border:1px solid rgba(15,23,42,.10);
      text-decoration:none;
      backdrop-filter: blur(6px);
    }
    .card-body{
      padding:12px 12px 14px;
    }
    .title{
      margin:0;
      font-size:15px;
      font-weight:700;
      line-height:1.25;
    }
    .meta{
      margin-top:8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-size:12px;
      color:var(--muted);
    }
    .meta .left{
      display:flex;
      gap:10px;
      align-items:center;
      min-width:0;
    }
    .meta .author{
      display:flex;
      gap:6px;
      align-items:center;
      min-width:0;
    }
    .meta .author span{
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width:120px;
      display:block;
    }
    .meta .dl{
      display:flex;
      gap:6px;
      align-items:center;
    }
    .tagline{
      margin-top:8px;
      font-size:12px;
      color:var(--muted);
      overflow:hidden;
      white-space:nowrap;
      text-overflow:ellipsis;
    }
    footer{
      margin-top:26px;
      text-align:center;
      font-size:12px;
      color:var(--muted);
    }

    .authbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      width:100%;
      margin-top:8px;
      padding-top:10px;
      border-top:1px dashed var(--line);
      color:var(--muted);
      font-size:12px;
    }
    .authbar .left{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      min-width:0;
    }
    .authbar code{
      background:rgba(148,163,184,.15);
      border:1px solid rgba(148,163,184,.25);
      padding:2px 6px;
      border-radius:999px;
      color:#0f172a;
    }
    .authbar .right{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .authbar a{
      color:var(--brand);
      text-decoration:none;
      border:1px solid rgba(37,99,235,.25);
      padding:6px 10px;
      border-radius:999px;
      background:#fff;
      white-space:nowrap;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .authbar a.primary{
      background:#2563eb;
      color:#fff;
      border-color:rgba(37,99,235,.10);
    }
    .mine{
      display:none;
      gap:8px;
      align-items:center;
      border:1px solid rgba(148,163,184,.35);
      padding:6px 10px;
      border-radius:999px;
      background:#fff;
    }
    .mine input{ margin:0; }
  </style>
</head>
<body>
<header>
  <h1>MobCrafter Portal</h1>
  <div class="sub">MobCrafterÁî®„É¶„Éã„ÉÉ„ÉàJSONÂÖ±Êúâ„Éù„Éº„Çø„É´„ÄÇÊ§úÁ¥¢„ÉªÊñ∞ÁùÄ„ÅßÊé¢„Åõ„Åæ„Åô„ÄÇ</div>

  <div class="authbar">
    <div class="left">
      <span>Login: <b id="authState">checking...</b></span>
      <span>Email: <code id="meEmail">-</code></span>
      <span class="mine" id="mineWrap"><input type="checkbox" id="mineOnly" /><label for="mineOnly">Ëá™ÂàÜ„ÅÆÊäïÁ®ø„ÅÆ„Åø</label></span>
    </div>
    <div class="right">
      <a id="authActionLink" href="#">...</a>
      <a id="postLink" class="primary" href="/submit.html">ÊäïÁ®ø</a>
      <a href="/admin.html" id="adminLink" style="display:none;">Admin</a>
    </div>
  </div>
</header>

<div class="toolbar">
  <input id="q" type="search" placeholder="Ê§úÁ¥¢Ôºö„Çø„Ç§„Éà„É´ / Ë™¨Êòé / „Çø„Ç∞" />
  <select id="sort">
    <option value="new" selected>Êñ∞ÁùÄ</option>
    <option value="dl">DLÊï∞</option>
    <option value="name">ÂêçÂâç</option>
  </select>
  <select id="yaw">
    <option value="0">Yaw 0¬∞</option>
    <option value="90">Yaw 90¬∞</option>
    <option value="180">Yaw 180¬∞</option>
    <option value="270" selected>Yaw 270¬∞</option>
  </select>
</div>

<main class="wrap">
  <div id="err" class="err"></div>
  <div id="grid" class="grid"></div>

  <footer>
    ¬© MobCrafter Portal
  </footer>
</main>

<script>
(() => {
  const API_WHOAMI = "/api/whoami";
  const API_PUBLIC_LIST = "/api/public/submissions";
  const API_MY_LIST = "/api/my/submissions";
  const API_JSON = (id) => `/api/public/submissions/${encodeURIComponent(id)}/json`;
  const API_DL   = (id) => `/api/public/submissions/${encodeURIComponent(id)}/download`;

  const whoamiNext = (nextPath) => `/api/login?next=${encodeURIComponent(nextPath || "/")}`;

  const authState = document.getElementById("authState");
  const authActionLink = document.getElementById("authActionLink");
  const meEmailEl = document.getElementById("meEmail");
  const adminLink = document.getElementById("adminLink");
  const postLink = document.getElementById("postLink");
  const mineWrap = document.getElementById("mineWrap");
  const mineOnly = document.getElementById("mineOnly");

  let meEmail = null;
  let meIsAdmin = false;
  let meUserId = null;

  async function loadWhoami(){
    try{
      const r = await fetch(API_WHOAMI, { cache:"no-store", credentials:"include" });
      if(!r.ok) throw new Error("whoami HTTP " + r.status);
      const j = await r.json();

      meEmail = j.email || null;
      meIsAdmin = !!j.is_admin;
      meUserId = j.user_id || j.userId || null;

      authState.textContent = "logged in";
      meEmailEl.textContent = meEmail || "-";

      authActionLink.textContent = "„É≠„Ç∞„Ç¢„Ç¶„Éà";
      authActionLink.className = "";
      authActionLink.href = "/api/logout";

      adminLink.style.display = meIsAdmin ? "inline-flex" : "none";
      postLink.href = "/submit.html";

      mineWrap.style.display = "inline-flex";
    }catch{
      authState.textContent = "unknown";
      authActionLink.textContent = "„É≠„Ç∞„Ç§„É≥";
      authActionLink.className = "";
      authActionLink.href = whoamiNext("/");
      postLink.href = whoamiNext("/submit.html");
      mineWrap.style.display = "none";
      meEmail = null;
      meIsAdmin = false;
      meUserId = null;
    }
  }

  let items = [];

  const grid = document.getElementById("grid");
  const q = document.getElementById("q");
  const sort = document.getElementById("sort");
  const yawUi = document.getElementById("yaw");
  const err = document.getElementById("err");

  function showError(msg){
    err.style.display = "block";
    err.textContent = msg;
  }
  function hideError(){
    err.style.display = "none";
    err.textContent = "";
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  function normalizeTags(t){
    if(!t) return [];
    if(Array.isArray(t)) return t.map(x=>String(x).trim()).filter(Boolean);
    return String(t).split(/[\s,]+/).map(x=>x.trim()).filter(Boolean);
  }

  function asDateIso(s){
    try{
      const d = new Date(s);
      if(Number.isNaN(d.getTime())) return null;
      return d.toISOString();
    }catch{
      return null;
    }
  }

  function resolveNo(row){
    const n = Number(row.submission_no ?? row.submissionNo ?? row.no ?? 0);
    return n || 0;
  }

  async function fetchUnitJson(id){
    const r = await fetch(API_JSON(id), { cache: "no-store" });
    if(!r.ok) throw new Error("json HTTP " + r.status);
    return await r.json();
  }

  // --- palette (submit „Å®Âêå„ÅòËâ≤Âë≥„Å´ÊèÉ„Åà„Çã) ---
  const PALETTE_URL = "/assets/palette.v1.json";
  const PALETTE_VER = "v1";
  const PALETTE_LS_KEY = `mcPalette:${PALETTE_VER}`;
  let PALETTE_MAP = null;

  function parseColorString(s){
    if(!s) return null;
    const v = String(s).trim();
    const hex = /^#([0-9a-f]{6})$/i.exec(v);
    if(hex){
      const n = parseInt(hex[1], 16);
      return { r:(n>>16)&255, g:(n>>8)&255, b:n&255, a:1 };
    }
    const rgba = /^rgba?\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})(?:\s*,\s*([0-9]*\.?[0-9]+))?\s*\)$/i.exec(v);
    if(rgba){
      const r = Math.max(0, Math.min(255, parseInt(rgba[1],10)));
      const g = Math.max(0, Math.min(255, parseInt(rgba[2],10)));
      const b = Math.max(0, Math.min(255, parseInt(rgba[3],10)));
      const a = rgba[4] == null ? 1 : Math.max(0, Math.min(1, parseFloat(rgba[4])));
      return {r,g,b,a};
    }
    return null;
  }

  async function loadPalette(){
    if(PALETTE_MAP) return PALETTE_MAP;
    try{
      const cached = localStorage.getItem(PALETTE_LS_KEY);
      if(cached){
        const obj = JSON.parse(cached);
        if(obj && typeof obj === "object"){
          PALETTE_MAP = obj;
          return PALETTE_MAP;
        }
      }
    }catch(e){}
    try{
      const r = await fetch(`${PALETTE_URL}?v=${encodeURIComponent(PALETTE_VER)}`, { cache:"no-store" });
      if(r.ok){
        const obj = await r.json();
        if(obj && typeof obj === "object"){
          PALETTE_MAP = obj;
          try{ localStorage.setItem(PALETTE_LS_KEY, JSON.stringify(obj)); }catch(e){}
          return PALETTE_MAP;
        }
      }
    }catch(e){}
    PALETTE_MAP = {};
    return PALETTE_MAP;
  }

  function paletteLookup(blockId){
    if(!PALETTE_MAP) return null;
    const k = String(blockId||"").trim().toLowerCase();
    return parseColorString(PALETTE_MAP[k]);
  }

  // submit.html „ÅÆËâ≤Âë≥ÔºàpaletteÂÑ™ÂÖà + Êó¢Â≠òIDÂêç„Åã„Çâ„ÅÆ„Éí„É•„Éº„É™„Çπ„ÉÜ„Ç£„ÉÉ„ÇØÔºâ
  function pickBaseColor(blockId){
    const p = paletteLookup(blockId);
    if(p) return p;

    const raw = String(blockId||"").toLowerCase();
    const id = raw.includes(":") ? raw.split(":")[1] : raw;

    if (id.includes("glass") || id.includes("ice")) return {r: 170, g: 210, b: 230, a: 0.55};
    if (id.includes("leaves") || id.includes("leaf") || id.includes("moss") || id.includes("vine") || id.includes("grass")) return {r: 90, g: 150, b: 90, a: 0.95};
    if (id.includes("log") || id.includes("wood") || id.includes("planks") || id.includes("bamboo")) return {r: 160, g: 125, b: 85, a: 0.95};
    if (id.includes("dirt") || id.includes("sand") || id.includes("gravel") || id.includes("clay") || id.includes("mud")) return {r: 160, g: 145, b: 110, a: 0.98};
    if (id.includes("stone") || id.includes("deepslate") || id.includes("andesite") || id.includes("diorite") || id.includes("granite") || id.includes("cobble") || id.includes("tuff") || id.includes("slate")) return {r: 140, g: 145, b: 155, a: 0.98};
    if (id.includes("iron") || id.includes("anvil") || id.includes("chain") || id.includes("rail") || id.includes("metal")) return {r: 170, g: 175, b: 185, a: 0.98};
    if (id.includes("copper") || id.includes("bronze")) return {r: 190, g: 120, b: 80, a: 0.98};
    if (id.includes("gold")) return {r: 210, g: 185, b: 90, a: 0.98};
    if (id.includes("diamond")) return {r: 120, g: 210, b: 220, a: 0.98};
    if (id.includes("emerald")) return {r: 70, g: 200, b: 120, a: 0.98};
    if (id.includes("lapis")) return {r: 70, g: 110, b: 200, a: 0.98};
    if (id.includes("redstone")) return {r: 190, g: 70, b: 70, a: 0.98};

    let h=0; for(let i=0;i<raw.length;i++) h=(h*31 + raw.charCodeAt(i))|0;
    return { r:120 + (h & 70), g:120 + ((h>>8)&70), b:120 + ((h>>16)&70), a:0.98 };
  }

  function drawIso(canvas, blocks, yawDeg){
    const ctx = canvas.getContext("2d");
    const w = canvas.width, h = canvas.height;
    ctx.clearRect(0,0,w,h);

    if(!Array.isArray(blocks) || blocks.length === 0){
      ctx.fillStyle = "rgba(15,23,42,.35)";
      ctx.font = "12px sans-serif";
      ctx.fillText("No blocks", 10, 20);
      return;
    }

    const yaw = (yawDeg||0) * Math.PI/180;

    const pts = blocks.map(b => {
      const x = Number(b.dx||0), y=Number(b.dy||0), z=Number(b.dz||0);
      const rx =  x*Math.cos(yaw) - z*Math.sin(yaw);
      const rz =  x*Math.sin(yaw) + z*Math.cos(yaw);
      const sx = (rx - rz) * 6;
      const sy = (rx + rz) * 3 - y * 6;
      return { sx, sy, bid: String(b.blockId||"") };
    });

    let minX=1e9,maxX=-1e9,minY=1e9,maxY=-1e9;
    for(const p of pts){
      minX=Math.min(minX,p.sx); maxX=Math.max(maxX,p.sx);
      minY=Math.min(minY,p.sy); maxY=Math.max(maxY,p.sy);
    }
    const cx = (minX+maxX)/2;
    const cy = (minY+maxY)/2;

    const scale = Math.min(
      (w-30)/(maxX-minX+20),
      (h-30)/(maxY-minY+20)
    );

    pts.sort((a,b)=>a.sy-b.sy);

    for(const p of pts){
      const x = (p.sx - cx) * scale + w/2;
      const y = (p.sy - cy) * scale + h/2;

      const col = pickBaseColor(p.bid);
      const a = (col.a == null ? 1 : col.a);
      ctx.fillStyle = `rgba(${col.r},${col.g},${col.b},${a})`;
      ctx.fillRect(x-4, y-4, 8, 8);
      ctx.strokeStyle = "rgba(15,23,42,.15)";
      ctx.strokeRect(x-4, y-4, 8, 8);
    }
  }

  function goUnit(it){
    if (it.no) location.href = `/unit.html?id=${encodeURIComponent(String(it.no))}`;
    else location.href = `/unit.html?id=${encodeURIComponent(String(it.id))}`;
  }

  function renderCard(it){
    const card = document.createElement("article");
    card.className = "card";

    const canEdit = !!(meUserId && it.authorId && String(it.authorId) === String(meUserId));

    card.innerHTML = `
      <div class="thumbwrap">
        <canvas class="thumb" width="480" height="280"></canvas>
        <div class="pill">
          <span class="badge">${escapeHtml(it.mod || "Forge")}</span>
        </div>
        <a class="btn-dl" href="${escapeHtml(API_DL(it.id))}" download>Download</a>
        ${canEdit ? `<a class="btn-edit" href="#">Á∑®ÈõÜ</a>` : ``}
      </div>
      <div class="card-body">
        <p class="title">${escapeHtml(it.name)}</p>
        <div class="meta">
          <div class="left">
            <div class="author">üë§ <span>${escapeHtml(it.author || "unknown")}</span></div>
            <div class="dl">‚¨á ${escapeHtml(it.dl ?? 0)}</div>
          </div>
          <div class="time">üïí ${escapeHtml(it.createdText)}</div>
        </div>
        <div class="tagline">${escapeHtml(it.tags.join(" / "))}</div>
      </div>
    `;

    card.addEventListener("click", (e) => {
      const a = e.target && e.target.closest ? e.target.closest("a") : null;
      if (a) return;
      goUnit(it);
    });

    const editBtn = card.querySelector(".btn-edit");
    if (editBtn) {
      editBtn.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        goUnit(it);
      });
    }

    const canvas = card.querySelector("canvas.thumb");
    (async () => {
      try{
        const j = await fetchUnitJson(it.id);
        await loadPalette();
        const yaw = Number(yawUi.value || 270);
        drawIso(canvas, j.blocks, yaw);
      }catch{}
    })();

    return card;
  }

  function applyFilter(){
    const kw = String(q.value||"").trim().toLowerCase();

    let arr = items.slice();

    if(kw){
      arr = arr.filter(it => {
        const hay = (it.name + " " + it.desc + " " + it.tags.join(" ")).toLowerCase();
        return hay.includes(kw);
      });
    }

    const mode = String(sort.value||"new");
    if(mode === "dl"){
      arr.sort((a,b)=> (b.dl||0)-(a.dl||0));
    }else if(mode === "name"){
      arr.sort((a,b)=> String(a.name).localeCompare(String(b.name)));
    }else{
      arr.sort((a,b)=> (b.created||"").localeCompare(a.created||""));
    }

    grid.innerHTML = "";
    for(const it of arr){
      grid.appendChild(renderCard(it));
    }
  }

  async function fetchList(useMine){
    const url = useMine ? API_MY_LIST : API_PUBLIC_LIST;
    const r = await fetch(url, { cache:"no-store", credentials:"include" });
    const text = await r.text().catch(()=> "");
    let data = null;
    try { data = JSON.parse(text); } catch { data = null; }

    if(!r.ok){
      throw new Error(`list HTTP ${r.status}\n${text ? ("body: " + text.slice(0,240)) : ""}`);
    }

    // my/submissions „ÅØ {ok:true, items:[...]}„ÄÅpublic „ÅØ {items:[...]}
    const arr = (data && Array.isArray(data.items)) ? data.items : [];
    return arr;
  }

  async function load(){
    hideError();
    grid.innerHTML = "";
    try{
      const useMine = !!(mineOnly && mineOnly.checked && meUserId);
      const arr = await fetchList(useMine);

      items = arr.map(r => {
        const created = asDateIso(r.created_at || r.createdAt || r.created);
        const createdText = created ? created.slice(0,10) : "";
        const tags = normalizeTags(r.tags);
        const no = resolveNo(r);

        return {
          id: r.id ?? r.submission_id ?? r.submissionId ?? "",
          no,
          name: r.title ?? r.name ?? "(no title)",
          desc: r.description ?? r.desc ?? "",
          tags,
          dl: r.downloads ?? r.dl ?? 0,
          author: r.author_email ?? r.author ?? "unknown",
          authorId: r.author_id ?? r.authorId ?? null,
          mod: r.mod_version ?? r.mod ?? "Forge",
          created: created || "",
          createdText,
        };
      });

      applyFilter();
    }catch(e){
      showError(String(e?.message || e));
    }
  }

  q.addEventListener("input", () => applyFilter());
  sort.addEventListener("change", () => applyFilter());
  yawUi.addEventListener("change", () => applyFilter());
  if (mineOnly) mineOnly.addEventListener("change", () => load());

  loadWhoami().finally(() => load());
})();
</script>
</body>
</html>
