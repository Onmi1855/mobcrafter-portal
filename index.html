<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MobCrafter Portal</title>
  <meta name="description" content="MobCrafterç”¨ãƒ¦ãƒ‹ãƒƒãƒˆJSONå…±æœ‰ãƒãƒ¼ã‚¿ãƒ«ã€‚æ¤œç´¢ãƒ»æ–°ç€ã§æ¢ã›ã¾ã™ã€‚" />
  <style>
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e5e7eb;
      --brand:#2563eb;
      --brand2:#16a34a;
      --shadow: 0 10px 25px rgba(15,23,42,.08);
      --radius: 16px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Yu Gothic", "Meiryo", sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    header{
      position:sticky;
      top:0;
      z-index:50;
      background:rgba(246,248,251,.85);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .wrap{
      max-width: 1120px;
      margin: 0 auto;
      padding: 16px 16px;
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      text-decoration:none;
      color:inherit;
    }
    .logo{
      width:28px;height:28px;border-radius:10px;
      background:linear-gradient(135deg,#60a5fa,#a78bfa);
      box-shadow:0 6px 16px rgba(37,99,235,.25);
    }
    .brand b{ font-size:15px; }
    .brand small{ display:block; font-size:12px; color:var(--muted); margin-top:1px; }

    .nav{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .pill{
      border:1px solid var(--line);
      background:#fff;
      padding:8px 12px;
      border-radius:999px;
      font-size:13px;
      cursor:pointer;
      text-decoration:none;
      color:inherit;
    }
    .pill.primary{
      background:var(--brand);
      border-color:var(--brand);
      color:#fff;
    }

    main{ padding: 18px 0 40px; }

    .hero{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
      margin-top: 8px;
      align-items:start;
    }
    .panel{
      background:var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .panel h2{
      margin:0 0 10px;
      font-size:14px;
    }
    .muted{ color:var(--muted); font-size:12px; line-height:1.5; }

    .controls{
      display:grid;
      grid-template-columns: 1fr 140px;
      gap:10px;
      margin-top:10px;
    }
    input[type="search"], select{
      width:100%;
      border:1px solid var(--line);
      border-radius: 12px;
      padding:10px 12px;
      font-size:14px;
      outline:none;
      background:#fff;
    }
    .row2{
      display:grid;
      grid-template-columns: 140px 1fr;
      gap:10px;
      margin-top:10px;
    }

    .grid{
      margin-top: 14px;
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:14px;
    }
    @media(max-width: 980px){
      .hero{ grid-template-columns: 1fr; }
      .grid{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    }
    @media(max-width: 640px){
      .grid{ grid-template-columns: 1fr; }
      .controls{ grid-template-columns: 1fr; }
      .row2{ grid-template-columns: 1fr; }
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .thumb{
      position:relative;
      height: 140px;
      background: linear-gradient(180deg,#dbeafe, #f8fafc);
    }
    .thumb canvas, .thumb img{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      display:block;
    }
    .badge{
      position:absolute;
      top:10px;
      left:10px;
      font-size:12px;
      padding:4px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.9);
      border:1px solid var(--line);
      color: #1f2937;
    }
    .btn-dl{
      position:absolute;
      top:10px;
      right:10px;
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      background: rgba(37,99,235,.95);
      color:#fff;
      text-decoration:none;
      box-shadow: 0 10px 20px rgba(37,99,235,.25);
    }
    .card-body{
      padding: 12px 12px 10px;
    }
    .title{
      font-weight:700;
      font-size:14px;
      margin:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .meta{
      margin-top:8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      color:var(--muted);
      font-size:12px;
    }
    .meta .left{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .meta .author{
      display:flex;
      align-items:center;
      gap:6px;
      min-width:0;
    }
    .meta .author span{
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width: 130px;
    }

    .error{
      margin-top: 10px;
      background:#fee2e2;
      border:1px solid #fecaca;
      color:#7f1d1d;
      border-radius: 12px;
      padding:10px 12px;
      white-space:pre-wrap;
      display:none;
    }

    footer{
      margin-top: 20px;
      color:var(--muted);
      font-size:12px;
      text-align:center;
    }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <a class="brand" href="/">
        <div class="logo"></div>
        <div>
          <b>MobCrafter Portal</b>
          <small>ãƒ¦ãƒ‹ãƒƒãƒˆJSONå…±æœ‰</small>
        </div>
      </a>
      <nav class="nav">
        <a class="pill" href="/">æ–°ç€</a>
        <a class="pill" href="/popular.html">äººæ°—</a>
        <a class="pill" href="/submit.html">æŠ•ç¨¿</a>
        <a class="pill primary" href="/howto.html">ä½¿ã„æ–¹</a>
      </nav>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="hero">
    <section class="panel">
      <h2>æ¢ã™</h2>
      <div class="muted">
        ã‚¿ã‚¤ãƒˆãƒ« / èª¬æ˜ / ã‚¿ã‚°ã§æ¤œç´¢ã§ãã¾ã™ã€‚ã‚µãƒ ãƒã¯ç°¡æ˜“3Dæç”»ï¼ˆè‰²ã¯ palette è¾æ›¸å„ªå…ˆï¼‰ã€‚
      </div>
      <div class="controls">
        <input id="q" type="search" placeholder="æ¤œç´¢ï¼ˆä¾‹ï¼šsephiroth / boss / swordï¼‰" />
        <select id="sort">
          <option value="new" selected>æ–°ç€é †</option>
          <option value="popular">äººæ°—é †</option>
        </select>
      </div>
      <div class="row2">
        <select id="yaw">
          <option value="270" selected>Yawè£œæ­£ +270Â°</option>
          <option value="0">Yawè£œæ­£ 0Â°</option>
          <option value="90">Yawè£œæ­£ +90Â°</option>
          <option value="180">Yawè£œæ­£ +180Â°</option>
        </select>
        <div class="muted">ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°ãƒšãƒ¼ã‚¸ã¸ï¼ˆ/u/:idï¼‰</div>
      </div>
      <div id="err" class="error"></div>
    </section>

    <aside class="panel">
      <h2>è‰²ãŒâ€œã¡ã‚ƒã‚“ã¨ã™ã‚‹â€ä»•çµ„ã¿</h2>
      <div class="muted">
        <code>/assets/palette.v1.json</code>ï¼ˆBlockIdâ†’è‰²ï¼‰ã‚’æœ€å„ªå…ˆã§ä½¿ç”¨ã—ã¾ã™ã€‚<br/>
        è¾æ›¸ã«ç„¡ã„ãƒ–ãƒ­ãƒƒã‚¯ã¯ã‚«ãƒ†ã‚´ãƒªè‰²â†’æ§ãˆã‚ãƒãƒƒã‚·ãƒ¥è‰²ã§ç ´ç¶»ã‚’é˜²ãã¾ã™ã€‚
      </div>
    </aside>
  </div>

  <section id="grid" class="grid"></section>

  <footer>Â© 2025 MobCrafter Portal â€” MVP</footer>
</main>

<script>
(() => {
  // ====== API (approved only) ======
  const API_LIST = "https://api.mobcrafter.net/api/public/submissions";
  const API_DL   = (id) => `https://api.mobcrafter.net/api/public/submissions/${id}/download`;

  // ç”»é¢å´ã®çŠ¶æ…‹
  let items = [];

  const grid = document.getElementById("grid");
  const q = document.getElementById("q");
  const sort = document.getElementById("sort");
  const yawUi = document.getElementById("yaw");
  const err = document.getElementById("err");

  function showError(msg){
    err.style.display = "block";
    err.textContent = msg;
  }
  function hideError(){
    err.style.display = "none";
    err.textContent = "";
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function normalizeTags(tags){
    if(!tags) return [];
    if(Array.isArray(tags)) return tags.map(t=>String(t).trim()).filter(Boolean);
    return String(tags).split(/[,\s]+/).map(t=>t.trim()).filter(Boolean);
  }

  function getYawFix(){
    const v = Number(yawUi.value || 270);
    return isFinite(v) ? v : 270;
  }

  function sortItems(list){
    const mode = sort.value;
    if(mode === "popular"){
      return [...list].sort((a,b)=> (b.downloads||0) - (a.downloads||0));
    }
    return [...list].sort((a,b)=> (b.ts||0) - (a.ts||0));
  }

  function filterItems(list){
    const query = (q.value || "").trim().toLowerCase();
    if(!query) return list;
    const terms = query.split(/\s+/).filter(Boolean);
    return list.filter(it=>{
      const hay = (it.name + " " + it.desc + " " + it.tags.join(" ")).toLowerCase();
      return terms.every(t=> hay.includes(t));
    });
  }

  function render(){
    const list = sortItems(filterItems(items));
    if(list.length === 0){
      grid.innerHTML = "";
      return;
    }

    // ã‚«ãƒ¼ãƒ‰å†…ã«ä½™è¨ˆãª <a> ã‚’å¢—ã‚„ã•ãªã„ï¼ˆãƒªãƒ³ã‚¯ã‚’åˆæ³•ã«ç½®ããŸã‚ï¼‰
    grid.innerHTML = list.map(it => `
      <div class="card item" data-id="${escapeHtml(it.id)}" data-no="${escapeHtml(String(it.no || ""))}" title="${escapeHtml(it.name)}">
        <div class="thumb">
          <canvas class="thumb3d" data-id="${escapeHtml(it.id)}" width="360" height="140"
            style="image-rendering:auto"></canvas>
          <span class="badge">${escapeHtml(it.mod || "Forge")}</span>
          <a class="btn-dl" href="${escapeHtml(API_DL(it.id))}" download>Download</a>
        </div>
        <div class="card-body">
          <p class="title">${escapeHtml(it.name)}</p>
          <div class="meta">
            <div class="left">
              <div class="author">ğŸ‘¤ <span>${escapeHtml(it.author)}</span></div>
              <div>â¬‡ï¸ ${escapeHtml(it.downloads || 0)}</div>
            </div>
            <div title="${escapeHtml(it.date)}">ğŸ•’</div>
          </div>
        </div>
      </div>
    `).join("");

    // ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°ã¸
    grid.querySelectorAll(".card.item").forEach(card=>{
      card.addEventListener("click", (ev)=>{
        // Downloadã‚¯ãƒªãƒƒã‚¯ã¯ã‚«ãƒ¼ãƒ‰é·ç§»ã•ã›ãªã„
        const a = ev.target && ev.target.closest ? ev.target.closest("a") : null;
        if(a) return;

        const id = card.getAttribute("data-id");
        const no = Number(card.getAttribute("data-no") || 0);
        if(no) location.href = `/u/${no}`;
        else if(id) location.hash = `unit-${id}`; // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      });
    });

    // â˜…HTMLã§canvasä½œã£ãŸç›´å¾Œã«ã‚µãƒ ãƒç”Ÿæˆï¼ˆé‡ã„ã®ã§idleå„ªå…ˆï¼‰
    scheduleHydrate(list);
  }

  async function loadList(){
    hideError();
    try{
      const r = await fetch(API_LIST, { cache: "no-store" });
      if(!r.ok){
        showError("ä¸€è¦§å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nHTTP " + r.status);
        return;
      }
      const data = await r.json();
      const arr = Array.isArray(data) ? data : (data.items || []);

      items = arr.map(r => ({
        id: String(r.id),
        // è©³ç´°ãƒšãƒ¼ã‚¸URLç”¨ã®é€šã—ç•ªå·ï¼ˆ/u/:noï¼‰ã€‚APIãŒè¿”ã™ submission_no ã‚’ä½¿ã†
        no: Number(r.submission_no ?? r.submissionNo ?? r.no ?? 0),
        name: r.title || r.name || "Untitled",
        desc: r.description || "",
        tags: normalizeTags(r.tags),
        author: r.author_name || "unknown",
        date: r.created_at || "",
        ts: Date.parse(r.created_at || "") || 0,
        mod: r.mod_version || "Forge",
        downloads: Number(r.download_count || 0),
      }));

      render();
    }catch(e){
      showError("ä¸€è¦§å–å¾—ã§ä¾‹å¤–ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n" + String(e && e.message ? e.message : e));
      grid.innerHTML = "";
    }
  }

  q.addEventListener("input", render);
  sort.addEventListener("change", render);
  yawUi.addEventListener("change", () => {
    // yawå¤‰æ›´ã¯æç”»ã ã‘æ›´æ–°
    scheduleHydrate(sortItems(filterItems(items)));
  });

  // =========================
  // 3D thumb (index engine v3 + palette)
  // =========================

  // è»½é‡ï¼š1ãƒ•ãƒ¬ãƒ¼ãƒ ã«æç”»ã—ã™ããªã„
  let hydrateQueue = [];
  let hydrating = false;

  function scheduleHydrate(list){
    hydrateQueue = list.map(it=>it.id);
    if(!hydrating){
      hydrating = true;
      requestIdleCallback?.(hydrateTick, { timeout: 800 }) || setTimeout(hydrateTick, 30);
    }
  }

  async function hydrateTick(){
    try{
      const ids = hydrateQueue.splice(0, 6); // 1å›ã‚ãŸã‚Šæœ€å¤§6æš
      if(ids.length === 0){
        hydrating = false;
        return;
      }
      const yawFix = getYawFix();
      for(const id of ids){
        const canvas = document.querySelector(`canvas.thumb3d[data-id="${CSS.escape(id)}"]`);
        if(!canvas) continue;
        await renderThumb(canvas, id, yawFix);
      }
    }finally{
      // æ¬¡
      requestIdleCallback?.(hydrateTick, { timeout: 800 }) || setTimeout(hydrateTick, 30);
    }
  }

  // ----- palette -----
  let palette = null;
  async function loadPalette(){
    if(palette) return palette;
    try{
      const r = await fetch("/assets/palette.v1.json", { cache: "force-cache" });
      if(r.ok){
        palette = await r.json();
      }else{
        palette = {};
      }
    }catch(_){
      palette = {};
    }
    return palette;
  }

  function hexToRgb(hex){
    const s = String(hex||"").replace("#","");
    if(s.length === 3){
      const r = parseInt(s[0]+s[0],16);
      const g = parseInt(s[1]+s[1],16);
      const b = parseInt(s[2]+s[2],16);
      return [r,g,b,255];
    }
    if(s.length === 6){
      const r = parseInt(s.slice(0,2),16);
      const g = parseInt(s.slice(2,4),16);
      const b = parseInt(s.slice(4,6),16);
      return [r,g,b,255];
    }
    return [120,120,120,255];
  }

  function hashColor(str){
    // å®‰å®šã—ãŸæ§ãˆã‚è‰²
    let h=2166136261;
    for(let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h,16777619);
    }
    const r = 80 + (h & 0x7F);
    const g = 80 + ((h>>>8) & 0x7F);
    const b = 80 + ((h>>>16) & 0x7F);
    return [r,g,b,255];
  }

  function isTransparentBlockId(blockId){
    const s = String(blockId||"").toLowerCase();
    // MVPï¼šå³å¯†å†ç¾ã—ãªã„ã€‚è»½é‡ã®ãŸã‚ã€Œè¦‹ãŸç›®ãŒé€ã‘ãã†ã€ã ã‘åŠé€æ˜
    return s.includes("glass") || s.includes("pane") || s.includes("slab") || s.includes("stairs");
  }

  function colorForBlock(blockId, pal){
    const key = String(blockId||"");
    const found = pal && (pal[key] || pal[key.toLowerCase()]);
    if(found) return hexToRgb(found);
    return hashColor(key);
  }

  // ----- blocks fetch -----
  async function fetchUnitJson(id){
    // ã„ã¾ã¯ download API ã‹ã‚‰å–ã‚‹ï¼ˆè»½é‡ï¼‰
    const r = await fetch(API_DL(id), { cache: "no-store" });
    if(!r.ok) throw new Error("download HTTP " + r.status);
    return await r.json();
  }

  // ----- render engine (ç°¡æ˜“ã‚¢ã‚¤ã‚½ãƒ¡) -----
  async function renderThumb(canvas, id, yawFix){
    const ctx2 = canvas.getContext("2d");
    if(!ctx2) return;

    const pal = await loadPalette();
    const unit = await fetchUnitJson(id);
    const blocks = Array.isArray(unit.blocks) ? unit.blocks : [];
    if(blocks.length === 0){
      ctx2.clearRect(0,0,canvas.width,canvas.height);
      return;
    }

    // bbox
    let minX=1e9,minY=1e9,minZ=1e9;
    let maxX=-1e9,maxY=-1e9,maxZ=-1e9;
    for(const b of blocks){
      const x = b.dx|0, y=b.dy|0, z=b.dz|0;
      if(x<minX) minX=x; if(y<minY) minY=y; if(z<minZ) minZ=z;
      if(x>maxX) maxX=x; if(y>maxY) maxY=y; if(z>maxZ) maxZ=z;
    }
    const sizeX = (maxX-minX+1);
    const sizeY = (maxY-minY+1);
    const sizeZ = (maxZ-minZ+1);

    // --- scale stabilizeï¼ˆã‚ãªãŸã®æ–¹é‡ã«æ²¿ã£ã¦è»½é‡ã«ï¼‰ ---
    const padX = 6;
    const padY = 10;
    const spanXZ = sizeX + sizeZ;
    const spanY  = sizeY;

    const k = 6.2; // ä¿‚æ•°ï¼ˆæç”»å“è³ªã¯å¤‰ãˆãšã«è¦–èªæ€§ã‚’ç¢ºä¿ï¼‰
// --- scale stabilizeï¼ˆæ‹¡å¤§ã—ã™ãé˜²æ­¢ï¼‰ ---
const w = canvas.width;
const h = canvas.height;

// spanXZ / spanY ã¯ã‚ãªãŸã®ç¾çŠ¶ã‚³ãƒ¼ãƒ‰ã®ã¾ã¾ã§OK
// ï¼ˆconst spanXZ = sizeX + sizeZ; const spanY = sizeY;ï¼‰
const s = Math.max(1.6, Math.min(w/(spanXZ+6), h/(spanY+10)) * 1.6);

    // iso basis
    const yaw = ((yawFix % 360) + 360) % 360;

    function rot(x,z){
      // 90åº¦åˆ»ã¿ã®ã¿ï¼ˆè»½é‡ï¼‰
      const t = ((yaw/90)|0) % 4;
      if(t===0) return [x,z];
      if(t===1) return [-z,x];
      if(t===2) return [-x,-z];
      return [z,-x];
    }

    // projected positions
    const ox = canvas.width/2;
    const oy = canvas.height*0.72;

    function proj(x,y,z){
      // ç°¡æ˜“ã‚¢ã‚¤ã‚½ãƒ¡
      const [rx,rz] = rot(x,z);
      const px = (rx - rz) * 0.9;
      const py = (rx + rz) * 0.45 - y*1.2;
      return [ox + px*s, oy + py*s];
    }

    ctx2.clearRect(0,0,canvas.width,canvas.height);

    // sort: y -> x+z for stable
    const sorted = blocks.slice().sort((a,b)=>{
      const ay=a.dy|0, by=b.dy|0;
      if(ay!==by) return ay-by;
      const as=(a.dx|0)+(a.dz|0);
      const bs=(b.dx|0)+(b.dz|0);
      return as-bs;
    });

    // draw blocks as 2D cubes (very simplified)
    for(const b of sorted){
      const x=(b.dx|0)-minX;
      const y=(b.dy|0)-minY;
      const z=(b.dz|0)-minZ;
      const blockId = b.blockId || b.block_id || b.id || "";
      const col = colorForBlock(blockId, pal);
      const alpha = isTransparentBlockId(blockId) ? 160 : 255;

      const [cx,cy] = proj(x,y,z);
      // cube faces (2D fake)
      const w = s*0.95;
      const h = s*0.55;

      // top
      ctx2.fillStyle = `rgba(${col[0]},${col[1]},${col[2]},${alpha/255})`;
      ctx2.beginPath();
      ctx2.moveTo(cx, cy - h);
      ctx2.lineTo(cx + w, cy - h*0.2);
      ctx2.lineTo(cx, cy + h*0.6);
      ctx2.lineTo(cx - w, cy - h*0.2);
      ctx2.closePath();
      ctx2.fill();

      // side
      ctx2.fillStyle = `rgba(${Math.max(0,col[0]-20)},${Math.max(0,col[1]-20)},${Math.max(0,col[2]-20)},${alpha/255})`;
      ctx2.beginPath();
      ctx2.moveTo(cx, cy + h*0.6);
      ctx2.lineTo(cx + w, cy - h*0.2);
      ctx2.lineTo(cx + w, cy + h*1.4);
      ctx2.lineTo(cx, cy + h*2.2);
      ctx2.closePath();
      ctx2.fill();

      // other side
      ctx2.fillStyle = `rgba(${Math.max(0,col[0]-35)},${Math.max(0,col[1]-35)},${Math.max(0,col[2]-35)},${alpha/255})`;
      ctx2.beginPath();
      ctx2.moveTo(cx, cy + h*0.6);
      ctx2.lineTo(cx - w, cy - h*0.2);
      ctx2.lineTo(cx - w, cy + h*1.4);
      ctx2.lineTo(cx, cy + h*2.2);
      ctx2.closePath();
      ctx2.fill();
    }
  }

  // start
  loadList();
})();
</script>
</body>
</html>
