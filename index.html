<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MobCrafter Portal</title>
  <meta name="description" content="MobCrafterç”¨ãƒ¦ãƒ‹ãƒƒãƒˆJSONå…±æœ‰ãƒãƒ¼ã‚¿ãƒ«ã€‚æ¤œç´¢ãƒ»æ–°ç€ã§æ¢ã›ã¾ã™ã€‚" />
  <style>
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e5e7eb;
      --brand:#2563eb;
      --brand2:#16a34a;
      --shadow: 0 10px 25px rgba(15,23,42,.08);
      --radius: 16px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    a{ color: inherit; text-decoration: none; }
    header{
      position: sticky;
      top: 0;
      z-index: 50;
      background: rgba(246,248,251,.92);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid var(--line);
    }
    .headerIn{
      max-width: 1120px;
      margin: 0 auto;
      padding: 14px 18px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 14px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:800;
    }
    .logo{
      width:34px; height:34px; border-radius:12px;
      background: linear-gradient(135deg, rgba(37,99,235,.25), rgba(22,163,74,.25));
      border: 1px solid var(--line);
      box-shadow: 0 8px 18px rgba(15,23,42,.08);
    }
    .brand small{ display:block; font-weight:600; color:var(--muted); margin-top:2px; }
    .nav{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      border: 1px solid var(--line);
      background: #fff;
      padding: 9px 12px;
      border-radius: 12px;
      font-size: 13px;
      cursor: pointer;
      box-shadow: 0 1px 0 rgba(15,23,42,.03);
    }
    .btn.primary{
      background: var(--brand);
      border-color: var(--brand);
      color: #fff;
    }

    main{ max-width:1120px; margin:0 auto; padding: 14px 18px 28px; }

    .hero{
      margin-top: 10px;
      display:grid;
      grid-template-columns: 1.3fr 1fr;
      gap: 14px;
    }
    @media (max-width: 980px){ .hero{ grid-template-columns: 1fr; } }

    .panel{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .panel h2{ margin: 0 0 6px; font-size: 16px; }
    .panel p{ margin: 0; color: var(--muted); font-size: 13px; line-height: 1.55; }

    .controls{
      margin-top: 12px;
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    input[type="text"], select{
      padding: 10px 12px;
      border: 1px solid var(--line);
      border-radius: 12px;
      background:#fff;
      font-size: 14px;
      outline: none;
      box-shadow: 0 1px 0 rgba(15,23,42,.03);
    }
    #q{ flex:1; min-width: 240px; }
    #sort{ min-width: 160px; }
    #yaw{ min-width: 190px; }

    #err{
      display:none;
      margin-top: 12px;
      padding: 10px 12px;
      border: 1px solid #fecaca;
      background: #fff1f2;
      color: #991b1b;
      border-radius: 12px;
      font-size: 13px;
      white-space: pre-wrap;
    }

    .grid{
      margin-top: 14px;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 14px;
    }
    @media (max-width: 980px){ .grid{ grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 640px){ .grid{ grid-template-columns: 1fr; } }

    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      min-height: 240px;
      cursor: pointer;
    }
    .thumb{
      position: relative;
      height: 140px;
      background: linear-gradient(180deg, rgba(37,99,235,.10), rgba(22,163,74,.08));
      border-bottom: 1px solid var(--line);
    }
    .thumb canvas{
      display:block;
      width:100%;
      height:140px;
    }
    .badgeRow{
      position:absolute;
      inset: auto 12px 12px 12px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      pointer-events: none; /* â† ã“ã“é‡è¦ï¼šã‚«ãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯ã‚’é‚ªé­”ã—ãªã„ */
    }
    .badge{
      pointer-events: auto; /* ãŸã ã—Downloadã ã‘ã¯ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã«ã™ã‚‹ */
      display:inline-flex;
      align-items:center;
      gap: 6px;
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.92);
      color: var(--text);
      box-shadow: 0 8px 18px rgba(15,23,42,.08);
    }
    .badgeLink{
      pointer-events: auto;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      background: var(--brand);
      color:#fff;
      border: 1px solid var(--brand);
      box-shadow: 0 8px 18px rgba(15,23,42,.10);
    }
    .content{ padding: 12px 12px 14px; display:flex; flex-direction: column; gap: 8px; }
    .name{ font-size: 15px; font-weight: 800; }
    .desc{ margin:0; color: var(--muted); font-size: 13px; line-height: 1.45; min-height: 38px; }
    .meta{ display:flex; gap: 10px; flex-wrap:wrap; color: var(--muted); font-size: 12px; }
    footer{
      margin-top: 18px;
      color: var(--muted);
      font-size: 12px;
      text-align: center;
      padding: 10px 0 2px;
    }
  </style>
</head>
<body>

<header>
  <div class="headerIn">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <div>MobCrafter Portal</div>
        <small>ãƒ¦ãƒ‹ãƒƒãƒˆJSONå…±æœ‰</small>
      </div>
    </div>
    <nav class="nav">
      <a class="btn" href="#latest">æ–°ç€</a>
      <a class="btn" href="#popular">äººæ°—</a>
      <a class="btn" href="/submit">æŠ•ç¨¿</a>
      <a class="btn primary" href="#guide">ä½¿ã„æ–¹</a>
    </nav>
  </div>
</header>

<main>
  <section class="hero">
    <div class="panel">
      <h2>æ¢ã™</h2>
      <p>ã‚¿ã‚¤ãƒˆãƒ« / èª¬æ˜ / ã‚¿ã‚°ã§æ¤œç´¢ã§ãã¾ã™ã€‚ã‚µãƒ ãƒã¯ç°¡æ˜“3Dæç”»ï¼ˆè‰²ã¯ palette è¾æ›¸å„ªå…ˆï¼‰ã€‚</p>

      <div class="controls">
        <input id="q" type="text" placeholder="æ¤œç´¢ï¼ˆä¾‹ï¼šsephiroth / boss / swordï¼‰" />
        <select id="sort">
          <option value="new">æ–°ç€é †</option>
          <option value="old">å¤ã„é †</option>
          <option value="dl">DLå¤šã„é †</option>
        </select>

        <select id="yaw" title="ä½œå“ã”ã¨ã®æ­£é¢ã‚ºãƒ¬è£œæ­£ï¼ˆ90åº¦åˆ»ã¿ï¼‰">
          <option value="0">Yawè£œæ­£ 0Â°</option>
          <option value="1">Yawè£œæ­£ +90Â°</option>
          <option value="2">Yawè£œæ­£ +180Â°</option>
          <option value="3">Yawè£œæ­£ +270Â°</option>
        </select>
      </div>

      <div id="err"></div>
    </div>

    <div class="panel">
      <h2>è‰²ãŒâ€œã¡ã‚ƒã‚“ã¨ã™ã‚‹â€ä»•çµ„ã¿</h2>
      <p>
        <b>/assets/palette.v1.json</b>ï¼ˆBlockIdâ†’è‰²ï¼‰ã‚’æœ€å„ªå…ˆã§ä½¿ç”¨ã—ã¾ã™ã€‚<br/>
        è¾æ›¸ã«ç„¡ã„ãƒ–ãƒ­ãƒƒã‚¯ã¯ã‚«ãƒ†ã‚´ãƒªè‰²â†’æ§ãˆã‚ãƒãƒƒã‚·ãƒ¥è‰²ã§ç ´ç¶»ã‚’é˜²ãã¾ã™ã€‚
      </p>
    </div>
  </section>

  <section style="margin-top:14px;">
    <div id="grid" class="grid"></div>
  </section>

  <footer>
    Â© <span id="y"></span> MobCrafter Portal â€” MVP
  </footer>
</main>

<script>
(() => {
  // ====== API (approved only) ======
  const API_LIST = "https://api.mobcrafter.net/api/public/submissions";
  const API_DL   = (id) => `https://api.mobcrafter.net/api/public/submissions/${id}/download`;

  // ç”»é¢å´ã®çŠ¶æ…‹
  let items = [];

  const grid = document.getElementById("grid");
  const q = document.getElementById("q");
  const sort = document.getElementById("sort");
  const yawUi = document.getElementById("yaw");
  const errBox = document.getElementById("err");
  document.getElementById("y").textContent = new Date().getFullYear();

  function showError(msg){
    errBox.style.display = "block";
    errBox.textContent = msg;
  }
  function hideError(){
    errBox.style.display = "none";
    errBox.textContent = "";
  }

  function normalizeTags(tags){
    if(!tags) return [];
    if(Array.isArray(tags)) return tags.filter(Boolean).map(String);
    if(typeof tags === "string") return tags.split(",").map(s=>s.trim()).filter(Boolean);
    return [];
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  function render(){
    const query = (q.value || "").trim().toLowerCase();

    let list = items.filter(it => {
      if (!query) return true;
      const name = (it.name || "").toLowerCase();
      const desc = (it.desc || "").toLowerCase();
      const author = (it.author || "").toLowerCase();
      const tags = (it.tags || []).join(" ").toLowerCase();
      return name.includes(query) || desc.includes(query) || author.includes(query) || tags.includes(query);
    });

    if (sort.value === "new"){
      list.sort((a,b) => (new Date(b.date||0)) - (new Date(a.date||0)));
    }else if (sort.value === "old"){
      list.sort((a,b) => (new Date(a.date||0)) - (new Date(b.date||0)));
    }else if (sort.value === "dl"){
      list.sort((a,b) => (b.dl||0) - (a.dl||0));
    }

    if (list.length === 0){
      grid.innerHTML = `<div style="color:var(--muted);">è©²å½“ã™ã‚‹ãƒ¦ãƒ‹ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
      return;
    }

    // â€» å…ƒã® <a class="card"> ã‚’ã‚„ã‚ã¦ <div class="card"> ã«ã™ã‚‹ï¼ˆDownloadãƒªãƒ³ã‚¯ã‚’åˆæ³•ã«ç½®ããŸã‚ï¼‰
    grid.innerHTML = list.map(it => `
      <div class="card item" data-id="${escapeHtml(it.id)}" title="${escapeHtml(it.name)}">
        <div class="thumb">
          <canvas class="thumb3d" data-id="${escapeHtml(it.id)}" width="360" height="140"
            style="width:100%;height:140px;border-radius:0;"></canvas>

          <div class="badgeRow">
            <span class="badge">Forge ${escapeHtml(it.mod)}</span>
            <a class="badgeLink" href="${escapeHtml(it.jsonUrl)}" target="_blank" rel="noopener"
               title="JSONã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰">Download</a>
          </div>
        </div>

        <div class="content">
          <div class="name">${escapeHtml(it.name)}</div>
          <p class="desc">${escapeHtml(it.desc)}</p>
          <div class="meta">
            <span>ğŸ‘¤ ${escapeHtml(it.author)}</span>
            <span>â¬‡ ${(it.dl || 0).toLocaleString()}</span>
            <span>ğŸ· ${(it.tags||[]).slice(0,3).map(escapeHtml).join(", ")}</span>
          </div>
        </div>
      </div>
    `).join("");

    // ã‚«ãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°ãƒãƒƒã‚·ãƒ¥ã¸ï¼ˆå…ƒã®æŒ™å‹•ã®ä»£æ›¿ï¼‰
    grid.querySelectorAll(".card.item").forEach(card=>{
      card.addEventListener("click", (ev)=>{
        // Downloadã‚¯ãƒªãƒƒã‚¯ã¯ã‚«ãƒ¼ãƒ‰é·ç§»ã•ã›ãªã„
        const a = ev.target && ev.target.closest ? ev.target.closest("a") : null;
        if(a) return;
        const id = card.getAttribute("data-id");
        if(id) location.hash = `unit-${id}`;
      });
    });

    // â˜…HTMLã§canvasä½œã£ãŸç›´å¾Œã«ã‚µãƒ ãƒç”Ÿæˆï¼ˆé‡ã„ã®ã§idleå„ªå…ˆï¼‰
    scheduleHydrate(list);
  }

  async function loadList(){
    hideError();
    try{
      const r = await fetch(API_LIST, { cache: "no-store" });
      if(!r.ok){
        showError("ä¸€è¦§å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nHTTP " + r.status);
        return;
      }
      const data = await r.json();
      const arr = Array.isArray(data) ? data : (data.items || []);

      items = arr.map(r => ({
        id: String(r.id),
        name: r.title || r.name || "Untitled",
        desc: r.description || "",
        tags: normalizeTags(r.tags),
        author: r.author_name || "unknown",
        date: r.created_at || "",
        mod: r.mod_version || "",
        jsonUrl: API_DL(r.id),
        dl: Number(r.downloads || r.dl || 0)
      }));

      render();
    }catch(e){
      showError("ä¸€è¦§å–å¾—ã§ä¾‹å¤–ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n" + String(e && e.message ? e.message : e));
      grid.innerHTML = "";
    }
  }

  q.addEventListener("input", render);
  sort.addEventListener("change", render);

  // =========================
  // 3D thumb (index engine v3 + palette)
  // =========================

  // ä½œå“ã”ã¨ã®æ­£é¢ã‚ºãƒ¬è£œæ­£ï¼ˆ90åº¦åˆ»ã¿ï¼‰
  const YAW_OFFSET_QUARTER_KEY = "mcYawOffsetQuarter";

  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°
  const THUMB_CACHE_VER = "v8";
  const thumbCacheKey = (id)=> `mc_thumb_${THUMB_CACHE_VER}_${id}_yaw${localStorage.getItem(YAW_OFFSET_QUARTER_KEY)||0}`;

  // ---- Palette (BlockId -> color) ----
  const PALETTE_URL = "/assets/palette.v1.json";
  const PALETTE_VER = "v1";
  const PALETTE_LS_KEY = `mcPalette:${PALETTE_VER}`;
  let PALETTE_MAP = null;

  function parseColorString(s){
    if(!s) return null;
    const v = String(s).trim();
    const hex = /^#([0-9a-f]{6})$/i.exec(v);
    if(hex){
      const n = parseInt(hex[1], 16);
      return { r:(n>>16)&255, g:(n>>8)&255, b:n&255, a:1 };
    }
    const rgba = /^rgba?\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})(?:\s*,\s*([0-9]*\.?[0-9]+))?\s*\)$/i.exec(v);
    if(rgba){
      const r = Math.max(0, Math.min(255, parseInt(rgba[1],10)));
      const g = Math.max(0, Math.min(255, parseInt(rgba[2],10)));
      const b = Math.max(0, Math.min(255, parseInt(rgba[3],10)));
      const a = rgba[4] == null ? 1 : Math.max(0, Math.min(1, parseFloat(rgba[4])));
      return {r,g,b,a};
    }
    return null;
  }

  async function loadPalette(){
    if(PALETTE_MAP) return PALETTE_MAP;
    try{
      const cached = localStorage.getItem(PALETTE_LS_KEY);
      if(cached){
        const obj = JSON.parse(cached);
        if(obj && typeof obj === "object"){
          PALETTE_MAP = obj;
          return PALETTE_MAP;
        }
      }
    }catch(e){}
    try{
      const url = `${PALETTE_URL}?v=${encodeURIComponent(PALETTE_VER)}`;
      const r = await fetch(url, { method:"GET", cache:"no-store", mode:"same-origin" });
      if(r.ok){
        const obj = await r.json();
        if(obj && typeof obj === "object"){
          PALETTE_MAP = obj;
          try{ localStorage.setItem(PALETTE_LS_KEY, JSON.stringify(obj)); }catch(e){}
          return PALETTE_MAP;
        }
      }
    }catch(e){}
    PALETTE_MAP = {};
    return PALETTE_MAP;
  }

  function paletteLookup(blockId){
    if(!PALETTE_MAP) return null;
    const k = String(blockId||"").trim().toLowerCase();
    return parseColorString(PALETTE_MAP[k]);
  }

  function yawToQuarterTurns(frontYaw){
    if(frontYaw == null) return null;
    const y = Number(frontYaw);
    if(!Number.isFinite(y)) return null;
    let deg = y % 360;
    if(deg < 0) deg += 360;
    let q = (Math.round(deg / 90) % 4);

    const off = Number(localStorage.getItem(YAW_OFFSET_QUARTER_KEY) || "0");
    q = (q + (Number.isFinite(off)? off : 0)) % 4;
    return q;
  }

  function rotateXZ(x, z, q){
    switch(q){
      case 1: return {x: z,  z: -x};
      case 2: return {x: -x, z: -z};
      case 3: return {x: -z, z: x};
      default:return {x, z};
    }
  }

  function analyzeBlocks(blocks){
    let minX=Infinity,minY=Infinity,minZ=Infinity;
    let maxX=-Infinity,maxY=-Infinity,maxZ=-Infinity;
    for(const b of blocks){
      minX=Math.min(minX,b.dx); minY=Math.min(minY,b.dy); minZ=Math.min(minZ,b.dz);
      maxX=Math.max(maxX,b.dx); maxY=Math.max(maxY,b.dy); maxZ=Math.max(maxZ,b.dz);
    }
    return {minX,minY,minZ, maxX,maxY,maxZ, sizeX:maxX-minX+1, sizeY:maxY-minY+1, sizeZ:maxZ-minZ+1};
  }

function pickBaseColor(blockId){
  // 1) palette è¾æ›¸æœ€å„ªå…ˆ
  const p = paletteLookup(blockId);
  if(p) return p;

  const id = String(blockId||"").toLowerCase();
  const name = id.includes(":") ? id.split(":")[1] : id;
    // ã‚¯ã‚©ãƒ¼ãƒ„ç³»ã¯ç™½ï¼ˆsmooth_quartz / quartz_block / quartz_pillar ç­‰ï¼‰
  if (name.includes("quartz")) return {r: 235, g: 235, b: 235, a: 0.98};
  // ãƒã‚¶ãƒ¼ãƒ»ãƒ¬ãƒ³ã‚¬ç³»ï¼ˆèµ¤ãŒã‚°ãƒ¬ãƒ¼ã«è½ã¡ã‚‹ã®ã‚’é˜²ãï¼‰
  if (name.includes("red_nether") || name.includes("rednether")) return {r: 150, g: 60, b: 60, a: 0.98};
  if (name.includes("nether_brick") || name.includes("netherbrick") || name.includes("netherrack"))
    return {r: 120, g: 55, b: 55, a: 0.98};
  // brick ç³»ï¼ˆèµ¤ãƒ¬ãƒ³ã‚¬ã£ã½ãï¼‰
  if (name.includes("brick")) {
    if (name.includes("red")) return {r: 170, g: 70, b: 70, a: 0.98};
    return {r: 150, g: 95, b: 75, a: 0.98};
  }


  // é€æ˜ç³»
  if (name.includes("glass") || name.includes("ice")) return {r: 170, g: 210, b: 230, a: 0.55};
  // æ¤ç‰©
  if (name.includes("leaves") || name.includes("leaf") || name.includes("moss") || name.includes("vine")) return {r: 90, g: 150, b: 90, a: 0.95};
  // æœ¨æ
  if (name.includes("log") || name.includes("wood") || name.includes("planks") || name.includes("bamboo")) return {r: 160, g: 125, b: 85, a: 0.95};
  // åœŸãƒ»ç ‚
  if (name.includes("dirt") || name.includes("grass") || name.includes("sand") || name.includes("gravel") || name.includes("clay")) return {r: 160, g: 145, b: 110, a: 0.98};
  // çŸ³
  if (name.includes("stone") || name.includes("deepslate") || name.includes("andesite") || name.includes("diorite") || name.includes("granite") || name.includes("cobble") || name.includes("tuff")) return {r: 140, g: 145, b: 155, a: 0.98};

  // é‡‘å±
  if (name.includes("iron") || name.includes("anvil") || name.includes("chain") || name.includes("rail")) return {r: 170, g: 175, b: 185, a: 0.98};
  if (name.includes("copper")) return {r: 190, g: 120, b: 80, a: 0.98};
  if (name.includes("gold")) return {r: 210, g: 185, b: 90, a: 0.98};

  // å®çŸ³
  if (name.includes("diamond")) return {r: 120, g: 210, b: 220, a: 0.98};
  if (name.includes("emerald")) return {r: 70, g: 200, b: 120, a: 0.98};
  if (name.includes("lapis")) return {r: 70, g: 110, b: 200, a: 0.98};
  if (name.includes("redstone")) return {r: 190, g: 70, b: 70, a: 0.98};

  // wool / concrete / terracottaï¼ˆè‰²ååˆ¤å®šï¼‰
  if (name.includes("wool") || name.includes("concrete") || name.includes("terracotta")) {
    if (name.includes("red")) return {r: 190, g: 70, b: 70, a: 0.98};
    if (name.includes("white")) return {r: 220,g:220,b:220,a:0.98};
    if (name.includes("black")) return {r: 25,g:25,b:28,a:0.98};

    // â˜…åŒ…å«ãƒã‚°å¯¾ç­–ï¼šlight_gray â†’ gray ã®é †
    if (name.includes("light_gray") || name.includes("lightgrey") || name.includes("silver")) return {r: 180,g:180,b:185,a:0.98};
    if (name.includes("gray") || name.includes("grey")) return {r: 130,g:130,b:135,a:0.98};

    if (name.includes("light_blue") || name.includes("lightblue")) return {r: 140,g:190,b:230,a:0.98};
    if (name.includes("blue")) return {r: 85,g:120,b:200,a:0.98};

    // â˜… omoide å¯¾å¿œï¼šlime
    if (name.includes("lime")) return {r: 140,g:200,b:85,a:0.98};
    if (name.includes("green")) return {r: 85,g:170,b:110,a:0.98};

    if (name.includes("yellow")) return {r: 220,g:200,b:90,a:0.98};

    if (name.includes("light_purple") || name.includes("lightpurple")) return {r: 210,g:150,b:220,a:0.98};
    if (name.includes("purple")) return {r: 150,g:95,b:190,a:0.98};

    if (name.includes("pink")) return {r: 220,g:140,b:170,a:0.98};
    if (name.includes("orange")) return {r: 220,g:150,b:80,a:0.98};

    if (name.includes("cyan")) return {r: 95,g:190,b:190,a:0.98};
    if (name.includes("magenta")) return {r: 200,g:110,b:190,a:0.98};

    if (name.includes("brown")) return {r: 120,g:90,b:60,a:0.98};
    return {r: 180,g:160,b:150,a:0.98};
  }

  // 3) fallbackï¼ˆæ§ãˆã‚ãƒãƒƒã‚·ãƒ¥ï¼‰
  let h=0;
  for(let i=0;i<id.length;i++) h=(h*31 + id.charCodeAt(i))|0;
  const r = 120 + (h & 70);
  const g = 120 + ((h>>8)&70);
  const b = 120 + ((h>>16)&70);
  return {r,g,b,a:0.98};
}
  function luminance(col){
  // col: {r,g,b,a}
  return 0.2126*col.r + 0.7152*col.g + 0.0722*col.b;
}


function shade(col, k){
  const a = (col.a == null ? 1 : col.a);
  const r = Math.max(0, Math.min(255, Math.round(col.r * k)));
  const g = Math.max(0, Math.min(255, Math.round(col.g * k)));
  const b = Math.max(0, Math.min(255, Math.round(col.b * k)));
  return `rgba(${r},${g},${b},${a})`;
}

function drawIsoCube(ctx, x, y, z, s, col, stroke){
  const sx = (x - z) * s;
  const sy = (x + z) * s * 0.5 - y * s;

  // â˜…é»’ãŒæŒã¡ä¸ŠãŒã‚‰ãªã„é™°å½±ï¼ˆä¹—ç®—ï¼‰
  const top   = shade(col, 1.08);
  const left  = shade(col, 0.92);
  const right = shade(col, 0.78);

  ctx.fillStyle = top;
  ctx.beginPath();
  ctx.moveTo(sx, sy - s*0.5);
  ctx.lineTo(sx + s, sy);
  ctx.lineTo(sx, sy + s*0.5);
  ctx.lineTo(sx - s, sy);
  ctx.closePath();
  ctx.fill();

  if (stroke){
    ctx.strokeStyle = "rgba(15,23,42,.10)";
    ctx.lineWidth = Math.max(1, s*0.06);
    ctx.stroke();
  }

  ctx.fillStyle = left;
  ctx.beginPath();
  ctx.moveTo(sx - s, sy);
  ctx.lineTo(sx, sy + s*0.5);
  ctx.lineTo(sx, sy + s*0.5 + s);
  ctx.lineTo(sx - s, sy + s);
  ctx.closePath();
  ctx.fill();

  ctx.fillStyle = right;
  ctx.beginPath();
  ctx.moveTo(sx + s, sy);
  ctx.lineTo(sx, sy + s*0.5);
  ctx.lineTo(sx, sy + s*0.5 + s);
  ctx.lineTo(sx + s, sy + s);
  ctx.closePath();
  ctx.fill();
}


function binBlocks(blocks, bin){
  if(bin <= 1) return blocks;

  const m = new Map();

  for(const b of blocks){
    const bx = Math.floor(b.dx / bin);
    const by = Math.floor(b.dy / bin);
    const bz = Math.floor(b.dz / bin);
    const k = bx + "," + by + "," + bz;

    const cur = m.get(k);

    const colB = pickBaseColor(b.blockId);
    const lumB = luminance(colB);

    // è¦–ç·šæ–¹å‘ã®å¥¥è¡ŒãæŒ‡æ¨™ï¼ˆç­‰è§’ãªã®ã§ dx+dz ãŒåŠ¹ãï¼‰
    const depthB = b.dx + b.dz;

    if(!cur){
      m.set(k, { ...b, _lum: lumB, _depth: depthB });
      continue;
    }

    const lumC = cur._lum;
    const depthC = cur._depth;

    // â‘  æ˜ç¢ºã«æš—ã„æ–¹ã‚’å„ªå…ˆï¼ˆç›®ã®å¥¥ã®é»’ï¼‰
    if(lumB + 10 < lumC){
      m.set(k, { ...b, _lum: lumB, _depth: depthB });
      continue;
    }

    // â‘¡ æš—ã•ãŒè¿‘ã„ãªã‚‰ã€Œå¥¥ã€ã‚’å„ªå…ˆ
    if(Math.abs(lumB - lumC) <= 10){
      if(depthB > depthC){
        m.set(k, { ...b, _lum: lumB, _depth: depthB });
        continue;
      }
    }

    // â‘¢ ãã‚Œã§ã‚‚åŒç­‰ãªã‚‰ä¸Šï¼ˆå¾“æ¥äº’æ›ï¼‰
    if(Math.abs(lumB - lumC) <= 10 && depthB === depthC){
      if(b.dy > cur.dy){
        m.set(k, { ...b, _lum: lumB, _depth: depthB });
      }
    }
  }

  return Array.from(m.values()).map(({_lum,_depth,...rest})=>rest);
}

  function chooseBinSize(blockCount){
    const target = 16000;
    if(blockCount <= target) return 1;
    const ratio = blockCount / target;
    let bin = Math.ceil(Math.cbrt(ratio));
    bin = Math.min(6, Math.max(2, bin));
    return bin;
  }

  async function loadUnitJson(it){
    // â˜…å…ƒã®indexã¨åŒã˜æ€æƒ³ï¼šä¸€è¦§ã«ã¯JSONæœ¬ä½“ãŒç„¡ã„ã®ã§ jsonUrl ã‚’ fetch ã—ã¦èª­ã‚€
    if (!it.jsonUrl) return null;
    try{
      const r = await fetch(it.jsonUrl, { cache: "no-store" });
      if(!r.ok) return null;
      const txt = await r.text();
      const j = JSON.parse(txt);
      if(!j || !Array.isArray(j.blocks)) return null;
      return j;
    }catch(e){
      return null;
    }
  }

  function renderThumbToCanvas(canvas, unitJson){
    const ctx = canvas.getContext("2d");
    const w = canvas.width, h = canvas.height;

    ctx.clearRect(0,0,w,h);
    const g = ctx.createLinearGradient(0,0,0,h);
    g.addColorStop(0,"rgba(37,99,235,.10)");
    g.addColorStop(1,"rgba(22,163,74,.08)");
    ctx.fillStyle = g;
    ctx.fillRect(0,0,w,h);

    const blocks0 = unitJson.blocks || [];
    if(!blocks0.length) return;

    const qTurns = yawToQuarterTurns(unitJson.frontYaw);
    const bin = chooseBinSize(blocks0.length);
    const blocks = binBlocks(blocks0, bin);

    function drawPass(turns, alpha){
      const transformed = blocks.map(b=>{
        const r = rotateXZ(b.dx, b.dz, turns);
        return {dx:r.x, dy:b.dy, dz:r.z, blockId:b.blockId};
      });

      const inf = analyzeBlocks(transformed);
      const spanX = inf.sizeX + inf.sizeZ;
      const spanY = inf.sizeY;

      const s = Math.max(1.6, Math.min(w/(spanX+6), h/(spanY+10)) * 1.6);
      const ox = w*0.5;
      const oy = h*0.80;

      transformed.sort((a,b)=>
        (a.dx+a.dz) - (b.dx+b.dz) || (a.dy - b.dy)
      );

      ctx.save();
      ctx.globalAlpha = alpha;
      ctx.translate(ox, oy);

      const stroke = (s >= 3);
      for(const b of transformed){
        const x = (b.dx - inf.minX);
        const y = (b.dy - inf.minY);
        const z = (b.dz - inf.minZ);
        const col = pickBaseColor(b.blockId);
        drawIsoCube(ctx, x, y, z, s, col, stroke);
      }
      ctx.restore();
    }

    if(qTurns == null){
      drawPass(0, 1.0);
      drawPass(2, 0.33);
    }else{
      drawPass(qTurns, 1.0);
    }
  }

  function getCachedThumb(id){
    try{ return localStorage.getItem(thumbCacheKey(id)); }catch(e){ return null; }
  }
  function setCachedThumb(id, dataUrl){
    try{ localStorage.setItem(thumbCacheKey(id), dataUrl); }catch(e){}
  }
  function clearThumbCache(){
    try{
      const keys = [];
      for(let i=0;i<localStorage.length;i++){
        const k = localStorage.key(i);
        if(k && k.startsWith("mc_thumb_"+THUMB_CACHE_VER+"_")) keys.push(k);
      }
      for(const k of keys) localStorage.removeItem(k);
    }catch(e){}
  }

  async function hydrateThumbs(list){
    // paletteãŒæœªãƒ­ãƒ¼ãƒ‰ã ã¨è‰²ãŒãƒ–ãƒ¬ã‚‹ã®ã§å…ˆã«èª­ã‚€
    await loadPalette();

    const canvases = Array.from(document.querySelectorAll("canvas.thumb3d"));
    for(const c of canvases){
      const id = c.getAttribute("data-id");
      const it = list.find(x => String(x.id) === String(id));
      if(!it) continue;

      const cached = getCachedThumb(it.id);
      if(cached){
        const img = new Image();
        img.onload = () => {
          const ctx = c.getContext("2d");
          ctx.clearRect(0,0,c.width,c.height);
          ctx.drawImage(img, 0, 0, c.width, c.height);
        };
        img.src = cached;
        continue;
      }

      const unitJson = await loadUnitJson(it);
      if(!unitJson) continue;

      renderThumbToCanvas(c, unitJson);
      try{
        const url = c.toDataURL("image/png");
        setCachedThumb(it.id, url);
      }catch(e){}
    }
  }

  function scheduleHydrate(list){
    if ("requestIdleCallback" in window){
      requestIdleCallback(()=>hydrateThumbs(list), { timeout: 800 });
    }else{
      setTimeout(()=>hydrateThumbs(list), 50);
    }
  }

  // yawè£œæ­£UI
  yawUi.addEventListener("change", ()=>{
    localStorage.setItem(YAW_OFFSET_QUARTER_KEY, yawUi.value);
    clearThumbCache();
    render();
  });

  // boot
  const savedYaw = localStorage.getItem(YAW_OFFSET_QUARTER_KEY);
  if(savedYaw != null) yawUi.value = savedYaw;

  // ä¸€è¦§èª­ã¿è¾¼ã¿ï¼ˆpaletteã¯hydrateã§å…ˆã«ä¿è¨¼ï¼‰
  loadList();
})();
</script>

</body>
</html>
