<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MobCrafter Portal</title>
  <meta name="description" content="Minecraft Unit Share Portal for MobCrafter MOD!" />

  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1227105355658053"
     crossorigin="anonymous"></script>

  <style>
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e5e7eb;
      --brand:#2563eb;
      --danger:#dc2626;
      --shadow: 0 10px 25px rgba(15,23,42,.08);
      --radius: 16px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:var(--bg);
    }
    header{
      padding:24px 16px 10px;
      text-align:center;
    }
    header h1{
      margin:0;
      font-size:20px;
      letter-spacing:.4px;
    }
    header p{
      margin:6px 0 0;
      color:var(--muted);
      font-size:12px;
    }
    main{
      max-width:1060px;
      margin:0 auto;
      padding:10px 16px 40px;
    }
    .topbar{
      display:flex;
      gap:12px;
      align-items:flex-end;
      justify-content:space-between;
      flex-wrap:wrap;
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:14px 14px;
      box-shadow:var(--shadow);
    }
    .leftbox{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:flex-end;
    }
    .field label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
    }
    input[type="text"], select{
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      font-size:14px;
      min-width:260px;
      outline:none;
      background:#fff;
    }
    select{ min-width:180px; }
    .muted{
      color:var(--muted);
      font-size:12px;
    }
    .error{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      background:#fff1f2;
      border:1px solid #fecdd3;
      color:#9f1239;
      display:none;
      white-space:pre-wrap;
      width:100%;
    }
    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap:14px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      cursor:pointer;
      transition: transform .08s ease, box-shadow .08s ease;
      position:relative;
    }
    .card:hover{
      transform: translateY(-1px);
      box-shadow: 0 14px 30px rgba(15,23,42,.10);
    }
    .thumbwrap{
      height:140px;
      background: linear-gradient(180deg, #e6f0ff, #f5f9ff);
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
    }
    canvas.thumb{
      width:100%;
      height:140px;
      image-rendering:pixelated;
    }

    img.thumbimg{
      width:100%;
      height:140px;
      object-fit:cover;
      image-rendering:auto;
      display:block;
    }

    .pill{
      position:absolute;
      top:10px;
      left:10px;
      display:flex;
      gap:6px;
      align-items:center;
    }
    .badge{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      background:rgba(255,255,255,.78);
      border:1px solid rgba(148,163,184,.35);
      color:#0f172a;
      backdrop-filter: blur(6px);
    }

    .badge.pending{
      background: rgba(254, 243, 199, .95);
      border-color: rgba(245, 158, 11, .35);
    }
    .badge.rejected, .badge.reject{
      background: rgba(254, 226, 226, .95);
      border-color: rgba(220, 38, 38, .35);
    }
    .badge.approved{
      background: rgba(220, 252, 231, .95);
      border-color: rgba(34, 197, 94, .35);
    }

    .btn-dl{
      position:absolute;
      top:10px;
      right:10px;
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(37,99,235,.92);
      color:#fff;
      border:1px solid rgba(37,99,235,.10);
      text-decoration:none;
      backdrop-filter: blur(6px);
    }
    .btn-edit{
      position:absolute;
      bottom:10px;
      right:10px;
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(15,23,42,.82);
      color:#fff;
      border:1px solid rgba(15,23,42,.10);
      text-decoration:none;
      backdrop-filter: blur(6px);
    }
    .card-body{
      padding:12px 12px 14px;
    }
    .title{
      margin:0;
      font-size:15px;
      font-weight:700;
      line-height:1.25;
    }
    .meta{
      margin-top:8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-size:12px;
      color:var(--muted);
    }
    .meta .left{
      display:flex;
      gap:10px;
      align-items:center;
      min-width:0;
    }
    .meta .author{
      display:flex;
      gap:6px;
      align-items:center;
      min-width:0;
    }
    .meta .author span{
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width:120px;
      display:block;
    }
    .meta .dl{
      display:flex;
      gap:6px;
      align-items:center;
    }
    .tagline{
      margin-top:8px;
      font-size:12px;
      color:var(--muted);
      overflow:hidden;
      white-space:nowrap;
      text-overflow:ellipsis;
    }

    /* ===== pager ===== */
    .pager{
      margin-top:16px;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-wrap:wrap;
      gap:8px;
    }
    .pager .info{
      color:var(--muted);
      font-size:12px;
      margin-right:8px;
    }
    .pager a, .pager button{
      border:1px solid rgba(37,99,235,.25);
      background:#fff;
      color:var(--brand);
      padding:7px 10px;
      border-radius:999px;
      font-size:12px;
      cursor:pointer;
      text-decoration:none;
      line-height:1;
      user-select:none;
    }
    .pager button[disabled]{
      opacity:.45;
      cursor:not-allowed;
    }
    .pager .active{
      background:var(--brand);
      border-color:var(--brand);
      color:#fff;
    }
    .pager .dots{
      color:var(--muted);
      font-size:12px;
      padding:0 4px;
    }

    footer{
      margin-top:26px;
      text-align:center;
      font-size:12px;
      color:var(--muted);
    }

    .authbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      width:100%;
      margin-top:8px;
      padding-top:10px;
      border-top:1px dashed var(--line);
      color:var(--muted);
      font-size:12px;
    }
    .authbar .left{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      min-width:0;
    }
    .authbar code{
      background:rgba(148,163,184,.15);
      border:1px solid rgba(148,163,184,.25);
      padding:2px 6px;
      border-radius:999px;
      color:#0f172a;
    }
    .authbar .right{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .authbar a{
      color:var(--brand);
      text-decoration:none;
      border:1px solid rgba(37,99,235,.25);
      padding:6px 10px;
      border-radius:999px;
      background:#fff;
      white-space:nowrap;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .authbar a.primary{
      background:#2563eb;
      border-color:#2563eb;
      color:#fff;
    }
    .authbar a.danger{
      background:var(--danger);
      border-color:var(--danger);
      color:#fff;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid rgba(148,163,184,.25);
      background:#fff;
      padding:6px 10px;
      border-radius:999px;
      user-select:none;
    }
    .chip input{ transform: translateY(1px); }
  </style>
</head>
<body>
<header>
  <h1>MobCrafter Portal</h1>
  <p>
    Unit JSON sharing portal for <strong>MobCrafter</strong> (Minecraft Forge <strong>1.20.1</strong>).<br />
    Download MobCrafter from CurseForge:
    <a href="https://www.curseforge.com/minecraft/mc-mods/mobcrafter" target="_blank" rel="noopener noreferrer">
      https://www.curseforge.com/minecraft/mc-mods/mobcrafter
    </a>
    <br /><br />
    <strong>Important:</strong> The units shared here are <strong>JSON files for the MobCrafter mod</strong>.<br />
    You can build units using blocks from other mods too, but you must install those mods as <strong>required dependencies</strong>
    in your modpack/world to use the unit.
  </p>
</header>

<main>
  <div class="topbar">
    <div class="leftbox">
      <div class="field">
        <label>Search</label>
        <input id="q" type="text" placeholder="Enter KeyWord" />
        <div class="muted">„Çø„Ç§„Éà„É´ / Ë™¨Êòé / „Çø„Ç∞„ÅßÊ§úÁ¥¢„Åß„Åç„Åæ„Åô„ÄÇ„Çµ„É†„Éç„ÅØÁ∞°Êòì3DÊèèÁîª„ÄÇ</div>
      </div>

      <div class="field">
        <label>YawË£úÊ≠£</label>
        <select id="yaw">
          <option value="270">YawË£úÊ≠£ +270¬∞</option>
          <option value="180">YawË£úÊ≠£ +180¬∞</option>
          <option value="90">YawË£úÊ≠£ +90¬∞</option>
          <option value="0">YawË£úÊ≠£ „Å™„Åó</option>
        </select>
        <div class="muted">„Ç´„Éº„Éâ„ÇØ„É™„ÉÉ„ÇØ„ÅßË©≥Á¥∞„Å∏Ôºà/unit.html?id=Êï∞Â≠ó or UUIDÔºâ</div>
      </div>
    </div>

    <div class="field">
      <label>‰∏¶„Å≥Êõø„Åà</label>
      <select id="sort">
        <option value="new">Êñ∞ÁùÄÈ†Ü</option>
        <option value="dl">DLÂ§ö„ÅÑÈ†Ü</option>
        <option value="name">ÂêçÂâçÈ†Ü</option>
      </select>
    </div>

    <div id="err" class="error"></div>
    <div class="muted" style="width:100%; margin-top:8px; line-height:1.5;">
  This portal shares <strong>MobCrafter unit JSON</strong> (Forge <strong>1.20.1</strong>).<br />
  If a unit uses blocks from other mods, those mods must be installed as <strong>required dependencies</strong>.
</div>


    <div class="authbar" id="authbar">
      <div class="left">
        <span>Login:</span>
        <code id="authState">checking...</code>
        <span id="authEmailWrap" style="display:none;">Email: <code id="authEmail"></code></span>
        <span id="authAdminWrap" style="display:none;">Admin: <code id="authAdmin"></code></span>

        <label id="mineWrap" class="chip" style="display:none;">
          <input id="mineOnly" type="checkbox" />
          <span>Ëá™ÂàÜ„ÅÆÊäïÁ®ø„ÅÆ„Åø</span>
        </label>
      </div>

      <div class="right">
        <a id="authActionLink" href="/api/whoami">„É≠„Ç∞„Ç§„É≥</a>
        <a id="postLink" class="primary" href="/submit.html">ÊäïÁ®ø</a>
      </div>
    </div>
  </div>

  <section id="grid" class="grid"></section>
  <div id="pager" class="pager" style="display:none;"></div>

  <footer>¬© 2025 MobCrafter Portal ‚Äî MVP</footer>
</main>

<script>
(() => {
  // ====== API ======
  const API_PUBLIC_LIST = "/api/public/submissions";
  const API_MY_LIST = "/api/my/submissions?scope=all"; // „É≠„Ç∞„Ç§„É≥ÂøÖÈ†à / Ëá™ÂàÜ„ÅÆÊâøË™çÊ∏à„Åø„ÅÆ„Åø
  const API_JSON = (id) => `/api/public/submissions/${id}/json`;
  const API_DL   = (id) => `/api/public/submissions/${id}/download`;
  const API_PUBLIC_SCREEN = (screenId) => `/api/public/screens/${encodeURIComponent(screenId)}`;
  const API_PRIVATE_SCREEN = (screenId) => `/api/screens/${encodeURIComponent(screenId)}`;

  // ====== AUTH ======
  const API_WHOAMI = "/api/whoami";

  const authState = document.getElementById("authState");
  const authEmailWrap = document.getElementById("authEmailWrap");
  const authEmail = document.getElementById("authEmail");
  const authAdminWrap = document.getElementById("authAdminWrap");
  const authAdmin = document.getElementById("authAdmin");

  const authActionLink = document.getElementById("authActionLink");
  const postLink = document.getElementById("postLink");

  const mineWrap = document.getElementById("mineWrap");
  const mineOnly = document.getElementById("mineOnly");

  let meEmail = null;
  let meIsAdmin = false;
  let meUserId = null;

  function normEmail(v){
    const s = String(v || "").trim().toLowerCase();
    return (s && s.includes("@")) ? s : "";
  }

  async function loadWhoami(){
    try{
      authState.textContent = "checking...";
      authEmailWrap.style.display = "none";
      authAdminWrap.style.display = "none";
      mineWrap.style.display = "none";
      meEmail = null;
      meIsAdmin = false;
      meUserId = null;

      const r = await fetch(API_WHOAMI, { cache:"no-store", credentials:"include" });
      const text = await r.text();
      let data = null;
      try { data = JSON.parse(text); } catch { data = null; }

      authActionLink.href = `/api/login?next=${encodeURIComponent("/")}`;

      if(!r.ok || !data){
        authState.textContent = "unknown";
        authActionLink.textContent = "„É≠„Ç∞„Ç§„É≥";
        authActionLink.className = "";
        postLink.href = `/api/login?next=${encodeURIComponent("/submit.html")}`;
        return;
      }

      const email = normEmail(data.email);
      const isAdmin = Boolean(data.is_admin);
      const uid = String(data.user_id || "").trim();

      if(!email){
        authState.textContent = "logged out";
        authActionLink.textContent = "„É≠„Ç∞„Ç§„É≥";
        authActionLink.className = "";
        postLink.href = `/api/login?next=${encodeURIComponent("/submit.html")}`;
        return;
      }

      meEmail = email;
      meIsAdmin = isAdmin;
      meUserId = uid || null;

      authState.textContent = "logged in";
      authEmailWrap.style.display = "inline";
      authEmail.textContent = email;

      authAdminWrap.style.display = "inline";
      authAdmin.textContent = isAdmin ? "true" : "false";

      authActionLink.textContent = "„É≠„Ç∞„Ç¢„Ç¶„Éà";
      authActionLink.className = "danger";
      authActionLink.href = "/cdn-cgi/access/logout?returnTo=" + encodeURIComponent(location.origin + "/");

      postLink.href = "/submit.html";
      mineWrap.style.display = "inline-flex";
    }catch{
      authState.textContent = "unknown";
      authActionLink.textContent = "„É≠„Ç∞„Ç§„É≥";
      authActionLink.className = "";
      authActionLink.href = `/api/login?next=${encodeURIComponent("/")}`;
      postLink.href = `/api/login?next=${encodeURIComponent("/submit.html")}`;
      mineWrap.style.display = "none";
      meEmail = null;
      meIsAdmin = false;
      meUserId = null;
    }
  }

  let items = [];
  let currentUseMine = false;

  // ===== UI =====
  const grid = document.getElementById("grid");
  const pager = document.getElementById("pager");
  const q = document.getElementById("q");
  const sort = document.getElementById("sort");
  const yawUi = document.getElementById("yaw");
  const err = document.getElementById("err");

  const PAGE_SIZE = 20;

  function showError(msg){
    err.style.display = "block";
    err.textContent = msg;
  }
  function hideError(){
    err.style.display = "none";
    err.textContent = "";
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  function normalizeTags(t){
    if(!t) return [];
    if(Array.isArray(t)) return t.map(x=>String(x).trim()).filter(Boolean);
    return String(t).split(/[\s,]+/).map(x=>x.trim()).filter(Boolean);
  }

  function asDateIso(s){
    try{
      const d = new Date(s);
      if(Number.isNaN(d.getTime())) return null;
      return d.toISOString();
    }catch{
      return null;
    }
  }

  function resolveNo(row){
    const n = Number(row.submission_no ?? row.submissionNo ?? row.no ?? 0);
    return n || 0;
  }

  // ===== URL state =====
  function getParams(){
    const sp = new URLSearchParams(location.search);
    const page = Math.max(1, Number(sp.get("page") || "1") || 1);
    const qv = String(sp.get("q") || "");
    const sortv = String(sp.get("sort") || "new");
    const yawv = String(sp.get("yaw") || "270");
    const mine = sp.get("mine") === "1";
    return { page, q: qv, sort: sortv, yaw: yawv, mine };
  }

  function setParams(patch, { push=false } = {}){
    const sp = new URLSearchParams(location.search);
    for(const [k,v] of Object.entries(patch)){
      if(v === null || v === undefined || v === ""){
        sp.delete(k);
      }else{
        sp.set(k, String(v));
      }
    }
    const qs = sp.toString();
    const nextUrl = location.pathname + (qs ? "?" + qs : "");
    if(push) history.pushState(null, "", nextUrl);
    else history.replaceState(null, "", nextUrl);
  }

  function buildPublicListUrl({ page, q, sort }){
    const sp = new URLSearchParams();
    sp.set("page", String(page));
    sp.set("page_size", String(PAGE_SIZE));
    if(q && String(q).trim()) sp.set("q", String(q).trim());
    if(sort) sp.set("sort", String(sort));
    return API_PUBLIC_LIST + "?" + sp.toString();
  }

  async function fetchUnitJson(id){
    const r = await fetch(API_JSON(id), { cache: "no-store" });
    if(!r.ok) throw new Error("json HTTP " + r.status);
    return await r.json();
  }

  // --- palette (submit „Å®Âêå„ÅòËâ≤Âë≥„Å´ÊèÉ„Åà„Çã) ---
  const PALETTE_URL = "/assets/palette.v1.json";
  const PALETTE_VER = "v1";
  const PALETTE_LS_KEY = `mcPalette:${PALETTE_VER}`;
  let PALETTE_MAP = null;

  function parseColorString(s){
    if(!s) return null;
    const v = String(s).trim();
    const hex = /^#([0-9a-f]{6})$/i.exec(v);
    if(hex){
      const n = parseInt(hex[1], 16);
      return { r:(n>>16)&255, g:(n>>8)&255, b:n&255, a:1 };
    }
    const rgba = /^rgba?\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})(?:\s*,\s*([0-9]*\.?[0-9]+))?\s*\)$/i.exec(v);
    if(rgba){
      const r = Math.max(0, Math.min(255, parseInt(rgba[1],10)));
      const g = Math.max(0, Math.min(255, parseInt(rgba[2],10)));
      const b = Math.max(0, Math.min(255, parseInt(rgba[3],10)));
      const a = rgba[4] == null ? 1 : Math.max(0, Math.min(1, parseFloat(rgba[4])));
      return {r,g,b,a};
    }
    return null;
  }

  async function loadPalette(){
    if(PALETTE_MAP) return PALETTE_MAP;
    try{
      const cached = localStorage.getItem(PALETTE_LS_KEY);
      if(cached){
        const obj = JSON.parse(cached);
        if(obj && typeof obj === "object"){
          PALETTE_MAP = obj;
          return PALETTE_MAP;
        }
      }
    }catch(e){}
    try{
      const r = await fetch(`${PALETTE_URL}?v=${encodeURIComponent(PALETTE_VER)}`, { cache:"no-store" });
      if(r.ok){
        const obj = await r.json();
        if(obj && typeof obj === "object"){
          PALETTE_MAP = obj;
          try{ localStorage.setItem(PALETTE_LS_KEY, JSON.stringify(obj)); }catch(e){}
          return PALETTE_MAP;
        }
      }
    }catch(e){}
    PALETTE_MAP = {};
    return PALETTE_MAP;
  }

  function paletteLookup(blockId){
    if(!PALETTE_MAP) return null;
    const k = String(blockId||"").trim().toLowerCase();
    return parseColorString(PALETTE_MAP[k]);
  }

  function pickBaseColor(blockId){
    const p = paletteLookup(blockId);
    if(p) return p;

    const raw = String(blockId||"").toLowerCase();
    const id = raw.includes(":") ? raw.split(":")[1] : raw;

    if (id.includes("glass") || id.includes("ice")) return {r: 170, g: 210, b: 230, a: 0.55};
    if (id.includes("leaves") || id.includes("leaf") || id.includes("moss") || id.includes("vine") || id.includes("grass")) return {r: 90, g: 150, b: 90, a: 0.95};
    if (id.includes("log") || id.includes("wood") || id.includes("planks") || id.includes("bamboo")) return {r: 160, g: 125, b: 85, a: 0.95};
    if (id.includes("dirt") || id.includes("sand") || id.includes("gravel") || id.includes("clay") || id.includes("mud")) return {r: 160, g: 145, b: 110, a: 0.98};
    if (id.includes("stone") || id.includes("deepslate") || id.includes("andesite") || id.includes("diorite") || id.includes("granite") || id.includes("cobble") || id.includes("tuff") || id.includes("slate")) return {r: 140, g: 145, b: 155, a: 0.98};
    if (id.includes("iron") || id.includes("anvil") || id.includes("chain") || id.includes("rail") || id.includes("metal")) return {r: 170, g: 175, b: 185, a: 0.98};
    if (id.includes("copper") || id.includes("bronze")) return {r: 190, g: 120, b: 80, a: 0.98};
    if (id.includes("gold")) return {r: 210, g: 185, b: 90, a: 0.98};
    if (id.includes("diamond")) return {r: 120, g: 210, b: 220, a: 0.98};
    if (id.includes("emerald")) return {r: 70, g: 200, b: 120, a: 0.98};
    if (id.includes("lapis")) return {r: 70, g: 110, b: 200, a: 0.98};
    if (id.includes("redstone")) return {r: 190, g: 70, b: 70, a: 0.98};

    let h=0; for(let i=0;i<raw.length;i++) h=(h*31 + raw.charCodeAt(i))|0;
    return { r:120 + (h & 70), g:120 + ((h>>8)&70), b:120 + ((h>>16)&70), a:0.98 };
  }

  function isAirBlock(blockId){
    const s = String(blockId||"").trim().toLowerCase();
    return s === "minecraft:air" || s.endsWith(":air");
  }

  function drawIsoCube(ctx, x, y, z, s, col, stroke){
    const sx = (x - z) * s;
    const sy = (x + z) * s * 0.5 - y * s;

    const a = (col.a == null ? 1 : col.a);
    const top = `rgba(${Math.min(255,col.r+30)},${Math.min(255,col.g+30)},${Math.min(255,col.b+30)},${a})`;
    const left= `rgba(${Math.max(0,col.r-10)},${Math.max(0,col.g-10)},${Math.max(0,col.b-10)},${a})`;
    const right=`rgba(${Math.max(0,col.r-25)},${Math.max(0,col.g-25)},${Math.max(0,col.b-25)},${a})`;

    ctx.fillStyle = top;
    ctx.beginPath();
    ctx.moveTo(sx, sy - s*0.5);
    ctx.lineTo(sx + s, sy);
    ctx.lineTo(sx, sy + s*0.5);
    ctx.lineTo(sx - s, sy);
    ctx.closePath();
    ctx.fill();
    if (stroke){
      ctx.strokeStyle = "rgba(15,23,42,.10)";
      ctx.lineWidth = Math.max(1, s*0.06);
      ctx.stroke();
    }

    ctx.fillStyle = left;
    ctx.beginPath();
    ctx.moveTo(sx - s, sy);
    ctx.lineTo(sx, sy + s*0.5);
    ctx.lineTo(sx, sy + s*0.5 + s);
    ctx.lineTo(sx - s, sy + s);
    ctx.closePath();
    ctx.fill();

    ctx.fillStyle = right;
    ctx.beginPath();
    ctx.moveTo(sx + s, sy);
    ctx.lineTo(sx, sy + s*0.5);
    ctx.lineTo(sx, sy + s*0.5 + s);
    ctx.lineTo(sx + s, sy + s);
    ctx.closePath();
    ctx.fill();
  }

  function drawIso(canvas, blocks, yawDeg){
    const ctx = canvas.getContext("2d");
    const w = canvas.width, h = canvas.height;
    ctx.clearRect(0,0,w,h);

    if(!Array.isArray(blocks) || blocks.length === 0){
      ctx.fillStyle = "rgba(15,23,42,.35)";
      ctx.font = "12px sans-serif";
      ctx.fillText("No blocks", 10, 20);
      return;
    }

    const g = ctx.createLinearGradient(0,0,0,h);
    g.addColorStop(0,"rgba(37,99,235,.10)");
    g.addColorStop(1,"rgba(22,163,74,.08)");
    ctx.fillStyle = g;
    ctx.fillRect(0,0,w,h);

    const yaw = (Number(yawDeg||0) % 360) * Math.PI/180;
    const cos = Math.cos(yaw), sin = Math.sin(yaw);

    const pts = [];
    for(const b of blocks){
      const bid = String(b.blockId||"");
      if(isAirBlock(bid)) continue;

      const x0 = Number(b.dx||0), y0 = Number(b.dy||0), z0 = Number(b.dz||0);
      const rx = x0*cos - z0*sin;
      const rz = x0*sin + z0*cos;

      const x = Math.round(rx);
      const z = Math.round(rz);
      const y = y0;

      const sx0 = (x - z);
      const sy0 = (x + z) * 0.5 - y;

      const minX = sx0 - 1;
      const maxX = sx0 + 1;
      const minY = sy0 - 0.5;
      const maxY = sy0 + 1.5;

      pts.push({x,y,z,bid,sx0,sy0,minX,maxX,minY,maxY});
    }

    if(pts.length === 0){
      ctx.fillStyle = "rgba(15,23,42,.35)";
      ctx.font = "12px sans-serif";
      ctx.fillText("No visible blocks", 10, 20);
      return;
    }

    let minPX=Infinity, maxPX=-Infinity, minPY=Infinity, maxPY=-Infinity;
    for(const p of pts){
      if(p.minX < minPX) minPX = p.minX;
      if(p.maxX > maxPX) maxPX = p.maxX;
      if(p.minY < minPY) minPY = p.minY;
      if(p.maxY > maxPY) maxPY = p.maxY;
    }

    const rangeX = Math.max(1e-6, (maxPX - minPX));
    const rangeY = Math.max(1e-6, (maxPY - minPY));
    const cx = (minPX + maxPX) * 0.5;
    const cy = (minPY + maxPY) * 0.5;

    const margin = 16;

    const s = Math.max(
      1.8,
      Math.min(
        (w - margin*2) / rangeX,
        (h - margin*2) / rangeY
      )
    );

    const ox = (w * 0.5) - (cx * s);
    const oy = (h * 0.5) - (cy * s);

    pts.sort((a,b)=> (a.x + a.z) - (b.x + b.z) || (a.y - b.y));

    const stroke = (s >= 3);

    ctx.save();
    ctx.translate(ox, oy);
    for(const p of pts){
      drawIsoCube(ctx, p.x, p.y, p.z, s, pickBaseColor(p.bid), stroke);
    }
    ctx.restore();
  }

  function goUnit(it){
    if (it.no) location.href = `/unit.html?id=${encodeURIComponent(String(it.no))}`;
    else location.href = `/unit.html?id=${encodeURIComponent(String(it.id))}`;
  }

  function renderCard(it){
    const card = document.createElement("article");
    card.className = "card";

    const isMine = Boolean(meEmail && it.authorEmail && String(it.authorEmail) === String(meEmail));
    const canEdit = isMine;

    const hasScreen = Boolean(it.thumbScreenId);
    const useScreenThumb = hasScreen;

    const st = String(it.status || "approved").toLowerCase();
    const statusBadge = (st && st !== "approved")
      ? `<span class="badge ${escapeHtml(st)}">${escapeHtml(st)}</span>`
      : ``;

    const publicSrc = hasScreen
      ? (API_PUBLIC_SCREEN(it.thumbScreenId) + "?v=" + encodeURIComponent(it.created || it.createdText || ""))
      : "";

    const privateSrc = hasScreen
      ? (API_PRIVATE_SCREEN(it.thumbScreenId) + "?v=" + encodeURIComponent(it.created || it.createdText || ""))
      : "";

    const initialSrc = (meEmail && st !== "approved") ? privateSrc : publicSrc;
    const initialIsPrivate = (initialSrc === privateSrc);

    card.innerHTML = `
      <div class="thumbwrap">
        ${useScreenThumb
          ? `<img class="thumbimg"
                  src="${escapeHtml(initialSrc)}"
                  alt=""
                  data-public-src="${escapeHtml(publicSrc)}"
                  data-private-src="${escapeHtml(privateSrc)}"
                  data-tried-private="${initialIsPrivate ? "1" : "0"}"
                />`
          : `<canvas class="thumb" width="480" height="280"></canvas>`
        }
        <div class="pill">
          <span class="badge">${escapeHtml(it.mod || "Forge")}</span>
          ${statusBadge}
        </div>
        <a class="btn-dl" href="${escapeHtml(API_DL(it.id))}" download>Download</a>
        ${canEdit ? `<a class="btn-edit" href="${escapeHtml(`/submit?edit=${encodeURIComponent(it.id)}`)}">Á∑®ÈõÜ</a>` : ``}
      </div>

      <div class="card-body">
        <p class="title">${escapeHtml(it.name)}</p>
        <div class="meta">
          <div class="left">
            <div class="author">üë§ <span>${escapeHtml(it.author || "unknown")}</span></div>
            <div class="dl">‚¨á ${escapeHtml(it.dl ?? 0)}</div>
          </div>
          <div class="time">üïí ${escapeHtml(it.createdText)}</div>
        </div>
        <div class="tagline">${escapeHtml(it.tags.join(" / "))}</div>
      </div>
    `;

    card.addEventListener("click", (e) => {
      const a = e.target && e.target.closest ? e.target.closest("a") : null;
      if (a) return;
      goUnit(it);
    });

    const editBtn = card.querySelector(".btn-edit");
    if (editBtn) {
      editBtn.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        goUnit(it);
      });
    }

    const img = card.querySelector("img.thumbimg");
    if (img) {
      img.addEventListener("error", async () => {
        const tried = img.getAttribute("data-tried-private");
        const ps = img.getAttribute("data-private-src");

        if (meEmail && tried !== "1" && ps) {
          img.setAttribute("data-tried-private", "1");
          img.src = ps;
          return;
        }

        try {
          const wrap = img.closest(".thumbwrap");
          if (!wrap) return;

          const canvas = document.createElement("canvas");
          canvas.className = "thumb";
          canvas.width = 480;
          canvas.height = 280;

          img.remove();
          wrap.prepend(canvas);

          const j = await fetchUnitJson(it.id);
          await loadPalette();
          const yaw = Number(yawUi.value || 270);
          drawIso(canvas, j.blocks, yaw);
        } catch {}
      }, { once:false });
    }

    const canvas = card.querySelector("canvas.thumb");
    if (canvas) {
      (async () => {
        try{
          const j = await fetchUnitJson(it.id);
          await loadPalette();
          const yaw = Number(yawUi.value || 270);
          drawIso(canvas, j.blocks, yaw);
        }catch{}
      })();
    }

    return card;
  }

  function renderGrid(arr){
    grid.innerHTML = "";
    for(const it of arr){
      grid.appendChild(renderCard(it));
    }
  }

  // ===== pager render =====
  function renderPager(meta){
    // meta: {page, page_size, total_count, total_pages}
    if(!meta || !meta.total_pages || meta.total_pages <= 1){
      pager.style.display = "none";
      pager.innerHTML = "";
      return;
    }

    const { page, total_pages, total_count } = meta;
    pager.style.display = "flex";
    pager.innerHTML = "";

    const info = document.createElement("span");
    info.className = "info";
    info.textContent = `Page ${page} / ${total_pages} (Total ${total_count})`;
    pager.appendChild(info);

    const mkBtn = (label, toPage, disabled=false, active=false) => {
      const b = document.createElement("button");
      b.textContent = label;
      if(active) b.className = "active";
      if(disabled){
        b.disabled = true;
        return b;
      }
      b.addEventListener("click", () => {
        setParams({ page: toPage }, { push:true });
        load();
      });
      return b;
    };

    pager.appendChild(mkBtn("Ââç„Å∏", page - 1, page <= 1));

    const addDots = () => {
      const s = document.createElement("span");
      s.className = "dots";
      s.textContent = "‚Ä¶";
      pager.appendChild(s);
    };

    const pages = [];
    const win = 2;
    const start = Math.max(1, page - win);
    const end = Math.min(total_pages, page + win);

    // 1, ... window, ... last
    pages.push(1);
    for(let p = start; p <= end; p++) pages.push(p);
    pages.push(total_pages);

    // uniq
    const uniq = [];
    for(const p of pages){
      if(!uniq.includes(p)) uniq.push(p);
    }
    uniq.sort((a,b)=>a-b);

    let prev = 0;
    for(const p of uniq){
      if(prev && p - prev > 1) addDots();
      pager.appendChild(mkBtn(String(p), p, false, p === page));
      prev = p;
    }

    pager.appendChild(mkBtn("Ê¨°„Å∏", page + 1, page >= total_pages));
  }

  // ===== fetch list =====
  async function fetchListPublic({ page, q, sort }){
    const url = buildPublicListUrl({ page, q, sort });
    const r = await fetch(url, { cache:"no-store", credentials:"include" });
    const text = await r.text().catch(()=> "");
    let data = null;
    try { data = JSON.parse(text); } catch { data = null; }

    if(!r.ok){
      throw new Error(`list HTTP ${r.status}\n${text ? ("body: " + text.slice(0,240)) : ""}`);
    }
    const arr = (data && Array.isArray(data.items)) ? data.items : [];
    const meta = {
      page: Number(data?.page || page),
      page_size: Number(data?.page_size || PAGE_SIZE),
      total_count: Number(data?.total_count || 0),
      total_pages: Number(data?.total_pages || 1),
    };
    return { arr, meta };
  }

  async function fetchListMine(){
    const r = await fetch(API_MY_LIST, { cache:"no-store", credentials:"include" });
    const text = await r.text().catch(()=> "");
    let data = null;
    try { data = JSON.parse(text); } catch { data = null; }

    if(!r.ok){
      throw new Error(`list HTTP ${r.status}\n${text ? ("body: " + text.slice(0,240)) : ""}`);
    }
    const arr = (data && Array.isArray(data.items)) ? data.items : [];
    return { arr, meta: null };
  }

  function mapItems(arr){
    return arr.map(r => {
      const created = asDateIso(r.created_at || r.createdAt || r.created);
      const createdText = created ? created.slice(0,10) : "";
      const tags = normalizeTags(r.tags);
      const no = resolveNo(r);
      const rawStatus =
        (r.status ?? r.review_status ?? r.reviewStatus ?? r.state ?? r.approval_status ?? r.approvalStatus ?? "");

      const status = String(rawStatus || "approved").trim().toLowerCase();

      const screenId =
        (r.thumb_screen_id ?? r.thumbScreenId ??
         r.screen_id ?? r.screenId ??
         r.screenshot_id ?? r.screenshotId ??
         r.thumb_id ?? r.thumbId ?? null);

      const thumbModeRaw =
        (r.thumb_mode ?? r.thumbMode ?? r.thumbnail_mode ?? r.thumbnailMode ?? "");

      return ({
        id: String(r.id),
        no,
        name: r.title || r.name || "Untitled",
        desc: r.description || "",
        tags,
        author: r.author_name || r.authorName || "unknown",
        authorEmail: r.author_email || r.authorEmail || r.author_id || r.authorId || "",
        authorId: r.author_email || r.authorEmail || r.author_id || r.authorId || "",
        dl: Number(r.download_count ?? r.downloadCount ?? 0),
        mod: r.mod_version || r.modVersion || "Forge",
        created: created || "",
        createdText,
        thumbMode: String(thumbModeRaw).toLowerCase(),
        thumbScreenId: screenId ? String(screenId) : null,
        status
      });
    });
  }

  async function load(){
    hideError();
    grid.innerHTML = "";
    pager.style.display = "none";
    pager.innerHTML = "";

    try{
      const p = getParams();

      // UIÂèçÊò†ÔºàURL -> UIÔºâ
      q.value = p.q || "";
      sort.value = p.sort || "new";
      yawUi.value = p.yaw || "270";

      const useMine = !!(mineOnly && mineOnly.checked && meEmail);
      currentUseMine = useMine;

      let arr = [];
      let meta = null;

      if(useMine){
        const res = await fetchListMine();
        arr = res.arr;
        meta = null; // mine „ÅØÁèæÁä∂„Éö„Éº„Ç∏„É≥„Ç∞„Åó„Å™„ÅÑÔºàÂøÖË¶Å„Å™„ÇâÊ¨°„ÅßÊã°ÂºµÔºâ
      }else{
        const res = await fetchListPublic({ page: p.page, q: p.q, sort: p.sort });
        arr = res.arr;
        meta = res.meta;
      }

      items = mapItems(arr);

      renderGrid(items);
      renderPager(meta);
    }catch(e){
      showError("‰∏ÄË¶ß„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ\n" + String(e.message || e));
    }
  }

  // ===== eventsÔºàURLÊõ¥Êñ∞„Åó„Å¶„Åã„ÇâloadÔºâ=====
  let qTimer = null;
  q.addEventListener("input", () => {
    clearTimeout(qTimer);
    qTimer = setTimeout(() => {
      setParams({ q: q.value.trim(), page: 1 }, { push:false });
      load();
    }, 250);
  });

  sort.addEventListener("change", () => {
    setParams({ sort: sort.value, page: 1 }, { push:true });
    load();
  });

  yawUi.addEventListener("change", () => {
    setParams({ yaw: yawUi.value }, { push:false });
    // yaw„ÅØÊèèÁîª„Å†„ÅëÊõ¥Êñ∞„Åß„ÇÇ„ÅÑ„ÅÑ„Åå„ÄÅÁ∞°Âçò„Å´ÂÜçÊèèÁîª„Åô„Çã
    load();
  });

  if (mineOnly) mineOnly.addEventListener("change", () => {
    // mineOnly „ÅØ url „Å´ mine=1 „Çí‰øùÊåÅÔºàÂ∞ÜÊù•„ÅÆÊã°ÂºµÁî®Ôºâ
    const on = !!mineOnly.checked;
    setParams({ mine: on ? 1 : "" , page: 1 }, { push:true });
    load();
  });

  window.addEventListener("popstate", () => load());

  (async () => {
    // URL -> UI ÂàùÊúüÂèçÊò†Ôºàmine„ÉÅ„Çß„ÉÉ„ÇØ„ÇÇÔºâ
    const p = getParams();
    yawUi.value = p.yaw || "270";
    sort.value = p.sort || "new";
    q.value = p.q || "";

    await loadWhoami();

    // whoamiÂæå„Å´ mineOnly „ÇíURL„Å´Âêà„Çè„Åõ„ÇãÔºà„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Å™„ÅÑ„Å™„ÇâÂº∑Âà∂OFFÔºâ
    if(mineOnly){
      mineOnly.checked = !!(p.mine && meEmail);
    }

    await load();
  })();
})();
</script>
</body>
</html>
