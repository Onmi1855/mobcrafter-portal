<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MobCrafter Portal | Unit</title>
  <meta name="description" content="MobCrafter用ユニットJSONの詳細ページ。ダウンロード、JSONプレビュー、使い方を表示します。" />
  <style>
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e5e7eb;
      --brand:#2563eb;
      --danger:#dc2626;
      --shadow: 0 10px 25px rgba(15,23,42,.08);
      --radius: 16px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:var(--bg);
    }
    header{
      padding:18px 16px 10px;
      text-align:center;
    }
    header a{ color:inherit; text-decoration:none; }
    header h1{ margin:0; font-size:18px; letter-spacing:.4px; }
    header p{ margin:6px 0 0; color:var(--muted); font-size:12px; }
    main{ max-width:1060px; margin:0 auto; padding:10px 16px 40px; }
    .wrap{ display:grid; grid-template-columns: 1.15fr .85fr; gap:14px; }
    @media (max-width: 900px){ .wrap{ grid-template-columns: 1fr; } }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
    }
    .title{ margin:0; font-size:18px; font-weight:800; line-height:1.25; }
    .muted{ color:var(--muted); font-size:12px; }
    .tags{ margin-top:10px; display:flex; flex-wrap:wrap; gap:6px; }
    .tag{
      font-size:12px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.35);
      background:rgba(255,255,255,.8);
    }
    .kv{ margin-top:12px; display:grid; grid-template-columns: 160px 1fr; gap:8px 10px; font-size:13px; }
    .kv .k{ color:var(--muted); }
    .actions{ margin-top:12px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .btn{
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      background:#fff;
      cursor:pointer;
      font-size:14px;
      text-decoration:none;
      color:inherit;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .btn.primary{
      background:rgba(37,99,235,.92);
      border-color:rgba(37,99,235,.10);
      color:#fff;
    }
    pre{
      margin:10px 0 0;
      background:#0b1220;
      color:#e2e8f0;
      padding:12px;
      border-radius:12px;
      overflow:auto;
      font-size:12px;
      line-height:1.4;
    }
    details{ margin-top:12px; }
    summary{ cursor:pointer; font-weight:700; }
    .err{
      background:#fff1f2;
      border:1px solid #fecdd3;
      color:#9f1239;
      padding:10px 12px;
      border-radius:12px;
      white-space:pre-wrap;
    }
  </style>
</head>
<body>
<header>
  <a href="/"><h1>MobCrafter Portal</h1></a>
  <p>ユニットJSON共有（詳細）</p>
</header>

<main>
  <div class="wrap">
    <section class="card">
      <h2 class="title" id="title">読み込み中...</h2>
      <div class="muted" id="sub"></div>

      <div class="tags" id="tags"></div>
      <div class="kv" id="kv"></div>

      <div class="actions">
        <a id="downloadBtn" class="btn primary" href="#" download>Download JSON</a>
        <button id="copyBtn" class="btn" type="button">使い方をコピー</button>
      </div>

      <details id="jsonDetails">
        <summary>JSONプレビュー（折りたたみ）</summary>
        <pre id="jsonPreview">...</pre>
      </details>

      <details>
        <summary>ゲームでの使い方（コピペ）</summary>
        <pre id="howto"></pre>
      </details>

      <div id="msg"></div>
    </section>

    <aside class="card">
      <h3 style="margin:0 0 8px;">サムネ（MVP）</h3>
      <div class="muted" style="font-size:13px;">
        MVP方針：一覧は軽量。詳細は情報集約（次フェーズでスクショ/3D切替）。
      </div>
    </aside>
  </div>
</main>

<script>
(() => {
  const API_LIST = "/api/public/submissions"; // approved一覧
  const API_JSON = (id) => `/api/public/submissions/${id}/json`;      // DLカウントしない
  const API_DL   = (id) => `/api/public/submissions/${id}/download`;  // DLカウントする

  const el = (id) => document.getElementById(id);

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  function normalizeTags(t){
    if(!t) return [];
    if(Array.isArray(t)) return t.map(x=>String(x).trim()).filter(Boolean);
    return String(t).split(/[\s,]+/).map(x=>x.trim()).filter(Boolean);
  }

  function kvRow(k,v){
    return `<div class="k">${escapeHtml(k)}</div><div>${escapeHtml(v ?? "")}</div>`;
  }

  function buildHowTo(unitId){
    const id = String(unitId || "").trim();
    return [
      "【MobCrafterでの使い方】",
      "1) Download JSON を押して取得",
      "2) ファイル名とJSON内 id/unitId は必ず一致しています",
      "   例: " + id + ".json",
      "3) MobCrafter の指定フォルダへ配置 → ゲーム内で読み込み/召喚",
      "",
      "※ポータル側で unitId を強制一致させています（MobCrafter本体仕様対策）。"
    ].join("\\n");
  }

  function getKeyFromUrl(){
    // 正規: /u/13 または /u/<uuid>
    let m = location.pathname.match(/^\/u\/([^\/?#]+)/);
    if (m) return decodeURIComponent(m[1]);

    // 404ルーティング: /u/index.html?p=/u/13
    const p = new URLSearchParams(location.search).get("p") || "";
    m = p.match(/^\/u\/([^\/?#]+)/);
    if (m) return decodeURIComponent(m[1]);

    return null;
  }

  async function fetchApprovedList(){
    const r = await fetch(API_LIST, { cache:"no-store" });
    if(!r.ok) throw new Error("list HTTP " + r.status);
    const data = await r.json();
    return Array.isArray(data.items) ? data.items : [];
  }

  async function load(){
    const key = getKeyFromUrl();
    if(!key){
      el("msg").innerHTML = `<div class="err">URLが不正です。一覧からクリックして開いてください。</div>`;
      return;
    }

    // key が数字なら submission_no、数字以外なら UUID とみなす
    const isNo = /^\d+$/.test(key);
    const list = await fetchApprovedList();

    let item = null;
    if(isNo){
      const no = Number(key);
      item = list.find(x => Number(x.submission_no ?? x.submissionNo ?? 0) === no) || null;
    }else{
      item = list.find(x => String(x.id) === key) || null;
    }

    if(!item){
      el("msg").innerHTML = `<div class="err">対象が見つかりませんでした。\n（承認済み一覧に無い、または削除済みの可能性）</div>`;
      return;
    }

    // 表示
    el("title").textContent = item.title || item.name || "Untitled";
    el("sub").textContent = `#${item.submission_no ?? "?"} / ${item.unit_id ?? ""}`;

    const tags = normalizeTags(item.tags);
    el("tags").innerHTML = tags.map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join("");

    el("kv").innerHTML = [
      kvRow("投稿日", item.created_at || ""),
      kvRow("DL数", item.download_count ?? 0),
      kvRow("mod_version", item.mod_version || "Forge"),
      kvRow("submission_no", item.submission_no ?? ""),
      kvRow("unit_id", item.unit_id ?? ""),
      kvRow("作者", item.author_name || "unknown")
    ].join("");

    // DLリンク（ここだけがDLカウント増える）
    el("downloadBtn").href = API_DL(item.id);

    // howto
    el("howto").textContent = buildHowTo(item.unit_id);

    // JSONプレビュー（開いた時だけ取得、DLカウントしない）
    let jsonLoaded = false;
    const jsonDetails = el("jsonDetails");
    jsonDetails.addEventListener("toggle", async () => {
      if(!jsonDetails.open) return;
      if(jsonLoaded) return;
      jsonLoaded = true;
      try{
        const r = await fetch(API_JSON(item.id), { cache:"no-store" });
        if(!r.ok) throw new Error("json HTTP " + r.status);
        const text = await r.text();
        el("jsonPreview").textContent = text;
      }catch(e){
        el("jsonPreview").textContent = "取得失敗: " + String(e.message || e);
      }
    });

    // copy howto
    el("copyBtn").onclick = async () => {
      try{
        await navigator.clipboard.writeText(buildHowTo(item.unit_id));
        el("msg").innerHTML = `<div class="muted" style="margin-top:12px;">コピーしました。</div>`;
        setTimeout(()=> el("msg").innerHTML = "", 1500);
      }catch{
        el("msg").innerHTML = `<div class="err">コピーできませんでした。</div>`;
      }
    };
  }

  load().catch(e => {
    el("msg").innerHTML = `<div class="err">読み込みに失敗しました:\n${escapeHtml(String(e.message || e))}</div>`;
  });
})();
</script>
</body>
</html>
