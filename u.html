<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MobCrafter Portal | Unit</title>
  <meta name="description" content="MobCrafter用ユニットJSONの詳細ページ。ダウンロード、JSONプレビュー、使い方を表示します。" />
  <style>
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e5e7eb;
      --brand:#2563eb;
      --danger:#dc2626;
      --shadow: 0 10px 25px rgba(15,23,42,.08);
      --radius: 16px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:var(--bg);
    }
    header{
      padding:18px 16px 10px;
      text-align:center;
    }
    header a{
      color:inherit;
      text-decoration:none;
    }
    header h1{
      margin:0;
      font-size:18px;
      letter-spacing:.4px;
    }
    header p{
      margin:6px 0 0;
      color:var(--muted);
      font-size:12px;
    }
    main{
      max-width:1060px;
      margin:0 auto;
      padding:10px 16px 40px;
    }
    .wrap{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:14px;
    }
    @media (max-width: 900px){
      .wrap{ grid-template-columns: 1fr; }
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
    }
    .title{
      margin:0;
      font-size:18px;
      font-weight:800;
      line-height:1.25;
    }
    .muted{ color:var(--muted); font-size:12px; }
    .tags{
      margin-top:10px;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    .tag{
      font-size:12px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.35);
      background:rgba(255,255,255,.8);
    }
    .kv{
      margin-top:12px;
      display:grid;
      grid-template-columns: 160px 1fr;
      gap:8px 10px;
      font-size:13px;
    }
    .kv .k{ color:var(--muted); }
    .actions{
      margin-top:12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .btn{
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      background:#fff;
      cursor:pointer;
      font-size:14px;
      text-decoration:none;
      color:inherit;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .btn.primary{
      background:rgba(37,99,235,.92);
      border-color:rgba(37,99,235,.10);
      color:#fff;
    }
    pre{
      margin:10px 0 0;
      background:#0b1220;
      color:#e2e8f0;
      padding:12px;
      border-radius:12px;
      overflow:auto;
      font-size:12px;
      line-height:1.4;
    }
    details{ margin-top:12px; }
    summary{ cursor:pointer; font-weight:700; }
    .err{
      background:#fff1f2;
      border:1px solid #fecdd3;
      color:#9f1239;
      padding:10px 12px;
      border-radius:12px;
      white-space:pre-wrap;
    }
    .ownerBox{
      margin-top:14px;
      border-top:1px dashed var(--line);
      padding-top:14px;
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:flex-end;
      margin-top:10px;
    }
    input[type="text"], textarea{
      width:100%;
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      font-size:14px;
      outline:none;
      background:#fff;
    }
    textarea{ min-height:92px; resize:vertical; }
    .danger{
      background:rgba(220,38,38,.95);
      border-color:rgba(220,38,38,.10);
      color:#fff;
    }
    .hint{
      margin-top:8px;
      font-size:12px;
      color:var(--muted);
      white-space:pre-wrap;
    }
  </style>
</head>
<body>
<header>
  <a href="/"><h1>MobCrafter Portal</h1></a>
  <p>ユニットJSON共有（詳細）</p>
</header>

<main>
  <div class="wrap">
    <section class="card">
      <h2 class="title" id="title">読み込み中...</h2>
      <div class="muted" id="sub"> </div>

      <div class="tags" id="tags"></div>

      <div class="kv" id="kv"></div>

      <div class="actions">
        <a id="downloadBtn" class="btn primary" href="#" download>Download JSON</a>
        <button id="copyBtn" class="btn" type="button">使い方をコピー</button>
      </div>

      <details id="jsonDetails">
        <summary>JSONプレビュー（折りたたみ）</summary>
        <pre id="jsonPreview">...</pre>
      </details>

      <details>
        <summary>ゲームでの使い方（コピペ）</summary>
        <pre id="howto"></pre>
      </details>

      <div class="ownerBox" id="ownerBox">
        <h3 style="margin:0 0 8px;">投稿者メニュー（編集/差し替え/削除）</h3>

        <div class="row">
          <div style="flex:1; min-width:220px;">
            <label class="muted">タイトル</label>
            <input id="editTitle" type="text" placeholder="タイトル" />
          </div>
          <div style="flex:1; min-width:220px;">
            <label class="muted">タグ（スペース区切り）</label>
            <input id="editTags" type="text" placeholder="tag1 tag2 ..." />
          </div>
        </div>

        <div class="row">
          <div style="flex:1; min-width:220px;">
            <label class="muted">説明</label>
            <textarea id="editDesc" placeholder="説明"></textarea>
          </div>
        </div>

        <div class="row">
          <button id="saveMetaBtn" class="btn" type="button">メタ更新</button>
          <button id="replaceJsonBtn" class="btn" type="button">JSON差し替え（ファイル選択）</button>
          <input id="jsonFile" type="file" accept="application/json" style="display:none;">
          <button id="deleteBtn" class="btn danger" type="button">削除</button>
        </div>

        <div id="ownerMsg" class="hint"></div>
      </div>
    </section>

    <aside class="card">
      <h3 style="margin:0 0 8px;">サムネ（MVP）</h3>
      <div class="muted" style="font-size:13px;">
        MVP方針により、一覧は軽量維持。詳細では今後スクショ/3D切替を実装します。<br>
        （現時点はこの枠は説明のみ。スクショ対応フェーズでここに表示を追加）
      </div>
      <div id="status" style="margin-top:12px;"></div>
    </aside>
  </div>
</main>

<script>
  // ★確定構成：同一オリジン（mobcrafter.net/api）
  const API_BASE = ""; // 同一オリジン（mobcrafter.net/api）
  const API_JSON = (id) => `${API_BASE}/api/public/submissions/${id}/json`;
  const API_DL   = (id) => `${API_BASE}/api/public/submissions/${id}/download`;

  function getSubmissionNoFromPath() {
    // 1) 正規パス: /u/123
    let m = location.pathname.match(/^\/u\/(\d+)/);
    if (m) return Number(m[1]);
    // 2) 404.html リダイレクト: /u/index.html?p=/u/123
    const p = new URLSearchParams(location.search);
    const path = p.get("p") || "";
    m = path.match(/^\/u\/(\d+)/);
    if (m) return Number(m[1]);
    // 3) 直接 no=123 の形式でもOK
    const no = p.get("no");
    if (no && /^\d+$/.test(no)) return Number(no);
    // 4) 404.html が sessionStorage に入れた場合
    try {
      const ss = sessionStorage.getItem("mc_redirect_path") || "";
      m = ss.match(/^\/u\/(\d+)/);
      if (m) return Number(m[1]);
    } catch {}
    return null;
  }

  function el(id){ return document.getElementById(id); }

  function setStatus(html){ el("status").innerHTML = html || ""; }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  function normalizeTags(t){
    if(!t) return [];
    if(Array.isArray(t)) return t.map(x=>String(x).trim()).filter(Boolean);
    return String(t).split(/[\s,]+/).map(x=>x.trim()).filter(Boolean);
  }

  function kvRow(k,v){
    return `<div class="k">${escapeHtml(k)}</div><div>${escapeHtml(v ?? "")}</div>`;
  }

  function buildHowTo(unitId){
    const id = String(unitId || "").trim();
    return [
      "【MobCrafterでの使い方】",
      "1) ダウンロードしたJSONファイル名が unitId と一致していることを確認",
      "   例: " + id + ".json",
      "2) MobCrafter の指定フォルダに配置（あなたの環境の手順に従ってください）",
      "3) ゲーム内で読み込み/召喚",
      "",
      "※このポータルは、MobCrafter本体仕様により",
      "  ファイル名とJSON内の id/unitId を必ず一致させて配布します。",
    ].join("\n");
  }

  async function apiGet(path){
    const res = await fetch(`${API_BASE}${path}`, { cache:"no-store" });
    if(!res.ok){
      const t = await res.text().catch(()=> "");
      throw new Error(`HTTP ${res.status}\n${t}`);
    }
    return await res.json();
  }

  async function whoami(){
    try{
      const w = await apiGet(`/api/whoami`);
      return w;
    }catch{
      return { ok:false, email:null, is_admin:false };
    }
  }

  async function load(){
    setStatus(`<div class="muted">読み込み中...</div>`);

    const no = getSubmissionNoFromPath();
    if (!no) {
      setStatus(`<div class="err">URLが不正です。\n一覧からクリックして開いてください。</div>`);
      return;
    }

    // 詳細メタ取得（approvedのみ返る）
    let item;
    try {
      const res = await apiGet(`/api/public/u/${no}`);
      item = res.item;
    } catch (e) {
      setStatus(`<div class="err">詳細の取得に失敗しました:\n${escapeHtml(String(e.message || e))}</div>`);
      return;
    }

    // 表示
    el("title").textContent = item.title || "Untitled";
    el("sub").textContent = `#${item.submission_no} / ${item.unit_id || ""}`;

    const tags = normalizeTags(item.tags);
    el("tags").innerHTML = tags.map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join("");

    el("kv").innerHTML = [
      kvRow("投稿日", item.created_at),
      kvRow("更新", item.updated_at || ""),
      kvRow("DL数", item.download_count ?? 0),
      kvRow("mc_version", item.mc_version || ""),
      kvRow("mod_version", item.mod_version || ""),
      kvRow("submission_no", item.submission_no),
      kvRow("unit_id", item.unit_id),
      kvRow("作者", item.author_name || "unknown"),
    ].join("");

    // DLリンク（UUIDでDL）
    const dlBtn = el("downloadBtn");
    dlBtn.href = API_DL(item.id);

    // howto / preview
    el("howto").textContent = buildHowTo(item.unit_id);
    el("jsonPreview").textContent = "（開いたときに取得します）";

    // JSONプレビューは折りたたみを開いた時だけ取得（DLカウントしない）
    let jsonLoaded = false;
    const jsonDetails = el("jsonDetails");
    jsonDetails.addEventListener("toggle", async () => {
      if (!jsonDetails.open) return;
      if (jsonLoaded) return;
      jsonLoaded = true;
      try {
        const res = await fetch(API_JSON(item.id), { cache: "no-store" });
        if (!res.ok) throw new Error("json HTTP " + res.status);
        const text = await res.text();
        el("jsonPreview").textContent = text;
      } catch (e) {
        el("jsonPreview").textContent = "取得失敗: " + String(e.message || e);
      }
    });

    // copy howto
    el("copyBtn").onclick = async () => {
      try {
        await navigator.clipboard.writeText(buildHowTo(item.unit_id));
        setStatus(`<div class="card" style="margin-top:12px;">コピーしました。</div>`);
        setTimeout(()=>setStatus(""), 1500);
      } catch {
        setStatus(`<div class="err">コピーできませんでした。</div>`);
      }
    };

    // 投稿者メニュー（Cloudflare Access の email / admin 判定）
    const me = await whoami();
    const isOwner = me.email && item.author_email && String(me.email).toLowerCase() === String(item.author_email).toLowerCase();
    const canEdit = Boolean(me.is_admin || isOwner);

    const ownerBox = el("ownerBox");
    if (!canEdit) {
      ownerBox.style.display = "none";
      return;
    }

    // 初期値反映
    el("editTitle").value = item.title || "";
    el("editDesc").value = item.description || "";
    el("editTags").value = String(item.tags || "");

    function setOwnerMsg(msg){ el("ownerMsg").textContent = msg || ""; }

    // メタ更新
    el("saveMetaBtn").onclick = async () => {
      setOwnerMsg("更新中...");
      try{
        const body = {
          title: el("editTitle").value,
          description: el("editDesc").value,
          tags: el("editTags").value
        };
        const res = await fetch(`/api/submissions/${item.id}`, {
          method: "PUT",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify(body)
        });
        const t = await res.text();
        if(!res.ok) throw new Error(t);
        setOwnerMsg("メタ更新しました。ページを更新すると反映されます。");
      }catch(e){
        setOwnerMsg("失敗: " + String(e.message || e));
      }
    };

    // JSON差し替え
    el("replaceJsonBtn").onclick = () => el("jsonFile").click();
    el("jsonFile").onchange = async () => {
      const f = el("jsonFile").files && el("jsonFile").files[0];
      if(!f) return;

      setOwnerMsg("JSON差し替え中...");
      try{
        const text = await f.text();
        const j = JSON.parse(text);

        const res = await fetch(`/api/submissions/${item.id}/json`, {
          method: "PUT",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({ json: j })
        });
        const t = await res.text();
        if(!res.ok) throw new Error(t);

        setOwnerMsg("差し替え完了。Downloadボタンから新しいJSONを取れます。");
        // プレビューは次回開いたときに取得し直し
        jsonLoaded = false;
        el("jsonPreview").textContent = "（開いたときに取得します）";
      }catch(e){
        setOwnerMsg("失敗: " + String(e.message || e));
      }finally{
        el("jsonFile").value = "";
      }
    };

    // 削除（ソフトデリート）
    el("deleteBtn").onclick = async () => {
      if(!confirm("この投稿を削除します（復元不可）。よろしいですか？")) return;
      setOwnerMsg("削除中...");
      try{
        const res = await fetch(`/api/submissions/${item.id}`, { method:"DELETE" });
        const t = await res.text();
        if(!res.ok) throw new Error(t);
        setOwnerMsg("削除しました。トップへ戻ります。");
        setTimeout(()=>location.href="/", 800);
      }catch(e){
        setOwnerMsg("失敗: " + String(e.message || e));
      }
    };

    setStatus("");
  }

  load();
</script>
</body>
</html>
