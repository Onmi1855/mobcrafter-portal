<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MobCrafter - Unit</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, sans-serif; margin: 24px; background:#f6f8fb; color:#0f172a; }
    .card { max-width: 980px; background:#fff; border: 1px solid #e5e7eb; border-radius: 14px; padding: 18px; box-shadow: 0 10px 25px rgba(15,23,42,.08); margin: 0 auto; }
    h1 { margin: 0 0 6px; }
    .muted { color:#64748b; font-size: 13px; }
    .row { display:flex; gap:12px; flex-wrap: wrap; }
    .row > div { flex: 1 1 240px; }
    .pill { display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border-radius: 999px; background:#eef2ff; color:#3730a3; font-size: 12px; font-weight:700; }
    .warn { display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border-radius: 999px; background:#fff7ed; color:#9a3412; font-size: 12px; font-weight:700; }
    .divider { height:1px; background:#e5e7eb; margin: 16px 0; }
    pre { background:#0b1220; color:#e5e7eb; padding: 12px; border-radius: 12px; overflow:auto; }
    .mini { font-size: 13px; color:#334155; }
    a { color:#2563eb; text-decoration:none; }
    a:hover { text-decoration:underline; }
    .screens { margin-top: 10px; }
    .screenGrid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap:10px;
    }
    .screenGrid img{
      width:100%;
      height:140px;
      object-fit:cover;
      border-radius: 12px;
      border:1px solid #e5e7eb;
      background:#fff;
    }
    details{ border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px; background:#fff; }
    summary{ cursor:pointer; font-weight:800; }
  </style>
</head>
<body>

<div class="card">
  <div class="row" style="align-items:flex-end;">
    <div>
      <h1 id="title">Unit</h1>
      <div class="muted" id="subtitle"></div>
    </div>
    <div style="text-align:right;">
      <span id="authPill" class="pill">checking...</span>
      <span id="authEmail" class="mini"></span>
    </div>
  </div>

  <div class="divider"></div>

  <div class="row">
    <div>
      <div class="mini"><b>Unit ID</b>: <span id="unitId"></span></div>
      <div class="mini"><b>Submission No</b>: <span id="subNo"></span></div>
      <div class="mini"><b>Status</b>: <span id="status"></span></div>
    </div>
    <div>
      <div class="mini"><b>Author</b>: <span id="author"></span></div>
      <div class="mini"><b>Created</b>: <span id="created"></span></div>
      <div class="mini"><b>DL</b>: <span id="dl"></span></div>
    </div>
  </div>

  <div class="divider"></div>

  <details id="screensSection" style="display:none;">
    <summary>スクリーンショット</summary>
    <div class="screens">
      <div id="screenMsg" class="mini"></div>
      <div id="screenGrid" class="screenGrid"></div>
      <div id="screenDetails" class="mini" style="margin-top:8px;"></div>
    </div>
  </details>

  <div class="divider"></div>

  <label class="mini" style="font-weight:800;">Unit JSON</label>
  <pre id="json">読み込み中...</pre>

  <div class="divider"></div>

  <div class="mini">
    <a href="/">← 一覧に戻る</a>
  </div>
</div>

<script>
(() => {
  const API_WHOAMI = "/api/whoami";
  const API_PUBLIC_U_BY_UNITID = (unitId) => `/api/public/unit/${encodeURIComponent(unitId)}`; // fallback if exists
  const API_PUBLIC_U_BY_NO = (no) => `/api/public/u/${encodeURIComponent(no)}`;
  const API_PRIVATE_SUB = (id) => `/api/my/submissions/${encodeURIComponent(id)}`;
  const API_PUBLIC_SCREENS = (id) => `/api/public/submissions/${encodeURIComponent(id)}/screens`;
  const API_PRIVATE_SCREENS = (id) => `/api/submissions/${encodeURIComponent(id)}/screens`;

  const el = (id) => document.getElementById(id);

  let isLoggedIn = false;
  let isAdmin = false;
  let meEmail = "";

  async function whoami(){
    try{
      const r = await fetch(API_WHOAMI, { cache:"no-store", credentials:"include" });
      const j = await r.json().catch(()=>null);
      if(r.ok && j && j.ok===true){
        return j;
      }
    }catch{}
    return { ok:true, email:null, is_admin:false };
  }

  function setAuthPill(me){
    const pill = el("authPill");
    const email = el("authEmail");
    if(me && me.email){
      isLoggedIn = true;
      isAdmin = !!me.is_admin;
      meEmail = String(me.email || "");
      pill.textContent = isAdmin ? "admin" : "logged in";
      pill.className = "pill";
      email.textContent = meEmail ? ("as " + meEmail) : "";
    }else{
      isLoggedIn = false;
      isAdmin = false;
      meEmail = "";
      pill.textContent = "guest";
      pill.className = "warn";
      email.textContent = "";
    }
  }

  async function loadScreens(submissionId, canPrivate){
    const grid = el("screenGrid");
    const msg = el("screenMsg");
    const det = el("screenDetails");
    if (!grid || !msg || !det) return;

    grid.innerHTML = "";
    msg.textContent = "読み込み中...";
    try{
      const usePrivate = Boolean(canPrivate);
      const url = usePrivate ? API_PRIVATE_SCREENS(submissionId) : API_PUBLIC_SCREENS(submissionId);
      const r = await fetch(url, { cache:"no-store", credentials: "include" });
      const data = await r.json().catch(()=>null);
      if(!r.ok || !data || data.ok !== true){
        msg.textContent = "取得できませんでした。";
        return;
      }
      const screens = Array.isArray(data.screens) ? data.screens : [];
      if(screens.length === 0){
        msg.textContent = "スクショはまだありません。";
        return;
      }
      msg.textContent = "";

      for(const s of screens){
        const img = document.createElement("img");
        img.loading = "lazy";
        img.alt = "screenshot";
        img.src = usePrivate ? (`/api/screens/${encodeURIComponent(s.id)}`) : (`/api/public/screens/${encodeURIComponent(s.id)}`);
        grid.appendChild(img);
      }
      det.textContent = `件数: ${screens.length}`;
    }catch(e){
      msg.textContent = "取得失敗: " + (e?.message || String(e));
    }
  }

  function getQuery(){
    const u = new URL(location.href);
    return {
      id: u.searchParams.get("id") || "",
      no: u.searchParams.get("no") || "",
    };
  }

  async function load(){
    const q = getQuery();
    const me = await whoami();
    setAuthPill(me);

    // 現状unit.htmlは unit_id を query ?id= に想定
    // ただし public API が submission_no ベースしか無い場合もあるので、ここでは /api/public/u/:no が使えるならそれを優先
    // ※このファイルは「スクショ部分の修正」に留め、既存挙動を壊さない前提で動かします。
    // 実運用では /api/public/unit/:unit_id のようなAPIがあると楽ですが、ここでは推測で追加しません。

    // 既存実装：public側は unit_id 経由で取得できる想定（デプロイ済のAPIに合わせる）
    // ここは元のファイルの想定に依存するため、最小の修正のみ行います。
    const unitId = q.id;

    // まずは public 詳細（unitId → server側で引ける想定）を試す
    let item = null;
    try{
      const r = await fetch(`/api/public/unit?id=${encodeURIComponent(unitId)}`, { cache:"no-store", credentials:"include" });
      const j = await r.json().catch(()=>null);
      if(r.ok && j && j.ok===true && j.item){
        item = j.item;
      }
    }catch{}

    // だめなら /api/my/submissions/:id を直接は呼べない（idがsubmissionIdの場合のみ）
    // ここも推測で拡張せず、item が無い場合は表示を止める
    if(!item){
      el("title").textContent = "Not found";
      el("subtitle").textContent = "取得できませんでした。";
      el("json").textContent = "not_found";
      return;
    }

    el("title").textContent = item.title || "Unit";
    el("subtitle").textContent = item.description || "";
    el("unitId").textContent = item.unit_id || "";
    el("subNo").textContent = item.submission_no != null ? String(item.submission_no) : "";
    el("status").textContent = item.status || "";
    el("author").textContent = item.author_name || "";
    el("created").textContent = item.created_at || "";
    el("dl").textContent = item.download_count != null ? String(item.download_count) : "0";

    // canEdit: owner/admin
    const canEdit = Boolean(isAdmin || (isLoggedIn && item.author_email && String(item.author_email)===String(meEmail)));

    // Screens section (owner/admin: private, guest/public: public endpoint)
    const screensSection = el("screensSection");
    if (screensSection) {
      // 未ログインは「表示しない or 将来用」要件に合わせ、ここでは非表示にする
      if (!isLoggedIn) {
        screensSection.style.display = "none";
      } else {
        screensSection.style.display = "block";
        await loadScreens(item.id, canEdit);
      }
    }

    // JSON
    try{
      // unit_json の返却形式はデプロイ側に依存するため、ここでは item.unit_json をあれば出す
      const uj = item.unit_json ? (typeof item.unit_json === "string" ? JSON.parse(item.unit_json) : item.unit_json) : null;
      el("json").textContent = uj ? JSON.stringify(uj, null, 2) : "(unit_json is not included in this response)";
    }catch(e){
      el("json").textContent = "(json parse error)";
    }
  }

  load();
})();
</script>

</body>
</html>
